<?xml version="1.0" encoding="UTF-8"?>
<!--
  WiX Fragment：安装路径记忆功能（完整版：读取+写入）

  功能说明：
  1. 读取功能：从注册表读取上次的安装路径，并设置为默认目录
  2. 写入功能：通过独立Component将当前安装路径保存到注册表

  支持场景：
  ✅ 首次安装：安装到默认或用户选择的路径，写入注册表
  ✅ 卸载重装：自动读取上次的安装路径，用户可修改
  ✅ 升级安装：自动使用上次的安装路径（支持用户修改过的路径）
  ✅ 全新环境：注册表为空时使用默认路径

  技术要点：
  - 使用Fragment方式，与jpackage生成的main.wxs完美兼容
  - 使用DirectoryRef引用INSTALLDIR，避免与jpackage的目录定义冲突
  - Component定义在DirectoryRef中，需要在main.wxs的Feature中引用
  - 每次安装（新装或升级）都会更新注册表中的路径
  - 升级安装时也会读取注册表，确保路径一致性

  使用方法：
  - build/win.bat 会复制此文件到 resource-dir/install-dir-patch.wxs
  - jpackage 自动编译、链接此Fragment
  - jpackage 会自动在 Feature 中包含所有独立的 Component
  - 或者在自定义 main.wxs 中手动引用：
    <Feature ...>
      <ComponentRef Id="RememberInstallDirComponent" />
    </Feature>

  注册表位置：HKCU\Software\Laker\EasyPostman\InstallDir
-->
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Fragment>

    <!-- ==================== 读取功能 ==================== -->

    <!-- 从注册表读取上次保存的安装目录 -->
    <Property Id="SAVEDINSTALLDIR" Secure="yes">
      <RegistrySearch Id="RememberInstallDir"
                      Root="HKCU"
                      Key="Software\Laker\EasyPostman"
                      Name="InstallDir"
                      Type="raw" />
    </Property>

    <!--
      设置 INSTALLDIR 为上次的安装路径
      - Before="CostFinalize": 在目录成本计算之前设置
      - Sequence="both": 在 UI 和 Execute 序列中都执行
      - 条件: SAVEDINSTALLDIR 存在

      说明：
      1. 新安装：如果注册表有历史路径，自动设置（用户仍可修改）
      2. 升级安装：使用注册表记录的路径（通常就是当前安装路径）
      3. 全新环境：注册表为空，使用默认路径

      注意：移除了 "NOT Installed" 条件，以支持升级时也记住路径
    -->
    <SetProperty Id="INSTALLDIR"
                 Value="[SAVEDINSTALLDIR]"
                 Before="CostFinalize"
                 Sequence="both">
      SAVEDINSTALLDIR
    </SetProperty>

    <!-- ==================== 写入功能 ==================== -->

    <!--
      DirectoryRef + Component: 保存安装路径到注册表

      使用 DirectoryRef 引用 INSTALLDIR，这样：
      1. 与 jpackage 生成的目录结构兼容
      2. 符合 WiX Fragment 标准结构
      3. Component 会被自动添加到安装包中

      技术要点：
      - DirectoryRef Id="INSTALLDIR": 引用主安装目录
      - Component Id="RememberInstallDirComponent": 唯一组件标识
      - Guid="*": 自动生成稳定的 GUID（基于命名空间和组件路径）
      - KeyPath="yes": 注册表项作为组件的关键路径
      - 每次安装/升级都会更新此注册表值
    -->
    <DirectoryRef Id="INSTALLDIR">
      <Component Id="RememberInstallDirComponent" Guid="*">
        <RegistryValue Root="HKCU"
                       Key="Software\Laker\EasyPostman"
                       Name="InstallDir"
                       Value="[INSTALLDIR]"
                       Type="string"
                       KeyPath="yes" />
      </Component>
    </DirectoryRef>

  </Fragment>
</Wix>

