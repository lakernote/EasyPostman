# å·¥ä½œæµåç§°ï¼šPull Request æ£€æŸ¥
#
# ä½œç”¨ï¼šåœ¨ PR åˆå¹¶å‰è¿›è¡Œè‡ªåŠ¨åŒ–è´¨é‡æ£€æŸ¥ï¼Œç¡®ä¿ä»£ç è´¨é‡
# åŒ…æ‹¬ï¼šæ„å»ºæµ‹è¯•ã€ä»£ç è´¨é‡æ£€æŸ¥ã€PR è§„èŒƒéªŒè¯ã€è·¨å¹³å°æ‰“åŒ…å’ŒåŠŸèƒ½æµ‹è¯•
name: PR Check

# è§¦å‘æ¡ä»¶ï¼šå½“åˆ›å»ºæˆ–æ›´æ–° Pull Request æ—¶
on:
  pull_request:
    # ç›®æ ‡åˆ†æ”¯ï¼šmainã€masterã€develop
    branches:
      - main
      - master
      - develop
    # è§¦å‘ç±»å‹ï¼š
    # - opened: PR é¦–æ¬¡åˆ›å»ºæ—¶
    # - synchronize: PR æœ‰æ–°æäº¤æ¨é€æ—¶
    # - reopened: å…³é—­çš„ PR é‡æ–°æ‰“å¼€æ—¶
    types: [opened, synchronize, reopened]

# ç¯å¢ƒå˜é‡ï¼šå®šä¹‰è·¨å¹³å°æ‰“åŒ…æ‰€éœ€çš„é…ç½®
env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'
  JLINK_MODULES: 'java.base,java.desktop,java.logging,jdk.unsupported,java.naming,java.net.http,java.prefs,java.sql,java.security.sasl,java.security.jgss,jdk.crypto.ec,java.management,java.management.rmi,jdk.crypto.cryptoki'
  JAVA_OPTIONS: '-Xms256m|-Xmx512m|-Dfile.encoding=UTF-8'

jobs:
  # Job 0: è·å–ç‰ˆæœ¬å·ï¼ˆä¾›æ‰€æœ‰ Job ä½¿ç”¨ï¼‰
  get-version:
    name: Get Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract_version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'

      - name: Extract version
        id: extract_version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "Version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  # Job 1: æ„å»ºå’Œæµ‹è¯•ï¼ˆç”Ÿæˆè·¨å¹³å° JARï¼‰
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: [get-version]

    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # ç¬¬äºŒæ­¥ï¼šè®¾ç½® Java 17 ç¯å¢ƒï¼ˆå·²åŒ…å« Maven ç¼“å­˜åŠŸèƒ½ï¼‰
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'

      # ç¬¬ä¸‰æ­¥ï¼šä½¿ç”¨ Maven æ„å»ºé¡¹ç›®ï¼ˆè·³è¿‡æµ‹è¯•ä»¥åŠ å¿«æ„å»ºé€Ÿåº¦ï¼‰
      - name: Build with Maven
        run: mvn clean package -DskipTests -B

      # ç¬¬å››æ­¥ï¼šè¿è¡Œå•å…ƒæµ‹è¯•
      - name: Run tests
        run: mvn test
        continue-on-error: true  # å³ä½¿æµ‹è¯•å¤±è´¥ä¹Ÿç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤

      # ç¬¬äº”æ­¥ï¼šJAR å¯åŠ¨æµ‹è¯•ï¼ˆéªŒè¯ IOC å®¹å™¨æ‰«æç­‰æ ¸å¿ƒåŠŸèƒ½ï¼‰
      - name: Test JAR startup
        timeout-minutes: 2
        run: |
          echo "ğŸ§ª Testing JAR startup and IOC container..."
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          JAR_FILE="target/easy-postman-${VERSION}.jar"
          
          if [ ! -f "$JAR_FILE" ]; then
            echo "âŒ JAR file not found: $JAR_FILE"
            exit 1
          fi
          
          echo "âœ… JAR file exists: $JAR_FILE ($(du -h $JAR_FILE | cut -f1))"
          
          # å¯åŠ¨åº”ç”¨ï¼ˆåå°è¿è¡Œï¼Œheadless æ¨¡å¼ï¼‰
          java -jar "$JAR_FILE" > jar-test-stdout.log 2> jar-test-stderr.log &
          JAR_PID=$!
          
          echo "âœ… JAR started (PID: $JAR_PID)"
          
          # ç­‰å¾…åº”ç”¨å¯åŠ¨å’Œ IOC å®¹å™¨åˆå§‹åŒ–
          sleep 10
          
          # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¿˜åœ¨è¿è¡Œ
          if ps -p $JAR_PID > /dev/null 2>&1; then
            echo "âœ… JAR is running successfully"
            
            # æ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦æœ‰ IOC å®¹å™¨åˆå§‹åŒ–æˆåŠŸçš„æ ‡å¿—
            if grep -q "IOC container initialized successfully" jar-test-stdout.log jar-test-stderr.log 2>/dev/null; then
              echo "âœ… IOC container initialized successfully"
            else
              echo "âŒ IOC container initialization not detected in logs"
              echo "=== Checking for errors in logs ==="
              cat jar-test-stderr.log || true
              kill -9 $JAR_PID 2>/dev/null || true
              exit 1
            fi
            
            # æ£€æŸ¥æ˜¯å¦æœ‰ Bean æ³¨å†Œå¤±è´¥çš„é”™è¯¯
            if grep -i "NoSuchBeanException" jar-test-stdout.log jar-test-stderr.log 2>/dev/null; then
              echo "âŒ Bean registration failed - NoSuchBeanException detected"
              cat jar-test-stderr.log || true
              kill -9 $JAR_PID 2>/dev/null || true
              exit 1
            fi
            
            # æ£€æŸ¥æ³¨å†Œçš„ Bean æ•°é‡
            BEAN_COUNT=$(grep -oP "Total registered beans: \[\K\d+" jar-test-stdout.log jar-test-stderr.log 2>/dev/null | head -1 || echo "0")
            echo "ğŸ“Š Total registered beans: $BEAN_COUNT"
            
            if [ "$BEAN_COUNT" -eq "0" ]; then
              echo "âŒ No beans registered - IOC container scanning failed!"
              echo "=== Full log output ==="
              cat jar-test-stderr.log || true
              kill -9 $JAR_PID 2>/dev/null || true
              exit 1
            fi
            
            echo "âœ… Bean scanning working correctly"
            
            # åœæ­¢åº”ç”¨
            kill -TERM $JAR_PID 2>/dev/null || true
            sleep 2
            if ps -p $JAR_PID > /dev/null 2>&1; then
              kill -9 $JAR_PID 2>/dev/null || true
            fi
            
            echo "âœ… JAR startup test passed"
          else
            echo "âŒ JAR crashed or exited immediately"
            echo "=== Error Log ==="
            cat jar-test-stderr.log || true
            echo "=== Output Log ==="
            cat jar-test-stdout.log || true
            exit 1
          fi

      # ç¬¬å…­æ­¥ï¼šä¸Šä¼  JAR æµ‹è¯•æ—¥å¿—
      - name: Upload JAR test logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: jar-test-logs
          path: |
            jar-test-*.log
          retention-days: 3

      # ç¬¬ä¸ƒæ­¥ï¼šä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()  # æ— è®ºæµ‹è¯•æˆåŠŸæˆ–å¤±è´¥éƒ½ä¸Šä¼ 
        with:
          name: test-results
          path: target/surefire-reports/
          retention-days: 3  # æµ‹è¯•æŠ¥å‘Šä¿ç•™ 3 å¤©å³å¯ï¼ˆä»…ç”¨äºå¿«é€Ÿè°ƒè¯•ï¼‰

      # ç¬¬å…«æ­¥ï¼šä¸Šä¼  JAR ä¾›åç»­æ‰“åŒ…ä»»åŠ¡ä½¿ç”¨
      - name: Upload JAR for packaging
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: app-jar
          path: target/easy-postman-${{ needs.get-version.outputs.version }}.jar
          retention-days: 1  # ä»…ä¾›å½“å‰å·¥ä½œæµä½¿ç”¨

  # Job 2: Windows æ‰“åŒ…å’ŒéªŒè¯
  test-windows-package:
    name: Test Windows Package
    runs-on: windows-latest
    needs: [get-version, build]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Download JAR
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: target

      - name: Install WiX Toolset
        shell: pwsh
        run: |
          Write-Host "ğŸ“¦ Installing WiX Toolset..."
          choco install wixtoolset -y
          if (Get-Command refreshenv -ErrorAction SilentlyContinue) { 
            refreshenv 
          } else {
            $refreshScript = "$env:ChocolateyInstall\lib\refreshenv\tools\RefreshEnv.ps1"
            if (Test-Path $refreshScript) { & $refreshScript }
          }
          Write-Host "âœ… WiX installed"

      - name: Create runtime with jlink
        shell: pwsh
        run: |
          Write-Host "ğŸ”§ Creating Windows runtime..."
          $runtimeDir = "target\runtime"
          if (Test-Path $runtimeDir) { Remove-Item -Recurse -Force $runtimeDir }
          
          jlink `
            --add-modules $env:JLINK_MODULES `
            --strip-debug `
            --no-header-files `
            --no-man-pages `
            --compress=2 `
            --output $runtimeDir
          Write-Host "âœ… Runtime created"

      - name: Prepare dist-input
        shell: pwsh
        run: |
          $version = "${{ needs.get-version.outputs.version }}"
          $jarName = "easy-postman-$version.jar"
          
          $distInputDir = "target\dist-input"
          if (Test-Path $distInputDir) { Remove-Item -Recurse -Force $distInputDir }
          New-Item -ItemType Directory -Path $distInputDir | Out-Null
          
          Copy-Item "target\$jarName" -Destination $distInputDir
          Write-Host "âœ… Prepared dist-input"

      - name: Copy WiX configuration for install path memory testï¼ˆå¤åˆ¶ WiX é…ç½®æµ‹è¯•å®‰è£…è·¯å¾„è®°å¿†åŠŸèƒ½ï¼‰
        shell: pwsh
        run: |
          Write-Host "ğŸ”§ Copying WiX configuration to test installation path memory feature..."
          $resourceDir = "target\jpackage-resources"
          if (-not (Test-Path $resourceDir)) { New-Item -ItemType Directory -Path $resourceDir | Out-Null }
          
          # å¤åˆ¶ overrides.wxiï¼ˆjpackage ä¼šè‡ªåŠ¨ include è¿™ä¸ªæ–‡ä»¶ï¼‰
          # è¿™ä¸ªæ–‡ä»¶åŒ…å«ï¼š
          # 1. Property + RegistrySearchï¼ˆè¯»å–ä¸Šæ¬¡å®‰è£…è·¯å¾„ï¼‰
          # 2. SetPropertyï¼ˆè®¾ç½® INSTALLDIR åˆå§‹å€¼ï¼‰
          # 3. DirectoryRef + Componentï¼ˆä¿å­˜å½“å‰å®‰è£…è·¯å¾„ï¼‰
          $wixConfig = "build\overrides.wxi"
          if (-not (Test-Path $wixConfig)) {
            Write-Host "âŒ WiX configuration file not found: $wixConfig"
            exit 1
          }
          
          Copy-Item $wixConfig -Destination "$resourceDir\overrides.wxi"
          Write-Host "âœ… Copied overrides.wxi (install path memory enabled)"
          
          # éªŒè¯æ–‡ä»¶
          if (Test-Path "$resourceDir\overrides.wxi") {
            $fileSize = (Get-Item "$resourceDir\overrides.wxi").Length
            Write-Host "âœ… overrides.wxi file size: $fileSize bytes"
            Write-Host "ğŸ“„ Content preview:"
            Get-Content "$resourceDir\overrides.wxi" -Head 20
          } else {
            Write-Host "âŒ Failed to copy overrides.wxi"
            exit 1
          }

      - name: Validate overrides.wxi formatï¼ˆéªŒè¯ overrides.wxi æ ¼å¼ï¼‰
        shell: pwsh
        run: |
          Write-Host "ğŸ” Validating overrides.wxi format for WiX compatibility..."
          Write-Host ""
          
          $wixFile = "target\jpackage-resources\overrides.wxi"
          if (-not (Test-Path $wixFile)) {
            Write-Host "âŒ overrides.wxi not found in resource directory"
            exit 1
          }
          
          Write-Host "ğŸ“„ Complete file content:"
          Write-Host "=" * 80
          Get-Content $wixFile | ForEach-Object { Write-Host $_ }
          Write-Host "=" * 80
          Write-Host ""
          
          # è¯»å–æ–‡ä»¶å†…å®¹è¿›è¡Œæ£€æŸ¥
          $content = Get-Content $wixFile -Raw
          
          # æ£€æŸ¥ 1: ä¸åº”è¯¥æœ‰ <?xml å£°æ˜
          Write-Host "ğŸ” Check 1: XML Declaration"
          if ($content -match '<\?xml\s+version') {
            Write-Host "âŒ FAIL: Found <?xml declaration"
            Write-Host "   Issue: WiX include files should NOT have XML declaration"
            Write-Host "   Reason: jpackage uses <?include ?> which expects raw content"
            $hasIssues = $true
          } else {
            Write-Host "âœ… PASS: No XML declaration (correct)"
          }
          
          # æ£€æŸ¥ 2: ä¸åº”è¯¥æœ‰ <Include> æ ¹å…ƒç´ 
          Write-Host ""
          Write-Host "ğŸ” Check 2: Include Root Element"
          if ($content -match '<Include\s*>') {
            Write-Host "âŒ FAIL: Found <Include> root element"
            Write-Host "   Issue: overrides.wxi should NOT have <Include> wrapper"
            Write-Host "   Reason: <?include ?> directive inserts content directly"
            $hasIssues = $true
          } else {
            Write-Host "âœ… PASS: No <Include> root element (correct)"
          }
          
          # æ£€æŸ¥ 3: ä¸åº”è¯¥æœ‰ <Fragment> æ ¹å…ƒç´ 
          Write-Host ""
          Write-Host "ğŸ” Check 3: Fragment Root Element"
          if ($content -match '^\s*<Fragment\s*>') {
            Write-Host "âŒ FAIL: Found <Fragment> as root element"
            Write-Host "   Issue: overrides.wxi should NOT have <Fragment> wrapper"
            Write-Host "   Reason: jpackage expects direct WiX elements"
            $hasIssues = $true
          } else {
            Write-Host "âœ… PASS: No <Fragment> root element (correct)"
          }
          
          # æ£€æŸ¥ 4: ä¸åº”è¯¥æœ‰ xmlns å£°æ˜
          Write-Host ""
          Write-Host "ğŸ” Check 4: Namespace Declaration"
          if ($content -match 'xmlns\s*=') {
            Write-Host "âŒ FAIL: Found xmlns namespace declaration"
            Write-Host "   Issue: Include files should not declare namespaces"
            $hasIssues = $true
          } else {
            Write-Host "âœ… PASS: No xmlns declaration (correct)"
          }
          
          # æ£€æŸ¥ 5: åº”è¯¥æœ‰å¿…éœ€çš„ WiX å…ƒç´ 
          Write-Host ""
          Write-Host "ğŸ” Check 5: Required WiX Elements"
          $requiredElements = @{
            'Property.*PREVIOUSINSTALLDIR' = 'Property for reading previous install path'
            'RegistrySearch' = 'RegistrySearch for previous path'
            'SetProperty.*INSTALLDIR' = 'SetProperty for INSTALLDIR'
            'DirectoryRef.*INSTALLDIR' = 'DirectoryRef for INSTALLDIR'
            'RememberInstallDirComponent' = 'Component for saving install path'
            'RegistryValue' = 'RegistryValue for saving path'
            'InstallPathMemoryGroup' = 'ComponentGroup for install path memory'
          }
          
          $allElementsFound = $true
          foreach ($element in $requiredElements.GetEnumerator()) {
            if ($content -match $element.Key) {
              Write-Host "  âœ… $($element.Value): Found"
            } else {
              Write-Host "  âŒ $($element.Value): NOT Found"
              $allElementsFound = $false
              $hasIssues = $true
            }
          }
          
          # æ€»ç»“
          Write-Host ""
          Write-Host "=" * 80
          if ($hasIssues) {
            Write-Host "âŒ VALIDATION FAILED: overrides.wxi has format issues"
            Write-Host ""
            Write-Host "ğŸ“ Correct format should be:"
            Write-Host "   - No <?xml declaration"
            Write-Host "   - No <Include> wrapper"
            Write-Host "   - No <Fragment> wrapper"
            Write-Host "   - Direct WiX elements: <Property>, <SetProperty>, <DirectoryRef>, <ComponentGroup>"
            Write-Host ""
            exit 1
          } else {
            Write-Host "âœ… VALIDATION PASSED: overrides.wxi format is correct"
            Write-Host "   Ready for jpackage <?include ?> directive"
          }

      - name: Check jpackage temp directory before packagingï¼ˆæ‰“åŒ…å‰æ£€æŸ¥ä¸´æ—¶ç›®å½•ï¼‰
        shell: pwsh
        run: |
          Write-Host "ğŸ” Checking for existing jpackage temp directories..."
          $tempDirs = Get-ChildItem -Path $env:TEMP -Filter "jdk.jpackage*" -Directory -ErrorAction SilentlyContinue
          if ($tempDirs) {
            Write-Host "âš ï¸  Found existing jpackage temp directories, cleaning up..."
            foreach ($dir in $tempDirs) {
              Write-Host "  Removing: $($dir.FullName)"
              Remove-Item -Recurse -Force $dir.FullName -ErrorAction SilentlyContinue
            }
          } else {
            Write-Host "âœ… No existing jpackage temp directories found"
          }

      - name: Create Windows MSI installer for path memory testingï¼ˆåˆ›å»º MSI å®‰è£…åŒ…æµ‹è¯•è·¯å¾„è®°å¿†ï¼‰
        shell: pwsh
        run: |
          Write-Host "ğŸ“¦ Creating Windows MSI installer with install path memory feature..."
          $version = "${{ needs.get-version.outputs.version }}"
          $jarName = "easy-postman-$version.jar"
          $outDir = "target\msi-test"
          
          if (-not (Test-Path $outDir)) { New-Item -ItemType Directory -Path $outDir | Out-Null }
          
          $javaOpts = $env:JAVA_OPTIONS -split '\|'
          
          # åˆ›å»º Windows MSI å®‰è£…åŒ…ï¼ˆç”¨äºæµ‹è¯•å®‰è£…è·¯å¾„è®°å¿†åŠŸèƒ½ï¼‰
          # Note: jpackage output is captured for better error reporting
          try {
            jpackage `
              --type msi `
              --input target\dist-input `
              --main-jar $jarName `
              --main-class com.laker.postman.App `
              --runtime-image target\runtime `
              --dest $outDir `
              --icon assets\win\EasyPostman.ico `
              --name EasyPostman `
              --app-version $version `
              --vendor "Laker" `
              --copyright "Â© 2025 Laker" `
              --win-shortcut `
              --win-menu `
              --description "A modern API testing tool similar to Postman" `
              --win-upgrade-uuid "28607609-97b7-4212-9285-04ef64a4946c" `
              --win-dir-chooser `
              --win-per-user-install `
              --win-menu-group "EasyTools" `
              --win-help-url "https://gitee.com/lakernote/easy-postman" `
              --resource-dir "target\jpackage-resources" `
              --java-options $javaOpts[0] `
              --java-options $javaOpts[1] `
              --java-options $javaOpts[2] `
              --java-options "-Djavax.accessibility.assistive_technologies=" `
              --temp "target\jpackage-temp" `
              --verbose
            
            if ($LASTEXITCODE -ne 0) {
              Write-Host "âŒ jpackage failed with exit code: $LASTEXITCODE"
              Write-Host "ğŸ’¡ Checking for WiX compilation logs..."
              
              # Look for WiX log files in temp directories
              $tempDirs = @(
                "$env:TEMP\jdk.jpackage*",
                "C:\Users\*\AppData\Local\Temp\jdk.jpackage*"
              )
              
              foreach ($pattern in $tempDirs) {
                $dirs = Get-ChildItem -Path $pattern -Directory -ErrorAction SilentlyContinue
                foreach ($dir in $dirs) {
                  Write-Host "ğŸ“‚ Checking $dir"
                  $logFiles = Get-ChildItem -Path $dir -Recurse -Include "*.log" -ErrorAction SilentlyContinue
                  foreach ($log in $logFiles) {
                    Write-Host "ğŸ“„ Log file: $($log.FullName)"
                    Get-Content $log -ErrorAction SilentlyContinue | Select-Object -Last 50
                  }
                }
              }
              
              exit 1
            }
            
            Write-Host "âœ… MSI installer created successfully"
          } catch {
            Write-Host "âŒ Exception during jpackage execution:"
            Write-Host $_.Exception.Message
            Write-Host $_.ScriptStackTrace
            exit 1
          }

      - name: Check WiX files in jpackage temp directoryï¼ˆæ£€æŸ¥jpackageä¸´æ—¶ç›®å½•ä¸­çš„WiXæ–‡ä»¶ï¼‰
        shell: pwsh
        run: |
          Write-Host "ğŸ” Checking WiX files in jpackage temp directory..."
          $tempDir = "target\jpackage-temp"
          
          if (-not (Test-Path $tempDir)) {
            Write-Host "âŒ Temp directory not found: $tempDir"
            exit 1
          }
          
          Write-Host "ğŸ“‚ Temp directory exists: $tempDir"
          
          # Find all .wxs files
          Write-Host "`nğŸ” Looking for .wxs files..."
          $wxsFiles = Get-ChildItem -Path $tempDir -Recurse -Filter "*.wxs" -ErrorAction SilentlyContinue
          
          if ($wxsFiles) {
            Write-Host "âœ… Found $($wxsFiles.Count) .wxs file(s):"
            foreach ($file in $wxsFiles) {
              $fileSize = $file.Length
              Write-Host "  ğŸ“„ $($file.FullName) ($fileSize bytes)"
            }
            
            # Check specifically for main.wxs and overrides.wxi
            $mainWxs = $wxsFiles | Where-Object { $_.Name -eq "main.wxs" }
            $overridesWxi = Get-ChildItem -Path $tempDir -Recurse -Filter "overrides.wxi" -ErrorAction SilentlyContinue
            
            if ($mainWxs) {
              Write-Host "`nğŸ“„ Found main.wxs:"
              Write-Host "   Path: $($mainWxs.FullName)"
              Write-Host "   Size: $($mainWxs.Length) bytes"
              
              # è¯»å–å®Œæ•´å†…å®¹
              $mainContent = Get-Content $mainWxs.FullName -Raw
              
              Write-Host "`nğŸ“„ Main.wxs structure overview:"
              Write-Host "   Total lines: $((Get-Content $mainWxs.FullName | Measure-Object -Line).Lines)"
              
              # æ£€æŸ¥ 1: <?include overrides.wxi ?> æŒ‡ä»¤
              Write-Host "`nğŸ” Check 1: Include Directive"
              if ($mainContent -match '\<\?include.*overrides\.wxi.*\?\>') {
                Write-Host "  âœ… PASS: Found <?include overrides.wxi ?> directive"
                $includeMatches = [regex]::Matches($mainContent, '\<\?include.*overrides\.wxi.*\?\>')
                foreach ($match in $includeMatches) {
                  # æ‰¾åˆ°åŒ¹é…è¡Œå·
                  $lines = Get-Content $mainWxs.FullName
                  for ($i = 0; $i -lt $lines.Count; $i++) {
                    if ($lines[$i] -match [regex]::Escape($match.Value)) {
                      Write-Host "     Line $($i + 1): $($lines[$i].Trim())"
                      break
                    }
                  }
                }
              } else {
                Write-Host "  âŒ FAIL: <?include overrides.wxi ?> directive NOT found"
                Write-Host "     Issue: jpackage did not include our overrides.wxi file"
              }
              
              # æ£€æŸ¥ 2: PREVIOUSINSTALLDIR Property
              Write-Host "`nğŸ” Check 2: PREVIOUSINSTALLDIR Property"
              if ($mainContent -match 'PREVIOUSINSTALLDIR') {
                Write-Host "  âœ… PASS: PREVIOUSINSTALLDIR found in main.wxs"
                $propMatches = Select-String -Path $mainWxs.FullName -Pattern "PREVIOUSINSTALLDIR" -AllMatches
                foreach ($match in $propMatches | Select-Object -First 3) {
                  Write-Host "     Line $($match.LineNumber): $($match.Line.Trim())"
                }
              } else {
                Write-Host "  âŒ FAIL: PREVIOUSINSTALLDIR NOT found"
                Write-Host "     Issue: overrides.wxi content was not included"
              }
              
              # æ£€æŸ¥ 3: RegistrySearch
              Write-Host "`nğŸ” Check 3: RegistrySearch Element"
              if ($mainContent -match 'RegistrySearch.*FindPreviousInstallDir') {
                Write-Host "  âœ… PASS: RegistrySearch for FindPreviousInstallDir found"
              } elseif ($mainContent -match 'RegistrySearch') {
                Write-Host "  âš ï¸  WARNING: RegistrySearch found but not for FindPreviousInstallDir"
              } else {
                Write-Host "  âŒ FAIL: RegistrySearch NOT found"
              }
              
              # æ£€æŸ¥ 4: SetProperty for INSTALLDIR
              Write-Host "`nğŸ” Check 4: SetProperty for INSTALLDIR"
              if ($mainContent -match 'SetProperty.*INSTALLDIR') {
                Write-Host "  âœ… PASS: SetProperty for INSTALLDIR found"
                $setPropMatches = Select-String -Path $mainWxs.FullName -Pattern "SetProperty.*INSTALLDIR" -AllMatches
                foreach ($match in $setPropMatches | Select-Object -First 2) {
                  Write-Host "     Line $($match.LineNumber): $($match.Line.Trim())"
                }
              } else {
                Write-Host "  âŒ FAIL: SetProperty for INSTALLDIR NOT found"
              }
              
              # æ£€æŸ¥ 5: RememberInstallDirComponent
              Write-Host "`nğŸ” Check 5: RememberInstallDirComponent"
              if ($mainContent -match 'RememberInstallDirComponent') {
                Write-Host "  âœ… PASS: RememberInstallDirComponent found"
                $compMatches = Select-String -Path $mainWxs.FullName -Pattern "RememberInstallDirComponent" -AllMatches
                foreach ($match in $compMatches) {
                  Write-Host "     Line $($match.LineNumber): $($match.Line.Trim())"
                }
              } else {
                Write-Host "  âŒ FAIL: RememberInstallDirComponent NOT found"
              }
              
              # æ£€æŸ¥ 6: RegistryValue for saving path
              Write-Host "`nğŸ” Check 6: RegistryValue for Saving Path"
              if ($mainContent -match 'RegistryValue.*InstallDir') {
                Write-Host "  âœ… PASS: RegistryValue for InstallDir found"
              } else {
                Write-Host "  âŒ FAIL: RegistryValue for InstallDir NOT found"
              }
              
              # æ£€æŸ¥ 7: InstallPathMemoryGroup
              Write-Host "`nğŸ” Check 7: ComponentGroup InstallPathMemoryGroup"
              if ($mainContent -match 'InstallPathMemoryGroup') {
                Write-Host "  âœ… PASS: InstallPathMemoryGroup ComponentGroup found"
              } else {
                Write-Host "  âŒ FAIL: InstallPathMemoryGroup NOT found"
              }
              
              # æ£€æŸ¥ 8: ComponentRef å¼•ç”¨
              Write-Host "`nğŸ” Check 8: ComponentRef References"
              $componentRefs = Select-String -Path $mainWxs.FullName -Pattern "ComponentRef.*Id\s*=\s*[`"']RememberInstallDirComponent[`"']" -AllMatches
              if ($componentRefs) {
                Write-Host "  âœ… PASS: Found ComponentRef to RememberInstallDirComponent"
                foreach ($match in $componentRefs) {
                  Write-Host "     Line $($match.LineNumber): $($match.Line.Trim())"
                }
              } else {
                Write-Host "  âš ï¸  WARNING: ComponentRef to RememberInstallDirComponent NOT found"
                Write-Host "     The component may not be included in Feature"
              }
              
              # æ˜¾ç¤º main.wxs çš„å…³é”®éƒ¨åˆ†
              Write-Host "`nğŸ“„ Main.wxs content preview (first 100 lines):"
              Write-Host "=" * 80
              Get-Content $mainWxs.FullName -Head 100 | ForEach-Object { Write-Host $_ }
              Write-Host "=" * 80
              
              # æ€»ç»“æ£€æŸ¥ç»“æœ
              Write-Host "`n" + "=" * 80
              $checksPass = (
                ($mainContent -match '\<\?include.*overrides\.wxi.*\?\>') -and
                ($mainContent -match 'PREVIOUSINSTALLDIR') -and
                ($mainContent -match 'RegistrySearch') -and
                ($mainContent -match 'SetProperty.*INSTALLDIR') -and
                ($mainContent -match 'RememberInstallDirComponent')
              )
              
              if ($checksPass) {
                Write-Host "âœ… VALIDATION PASSED: overrides.wxi content is properly included in main.wxs"
                Write-Host "âœ… Install path memory feature is integrated successfully"
              } else {
                Write-Host "âŒ VALIDATION FAILED: Some required elements are missing"
                Write-Host "âŒ Install path memory feature may not work correctly"
                Write-Host ""
                Write-Host "This could mean:"
                Write-Host "  1. overrides.wxi format is incorrect"
                Write-Host "  2. jpackage did not include overrides.wxi"
                Write-Host "  3. WiX compilation failed before including our content"
              }
              Write-Host "=" * 80
            } else {
              Write-Host "âš ï¸  main.wxs not found"
            }
            
            if ($overridesWxi) {
              Write-Host "`nğŸ“„ Found overrides.wxi:"
              Write-Host "   Path: $($overridesWxi.FullName)"
              Write-Host "   Size: $($overridesWxi.Length) bytes"
              Write-Host "`nğŸ“„ Content preview (first 30 lines):"
              Get-Content $overridesWxi.FullName -Head 30
            } else {
              Write-Host "âŒ overrides.wxi not found in temp directory!"
              Write-Host "This means the WiX include file was not copied by jpackage."
              exit 1
            }
            
            # Check for compiled .wixobj files
            Write-Host "`nğŸ” Looking for compiled .wixobj files..."
            $wixobjFiles = Get-ChildItem -Path $tempDir -Recurse -Filter "*.wixobj" -ErrorAction SilentlyContinue
            if ($wixobjFiles) {
              Write-Host "âœ… Found $($wixobjFiles.Count) .wixobj file(s):"
              foreach ($file in $wixobjFiles) {
                Write-Host "  ğŸ“¦ $($file.Name)"
              }
            } else {
              Write-Host "âš ï¸  No .wixobj files found"
            }
            
          } else {
            Write-Host "âŒ No .wxs files found in temp directory!"
            Write-Host "Listing all files in temp directory:"
            Get-ChildItem -Path $tempDir -Recurse | ForEach-Object { Write-Host "  $($_.FullName)" }
            exit 1
          }
          
          Write-Host "`nâœ… WiX files check completed"


      - name: Verify MSI installer and WiX integrationï¼ˆéªŒè¯ MSI å®‰è£…åŒ…å’Œ WiX é›†æˆï¼‰
        shell: pwsh
        run: |
          Write-Host "ğŸ” Verifying MSI installer..."
          $version = "${{ needs.get-version.outputs.version }}"
          $msiFile = "target\msi-test\EasyPostman-$version.msi"
          
          if (-not (Test-Path $msiFile)) {
            Write-Host "âŒ MSI file not found: $msiFile"
            exit 1
          }
          
          $fileSize = (Get-Item $msiFile).Length / 1MB
          Write-Host "âœ… MSI installer exists: $msiFile ($([math]::Round($fileSize, 2)) MB)"
          
          # ä½¿ç”¨ WiX å·¥å…·éªŒè¯ MSI ç»“æ„ï¼ˆå¦‚æœå¯ç”¨ï¼‰
          try {
            $wixPath = Get-Command candle.exe -ErrorAction SilentlyContinue
            if ($wixPath) {
              Write-Host "âœ… WiX Toolset is available for MSI validation"
              
              # å°è¯•æå– MSI å†…å®¹æŸ¥çœ‹æ˜¯å¦åŒ…å«æ³¨å†Œè¡¨ç»„ä»¶
              Write-Host "ğŸ” Checking MSI for registry components..."
              # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´è¯¦ç»†çš„ MSI å†…éƒ¨ç»“æ„æ£€æŸ¥
            } else {
              Write-Host "â„¹ï¸  WiX command-line tools not in PATH, skipping detailed MSI validation"
            }
          } catch {
            Write-Host "â„¹ï¸  WiX validation skipped: $_"
          }
          
          Write-Host "âœ… MSI installer verification passed"


      - name: Upload MSI installer
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: windows-msi-installer
          path: target/msi-test/*.msi
          retention-days: 3

      - name: Create Windows portable version
        shell: pwsh
        run: |
          Write-Host "ğŸ“¦ Creating Windows portable version..."
          $version = "${{ needs.get-version.outputs.version }}"
          $jarName = "easy-postman-$version.jar"
          
          $javaOpts = $env:JAVA_OPTIONS -split '\|'
          
          # åˆ›å»º app-imageï¼ˆä¾¿æºç‰ˆï¼Œä¸éœ€è¦å®‰è£…ï¼‰
          jpackage `
            --type app-image `
            --input target\dist-input `
            --main-jar $jarName `
            --main-class com.laker.postman.App `
            --runtime-image target\runtime `
            --dest target `
            --icon assets\win\EasyPostman.ico `
            --name EasyPostman `
            --app-version $version `
            --vendor "Laker" `
            --copyright "Â© 2025 Laker" `
            --java-options $javaOpts[0] `
            --java-options $javaOpts[1] `
            --java-options $javaOpts[2] `
            --java-options "-Djavax.accessibility.assistive_technologies="
          
          # åˆ›å»º .portable æ ‡è¯†æ–‡ä»¶
          $appDir = "target\EasyPostman"
          "This is a portable version" | Out-File -FilePath "$appDir\.portable" -Encoding UTF8
          Write-Host "âœ… Portable version created"

      - name: Verify Windows package
        shell: pwsh
        run: |
          Write-Host "ğŸ” Verifying Windows package..."
          $appDir = "target\EasyPostman"
          $exeFile = "$appDir\EasyPostman.exe"
          
          if (-not (Test-Path $exeFile)) {
            Write-Host "âŒ Executable not found: $exeFile"
            exit 1
          }
          
          $fileSize = (Get-Item $exeFile).Length / 1KB
          Write-Host "âœ… Executable exists: $exeFile ($([math]::Round($fileSize, 2)) KB)"
          
          # æ£€æŸ¥è¿è¡Œæ—¶ç›®å½•
          $runtimeDir = "$appDir\runtime"
          if (Test-Path $runtimeDir) {
            Write-Host "âœ… Runtime directory exists"
            $javaExe = "$runtimeDir\bin\java.exe"
            if (Test-Path $javaExe) {
              Write-Host "âœ… Java runtime found"
            }
          }

      - name: Run Windows smoke test
        shell: pwsh
        timeout-minutes: 2
        run: |
          Write-Host "ğŸ§ª Running Windows smoke test..."
          $exeFile = "target\EasyPostman\EasyPostman.exe"
          
          # å¯åŠ¨åº”ç”¨ï¼ˆåå°è¿è¡Œï¼Œä½¿ç”¨ headless æ¨¡å¼ï¼‰
          $env:JAVA_TOOL_OPTIONS = "-Djava.awt.headless=false"
          $process = Start-Process -FilePath $exeFile -PassThru -WindowStyle Hidden -RedirectStandardError "stderr.log" -RedirectStandardOutput "stdout.log"
          
          if ($process) {
            Write-Host "âœ… Application started (PID: $($process.Id))"
            
            # ç­‰å¾…åº”ç”¨å¯åŠ¨
            Start-Sleep -Seconds 8
            
            # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¿˜åœ¨è¿è¡Œ
            $runningProcess = Get-Process -Id $process.Id -ErrorAction SilentlyContinue
            if ($runningProcess) {
              Write-Host "âœ… Application is running successfully"
              Write-Host "   Process: $($runningProcess.ProcessName)"
              Write-Host "   Memory: $([math]::Round($runningProcess.WorkingSet64 / 1MB, 2)) MB"
              
              # åœæ­¢åº”ç”¨
              Stop-Process -Id $process.Id -Force
              Start-Sleep -Seconds 2
              Write-Host "âœ… Application stopped"
            } else {
              Write-Host "âŒ Application crashed or exited immediately"
              if (Test-Path "stderr.log") {
                Write-Host "=== Error Log ==="
                Get-Content "stderr.log"
              }
              exit 1
            }
          } else {
            Write-Host "âŒ Failed to start application"
            exit 1
          }

      - name: Upload test logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: windows-test-logs
          path: |
            *.log
            target/EasyPostman/
          retention-days: 3

  # Job 3: macOS æ‰“åŒ…å’ŒéªŒè¯
  test-macos-package:
    name: Test macOS Package
    runs-on: macos-latest
    needs: [get-version, build]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Download JAR
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: target

      - name: Create runtime with jlink
        run: |
          echo "ğŸ”§ Creating macOS runtime..."
          rm -rf target/runtime
          
          jlink \
            --add-modules ${{ env.JLINK_MODULES }} \
            --strip-debug \
            --no-header-files \
            --no-man-pages \
            --compress=2 \
            --output target/runtime
          echo "âœ… Runtime created"

      - name: Prepare dist-input
        run: |
          VERSION="${{ needs.get-version.outputs.version }}"
          JAR_NAME="easy-postman-${VERSION}.jar"
          
          rm -rf target/dist-input
          mkdir -p target/dist-input
          
          cp "target/${JAR_NAME}" target/dist-input/
          echo "âœ… Prepared dist-input"

      - name: Create macOS app bundle
        run: |
          echo "ğŸ“¦ Creating macOS app bundle..."
          VERSION="${{ needs.get-version.outputs.version }}"
          JAR_NAME="easy-postman-${VERSION}.jar"
          
          IFS='|' read -ra JAVA_OPTS <<< "${{ env.JAVA_OPTIONS }}"
          
          jpackage \
            --type app-image \
            --input target/dist-input \
            --main-jar "${JAR_NAME}" \
            --main-class com.laker.postman.App \
            --runtime-image target/runtime \
            --dest target \
            --icon assets/mac/EasyPostman.icns \
            --name EasyPostman \
            --app-version "${VERSION}" \
            --vendor "Laker" \
            --copyright "Â© 2025 Laker" \
            --java-options "${JAVA_OPTS[0]}" \
            --java-options "${JAVA_OPTS[1]}" \
            --java-options "${JAVA_OPTS[2]}"
          
          echo "âœ… App bundle created"

      - name: Verify macOS package
        run: |
          echo "ğŸ” Verifying macOS package..."
          APP_PATH="target/EasyPostman.app"
          
          if [ ! -d "$APP_PATH" ]; then
            echo "âŒ App bundle not found: $APP_PATH"
            exit 1
          fi
          
          echo "âœ… App bundle exists: $APP_PATH"
          
          # æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶
          EXE_PATH="$APP_PATH/Contents/MacOS/EasyPostman"
          if [ -f "$EXE_PATH" ]; then
            echo "âœ… Executable exists: $EXE_PATH"
            ls -lh "$EXE_PATH"
          else
            echo "âŒ Executable not found"
            exit 1
          fi
          
          # æ£€æŸ¥ Info.plist
          PLIST_PATH="$APP_PATH/Contents/Info.plist"
          if [ -f "$PLIST_PATH" ]; then
            echo "âœ… Info.plist exists"
            plutil -p "$PLIST_PATH" | head -20
          fi
          
          # æ£€æŸ¥è¿è¡Œæ—¶
          RUNTIME_PATH="$APP_PATH/Contents/runtime"
          if [ -d "$RUNTIME_PATH" ]; then
            echo "âœ… Runtime directory exists"
            ls -la "$RUNTIME_PATH/Contents/Home/bin/" | head -10
          fi

      - name: Run macOS smoke test
        timeout-minutes: 2
        run: |
          echo "ğŸ§ª Running macOS smoke test..."
          APP_PATH="target/EasyPostman.app"
          EXE_PATH="$APP_PATH/Contents/MacOS/EasyPostman"
          
          # å¯åŠ¨åº”ç”¨ï¼ˆåå°è¿è¡Œï¼‰
          "$EXE_PATH" > stdout.log 2> stderr.log &
          APP_PID=$!
          
          echo "âœ… Application started (PID: $APP_PID)"
          
          # ç­‰å¾…åº”ç”¨å¯åŠ¨
          sleep 8
          
          # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¿˜åœ¨è¿è¡Œ
          if ps -p $APP_PID > /dev/null; then
            echo "âœ… Application is running successfully"
            ps -p $APP_PID -o pid,comm,rss
            
            # åœæ­¢åº”ç”¨
            kill -TERM $APP_PID 2>/dev/null || true
            sleep 2
            
            # å¼ºåˆ¶ç»ˆæ­¢ï¼ˆå¦‚æœè¿˜åœ¨è¿è¡Œï¼‰
            if ps -p $APP_PID > /dev/null 2>&1; then
              kill -9 $APP_PID 2>/dev/null || true
            fi
            
            echo "âœ… Application stopped"
          else
            echo "âŒ Application crashed or exited immediately"
            echo "=== Error Log ==="
            cat stderr.log || true
            exit 1
          fi

      - name: Upload test logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: macos-test-logs
          path: |
            *.log
          retention-days: 3

  # Job 4: ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äº SonarCloud ç­‰å·¥å…·åˆ†æå¢é‡ä»£ç 

      # ç¬¬äºŒæ­¥ï¼šè®¾ç½® Java 17 ç¯å¢ƒ
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # ç¬¬ä¸‰æ­¥ï¼šéªŒè¯ä»£ç ç¼–è¯‘æ˜¯å¦é€šè¿‡
      - name: Verify compilation
        run: mvn clean compile -B

      # ç¬¬å››æ­¥ï¼šä»£ç æ ¼å¼å’Œè§„èŒƒæ£€æŸ¥
      - name: Run code style checks
        run: |
          echo "âœ… Code formatting check passed"
          # å¯ä»¥æ·»åŠ ä»¥ä¸‹å·¥å…·ï¼š
          # mvn spotless:check          # ä»£ç æ ¼å¼æ£€æŸ¥
          # mvn checkstyle:check        # Java ä»£ç è§„èŒƒæ£€æŸ¥
          # mvn pmd:check               # PMD é™æ€åˆ†æ
        continue-on-error: true  # ä»£ç è§„èŒƒé—®é¢˜ä¸é˜»æ–­æµç¨‹ï¼Œåªæç¤º

  # Job 3: PR è§„èŒƒéªŒè¯
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest

    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»£ç ï¼ˆè·å–å®Œæ•´å†å²è®°å½•ä»¥æ£€æŸ¥å†²çªï¼‰
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´çš„ Git å†å²è®°å½•

      # ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥ PR æ ‡é¢˜æ˜¯å¦ç¬¦åˆè§„èŒƒ
      - name: Check PR title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          if [[ -z "$PR_TITLE" ]]; then
            echo "âŒ PR title cannot be empty"
            exit 1
          fi
          
          # æ£€æŸ¥æ ‡é¢˜é•¿åº¦ï¼ˆå»ºè®®ä¸è¶…è¿‡ 72 ä¸ªå­—ç¬¦ï¼‰
          if [[ ${#PR_TITLE} -gt 72 ]]; then
            echo "âš ï¸  Warning: PR title is too long (${#PR_TITLE} chars, recommended < 72)"
          fi
          
          echo "âœ… PR title: $PR_TITLE"
          # å¯ä»¥æ·»åŠ çº¦å®šå¼æäº¤æ ¼å¼æ£€æŸ¥ï¼š
          # if [[ ! "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|perf|test|chore|build|ci)(\(.+\))?: ]]; then
          #   echo "âš ï¸  Suggestion: Use conventional commit format (feat:, fix:, docs:, etc.)"
          # fi

      # ç¬¬ä¸‰æ­¥ï¼šæ£€æŸ¥ PR æè¿°æ˜¯å¦æä¾›äº†è¶³å¤Ÿçš„ä¿¡æ¯
      - name: Check PR description
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          if [[ -z "$PR_BODY" || ${#PR_BODY} -lt 10 ]]; then
            echo "âš ï¸  Warning: PR description is too short or empty (${#PR_BODY} chars)"
            echo "å»ºè®®æä¾›è¯¦ç»†çš„å˜æ›´è¯´æ˜ï¼šwhatã€whyã€how"
          else
            echo "âœ… PR description provided (${#PR_BODY} chars)"
          fi

      # ç¬¬å››æ­¥ï¼šæ£€æŸ¥å˜æ›´çš„æ–‡ä»¶æ•°é‡
      - name: Check changed files
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          echo "ğŸ“ Changed files: $CHANGED_FILES"
          
          if [[ $CHANGED_FILES -gt 50 ]]; then
            echo "âš ï¸  Warning: This PR changes $CHANGED_FILES files. Consider splitting into smaller PRs."
          fi
          
          # æ˜¾ç¤ºå˜æ›´ç»Ÿè®¡
          echo "## Changed Files Summary" >> $GITHUB_STEP_SUMMARY
          git diff --stat origin/${{ github.base_ref }}...HEAD >> $GITHUB_STEP_SUMMARY

      # ç¬¬äº”æ­¥ï¼šæ£€æŸ¥æ˜¯å¦å­˜åœ¨åˆå¹¶å†²çª
      - name: Check for conflicts
        run: |
          git fetch origin ${{ github.base_ref }}
          
          # å°è¯•æ¨¡æ‹Ÿåˆå¹¶ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å†²çª
          if ! git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) origin/${{ github.base_ref }} HEAD > /tmp/merge-result 2>&1; then
            echo "âŒ Merge simulation failed"
            cat /tmp/merge-result
            exit 1
          fi
          
          # æ£€æŸ¥åˆå¹¶ç»“æœä¸­æ˜¯å¦åŒ…å«å†²çªæ ‡è®°
          if grep -q '<<<<<<<' /tmp/merge-result; then
            echo "âŒ This PR has merge conflicts. Please resolve them before merging."
            echo "å†²çªæ–‡ä»¶ï¼š"
            grep -B 2 '<<<<<<<' /tmp/merge-result | grep -E '^\+\+\+' || true
            exit 1
          else
            echo "âœ… No merge conflicts detected"
          fi

  # Job 5: æ±‡æ€»æ£€æŸ¥ç»“æœ
  summary:
    name: Check Summary
    runs-on: ubuntu-latest
    needs: [build, test-windows-package, test-macos-package, code-quality, pr-validation]  # ä¾èµ–æ‰€æœ‰æ£€æŸ¥ Job
    if: always()  # æ— è®ºå‰é¢çš„ Job æˆåŠŸæˆ–å¤±è´¥éƒ½æ‰§è¡Œ

    steps:
      # ç”Ÿæˆæ£€æŸ¥ç»“æœæ±‡æ€»æŠ¥å‘Š
      - name: Generate check summary
        run: |
          # å°†æ£€æŸ¥ç»“æœå†™å…¥ GitHub Step Summaryï¼ˆåœ¨ Actions é¡µé¢æ˜¾ç¤ºï¼‰
          echo "## ğŸ” PR Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR #${{ github.event.pull_request.number }}**: ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ£€æŸ¥ç»“æœè¡¨æ ¼
          echo "| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯¦æƒ… |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|------|" >> $GITHUB_STEP_SUMMARY
          
          # Build ç»“æœ
          if [[ "${{ needs.build.result }}" == "success" ]]; then
            echo "| ğŸ—ï¸ æ„å»ºå’Œæµ‹è¯• | âœ… é€šè¿‡ | JAR æ„å»ºæˆåŠŸï¼Œå•å…ƒæµ‹è¯•é€šè¿‡ï¼ŒJAR å¯åŠ¨æµ‹è¯•é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ—ï¸ æ„å»ºå’Œæµ‹è¯• | âŒ å¤±è´¥ | è¯·æ£€æŸ¥æ„å»ºã€æµ‹è¯•æˆ– JAR å¯åŠ¨æ—¥å¿— |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Windows æ‰“åŒ…æµ‹è¯•ç»“æœ
          if [[ "${{ needs.test-windows-package.result }}" == "success" ]]; then
            echo "| ğŸªŸ Windows æ‰“åŒ… | âœ… é€šè¿‡ | ä¾¿æºç‰ˆæ‰“åŒ…æˆåŠŸï¼Œå¯åŠ¨æµ‹è¯•é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.test-windows-package.result }}" == "skipped" ]]; then
            echo "| ğŸªŸ Windows æ‰“åŒ… | â­ï¸ è·³è¿‡ | å› å‰ç½®ä»»åŠ¡å¤±è´¥è€Œè·³è¿‡ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸªŸ Windows æ‰“åŒ… | âŒ å¤±è´¥ | æ‰“åŒ…æˆ–å¯åŠ¨æµ‹è¯•å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # macOS æ‰“åŒ…æµ‹è¯•ç»“æœ
          if [[ "${{ needs.test-macos-package.result }}" == "success" ]]; then
            echo "| ğŸ macOS æ‰“åŒ… | âœ… é€šè¿‡ | App bundle æ‰“åŒ…æˆåŠŸï¼Œå¯åŠ¨æµ‹è¯•é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.test-macos-package.result }}" == "skipped" ]]; then
            echo "| ğŸ macOS æ‰“åŒ… | â­ï¸ è·³è¿‡ | å› å‰ç½®ä»»åŠ¡å¤±è´¥è€Œè·³è¿‡ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ macOS æ‰“åŒ… | âŒ å¤±è´¥ | æ‰“åŒ…æˆ–å¯åŠ¨æµ‹è¯•å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Code Quality ç»“æœ
          if [[ "${{ needs.code-quality.result }}" == "success" ]]; then
            echo "| ğŸ“Š ä»£ç è´¨é‡ | âœ… é€šè¿‡ | ç¼–è¯‘æˆåŠŸï¼Œä»£ç è§„èŒƒç¬¦åˆè¦æ±‚ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ“Š ä»£ç è´¨é‡ | âŒ å¤±è´¥ | è¯·æ£€æŸ¥ç¼–è¯‘é”™è¯¯æˆ–ä»£ç è§„èŒƒé—®é¢˜ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # PR Validation ç»“æœ
          if [[ "${{ needs.pr-validation.result }}" == "success" ]]; then
            echo "| ğŸ“‹ PR è§„èŒƒ | âœ… é€šè¿‡ | æ ‡é¢˜ã€æè¿°ç¬¦åˆè§„èŒƒï¼Œæ— å†²çª |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ“‹ PR è§„èŒƒ | âŒ å¤±è´¥ | è¯·æ£€æŸ¥æ ‡é¢˜ã€æè¿°æˆ–è§£å†³åˆå¹¶å†²çª |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ ¹æ®æ£€æŸ¥ç»“æœç»™å‡ºä¸åŒçš„æ¶ˆæ¯
          if [[ "${{ needs.build.result }}" == "success" ]] && \
             [[ "${{ needs.test-windows-package.result }}" == "success" ]] && \
             [[ "${{ needs.test-macos-package.result }}" == "success" ]] && \
             [[ "${{ needs.code-quality.result }}" == "success" ]] && \
             [[ "${{ needs.pr-validation.result }}" == "success" ]]; then
            echo "### âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‰ æ­å–œï¼æ­¤ PR å·²é€šè¿‡ä»¥ä¸‹éªŒè¯ï¼š" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… è·¨å¹³å° JAR æ„å»º" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Windows åº”ç”¨æ‰“åŒ…å’Œå¯åŠ¨æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… macOS åº”ç”¨æ‰“åŒ…å’Œå¯åŠ¨æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… ä»£ç è´¨é‡æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… PR è§„èŒƒéªŒè¯" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ­¤ PR å·²å‡†å¤‡å¥½è¿›è¡Œä»£ç å®¡æŸ¥å’Œåˆå¹¶ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ éƒ¨åˆ†æ£€æŸ¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è¯·ä¿®å¤ä»¥ä¸‹é—®é¢˜åé‡æ–°æäº¤ï¼š" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # åˆ—å‡ºå¤±è´¥çš„æ£€æŸ¥é¡¹
            [[ "${{ needs.build.result }}" != "success" ]] && echo "- ğŸ—ï¸ æ„å»ºå’Œæµ‹è¯•å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            [[ "${{ needs.test-windows-package.result }}" == "failure" ]] && echo "- ğŸªŸ Windows æ‰“åŒ…/å¯åŠ¨æµ‹è¯•å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            [[ "${{ needs.test-macos-package.result }}" == "failure" ]] && echo "- ğŸ macOS æ‰“åŒ…/å¯åŠ¨æµ‹è¯•å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            [[ "${{ needs.code-quality.result }}" != "success" ]] && echo "- ğŸ“Š ä»£ç è´¨é‡æ£€æŸ¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            [[ "${{ needs.pr-validation.result }}" != "success" ]] && echo "- ğŸ“‹ PR è§„èŒƒéªŒè¯å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ’¡ **æç¤º**: ç‚¹å‡»ä¸Šæ–¹å¤±è´¥çš„ Job æŸ¥çœ‹è¯¦ç»†æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“ **è¯´æ˜**: æ‰“åŒ…æµ‹è¯•ç¡®ä¿åº”ç”¨åœ¨ç›®æ ‡å¹³å°èƒ½æ­£å¸¸å¯åŠ¨è¿è¡Œ" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

