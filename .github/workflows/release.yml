name: Release Buildï¼ˆå‘å¸ƒæ„å»ºï¼‰

permissions:
  contents: write

on:
  release:
    types: [created]  # å½“åˆ›å»ºæ–°çš„ Release æ—¶è§¦å‘
  workflow_dispatch: {}  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    name: Build Windows MSIï¼ˆæ„å»º Windows å®‰è£…åŒ…ï¼‰
    runs-on: windows-latest

    steps:
      - name: Checkoutï¼ˆæ£€å‡ºä»£ç ï¼‰
        uses: actions/checkout@v4

      - name: Setup Java 17 (Temurin)ï¼ˆé…ç½® Java 17 ç¯å¢ƒï¼‰
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Install WiX (for jpackage)ï¼ˆå®‰è£… WiX å·¥å…·é›†ï¼Œç”¨äºåˆ›å»º MSIï¼‰
        shell: pwsh
        run: |
          choco install wixtoolset -y
          if (Get-Command refreshenv -ErrorAction SilentlyContinue) { 
            refreshenv 
          } else {
            $refreshScript = "$env:ChocolateyInstall\lib\refreshenv\tools\RefreshEnv.ps1"
            if (Test-Path $refreshScript) { & $refreshScript }
          }

      - name: Get version from pom.xmlï¼ˆä» pom.xml æå–ç‰ˆæœ¬å·ï¼‰
        id: get_version
        shell: pwsh
        run: |
          [xml]$pom = Get-Content 'pom.xml'
          $version = $pom.project.version
          Write-Host "Version: $version"
          "version=$version" | Out-File -Encoding utf8 -FilePath $env:GITHUB_OUTPUT -Append

      - name: Build with Mavenï¼ˆä½¿ç”¨ Maven æ„å»ºé¡¹ç›®ï¼‰
        shell: pwsh
        run: |
          mvn -B clean package -DskipTests

      - name: Create runtime with jlinkï¼ˆä½¿ç”¨ jlink åˆ›å»ºç²¾ç®€çš„ JREï¼‰
        shell: pwsh
        run: |
          $runtimeDir = "target\runtime"
          if (Test-Path $runtimeDir) { Remove-Item -Recurse -Force $runtimeDir }
          
          # åˆ›å»ºåŒ…å«å¿…è¦æ¨¡å—çš„ç²¾ç®€è¿è¡Œæ—¶ç¯å¢ƒ
          jlink `
            --add-modules java.base,java.desktop,java.logging,jdk.unsupported,java.naming,java.net.http,java.prefs,java.sql,java.security.sasl,java.security.jgss,jdk.crypto.ec,java.management,java.management.rmi,jdk.crypto.cryptoki `
            --strip-debug `
            --no-header-files `
            --no-man-pages `
            --compress=2 `
            --output $runtimeDir

      - name: Prepare dist-inputï¼ˆå‡†å¤‡æ‰“åŒ…è¾“å…¥ç›®å½•ï¼‰
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          $jarName = "easy-postman-$version.jar"
          
          $distInputDir = "target\dist-input"
          if (Test-Path $distInputDir) { Remove-Item -Recurse -Force $distInputDir }
          New-Item -ItemType Directory -Path $distInputDir | Out-Null
          
          Copy-Item "target\$jarName" -Destination $distInputDir

      - name: Create MSI with jpackageï¼ˆä½¿ç”¨ jpackage åˆ›å»º MSI å®‰è£…åŒ…ï¼‰
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          $jarName = "easy-postman-$version.jar"
          $outDir = "dist"
          
          if (-not (Test-Path $outDir)) { New-Item -ItemType Directory -Path $outDir | Out-Null }
          
          # åˆ›å»º Windows MSI å®‰è£…åŒ…
          jpackage `
            --type msi `
            --input target\dist-input `
            --main-jar $jarName `
            --main-class com.laker.postman.App `
            --runtime-image target\runtime `
            --dest $outDir `
            --icon assets\win\EasyPostman.ico `
            --name EasyPostman `
            --app-version $version `
            --vendor "Laker" `
            --copyright "Â© 2025 Laker" `
            --win-shortcut `
            --win-menu `
            --win-upgrade-uuid "28607609-97b7-4212-9285-04ef64a4946c" `
            --win-dir-chooser `
            --win-per-user-install `
            --win-menu-group "EasyTools" `
            --win-help-url "https://gitee.com/lakernote/easy-postman" `
            --java-options "-Xms256m" `
            --java-options "-Xmx512m" `
            --java-options "-Dfile.encoding=UTF-8" `
            --java-options "-Djavax.accessibility.assistive_technologies="

      - name: Upload to Releaseï¼ˆä¸Šä¼ åˆ° GitHub Releaseï¼‰
        if: github.event_name == 'release'  # åªåœ¨ Release è§¦å‘æ—¶ä¸Šä¼ 
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.msi
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload as Artifactï¼ˆæ‰‹åŠ¨è§¦å‘æ—¶ä¸Šä¼ ä¸ºæ„å»ºäº§ç‰©ï¼‰
        if: github.event_name == 'workflow_dispatch'  # åªåœ¨æ‰‹åŠ¨è§¦å‘æ—¶ä¸Šä¼ ä¸º Artifact
        uses: actions/upload-artifact@v4
        with:
          name: EasyPostman-Windows-MSI
          path: dist/*.msi
          retention-days: 7  # ä¿ç•™ 7 å¤©

      - name: Upload MSI for Gitee syncï¼ˆä¸Šä¼  MSI ä¾› Gitee åŒæ­¥ä½¿ç”¨ï¼‰
        if: github.event_name == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: release-msi
          path: dist/*.msi
          retention-days: 1

  build-macos:
    name: Build macOS Universal DMGï¼ˆæ„å»º macOS é€šç”¨ç‰ˆå®‰è£…åŒ…ï¼‰
    runs-on: macos-latest  # Apple Silicon (M1/M2/M3)

    steps:
      - name: Checkoutï¼ˆæ£€å‡ºä»£ç ï¼‰
        uses: actions/checkout@v4

      - name: Setup Java 17 (Temurin)ï¼ˆé…ç½® Java 17 ç¯å¢ƒï¼‰
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Get version from pom.xmlï¼ˆä» pom.xml æå–ç‰ˆæœ¬å·ï¼‰
        id: get_version
        run: |
          VERSION=$(grep -m 1 '<version>' pom.xml | sed 's/.*<version>\(.*\)<\/version>.*/\1/')
          echo "Version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build with Mavenï¼ˆä½¿ç”¨ Maven æ„å»ºé¡¹ç›®ï¼‰
        run: |
          mvn -B clean package -DskipTests

      - name: Create runtime with jlinkï¼ˆä½¿ç”¨ jlink åˆ›å»ºç²¾ç®€çš„ JREï¼‰
        run: |
          rm -rf target/runtime
          # åˆ›å»ºåŒ…å«å¿…è¦æ¨¡å—çš„ç²¾ç®€è¿è¡Œæ—¶ç¯å¢ƒ
          jlink \
            --add-modules java.base,java.desktop,java.logging,jdk.unsupported,java.naming,java.net.http,java.prefs,java.sql,java.security.sasl,java.security.jgss,jdk.crypto.ec,java.management,java.management.rmi,jdk.crypto.cryptoki \
            --strip-debug \
            --no-header-files \
            --no-man-pages \
            --compress=2 \
            --output target/runtime

      - name: Prepare dist-inputï¼ˆå‡†å¤‡æ‰“åŒ…è¾“å…¥ç›®å½•ï¼‰
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          JAR_NAME="easy-postman-$VERSION.jar"
          
          rm -rf target/dist-input
          mkdir -p target/dist-input
          cp target/$JAR_NAME target/dist-input/

      - name: Create DMG with jpackageï¼ˆä½¿ç”¨ jpackage åˆ›å»º DMG é•œåƒï¼‰
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          JAR_NAME="easy-postman-$VERSION.jar"
          
          mkdir -p dist
          
          # åˆ›å»º macOS Universal Binary DMGï¼ˆåŒæ—¶æ”¯æŒ Intel å’Œ Apple Siliconï¼‰
          jpackage \
            --input target/dist-input \
            --main-jar $JAR_NAME \
            --main-class com.laker.postman.App \
            --runtime-image target/runtime \
            --type dmg \
            --name "EasyPostman" \
            --app-version "$VERSION" \
            --dest dist \
            --icon assets/mac/EasyPostman.icns \
            --vendor "Laker" \
            --copyright "Â© 2025 Laker" \
            --java-options "-Xms256m" \
            --java-options "-Xmx512m" \
            --java-options "-Dfile.encoding=UTF-8"

      - name: Upload to Releaseï¼ˆä¸Šä¼ åˆ° GitHub Releaseï¼‰
        if: github.event_name == 'release'  # åªåœ¨ Release è§¦å‘æ—¶ä¸Šä¼ 
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.dmg
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload as Artifactï¼ˆæ‰‹åŠ¨è§¦å‘æ—¶ä¸Šä¼ ä¸ºæ„å»ºäº§ç‰©ï¼‰
        if: github.event_name == 'workflow_dispatch'  # åªåœ¨æ‰‹åŠ¨è§¦å‘æ—¶ä¸Šä¼ ä¸º Artifact
        uses: actions/upload-artifact@v4
        with:
          name: EasyPostman-macOS-DMG
          path: dist/*.dmg
          retention-days: 7  # ä¿ç•™ 7 å¤©

      - name: Upload DMG for Gitee syncï¼ˆä¸Šä¼  DMG ä¾› Gitee åŒæ­¥ä½¿ç”¨ï¼‰
        if: github.event_name == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: release-dmg
          path: dist/*.dmg
          retention-days: 1

  build-ubuntu:
    name: Build Ubuntu DEBï¼ˆæ„å»º Ubuntu å®‰è£…åŒ…ï¼‰
    runs-on: ubuntu-22.04

    steps:
      - name: Checkoutï¼ˆæ£€å‡ºä»£ç ï¼‰
        uses: actions/checkout@v4

      - name: Setup Java 17 (Temurin)ï¼ˆé…ç½® Java 17 ç¯å¢ƒï¼‰
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Install dependenciesï¼ˆå®‰è£…ç³»ç»Ÿä¾èµ–ï¼‰
        run: |
          sudo apt-get update
          # å®‰è£… GTK3ã€WebKit å’Œæ‰“åŒ…å·¥å…·
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev binutils

      - name: Get version from pom.xmlï¼ˆä» pom.xml æå–ç‰ˆæœ¬å·ï¼‰
        id: get_version
        run: |
          VERSION=$(grep -m 1 '<version>' pom.xml | sed 's/.*<version>\(.*\)<\/version>.*/\1/')
          echo "Version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build with Mavenï¼ˆä½¿ç”¨ Maven æ„å»ºé¡¹ç›®ï¼‰
        run: |
          mvn -B clean package -DskipTests

      - name: Create runtime with jlinkï¼ˆä½¿ç”¨ jlink åˆ›å»ºç²¾ç®€çš„ JREï¼‰
        run: |
          rm -rf target/runtime
          # åˆ›å»ºåŒ…å«å¿…è¦æ¨¡å—çš„ç²¾ç®€è¿è¡Œæ—¶ç¯å¢ƒ
          jlink \
            --add-modules java.base,java.desktop,java.logging,jdk.unsupported,java.naming,java.net.http,java.prefs,java.sql,java.security.sasl,java.security.jgss,jdk.crypto.ec,java.management,java.management.rmi,jdk.crypto.cryptoki \
            --strip-debug \
            --no-header-files \
            --no-man-pages \
            --compress=2 \
            --output target/runtime

      - name: Prepare dist-inputï¼ˆå‡†å¤‡æ‰“åŒ…è¾“å…¥ç›®å½•ï¼‰
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          JAR_NAME="easy-postman-$VERSION.jar"
          
          rm -rf target/dist-input
          mkdir -p target/dist-input
          cp target/$JAR_NAME target/dist-input/

      - name: Create DEB with jpackageï¼ˆä½¿ç”¨ jpackage åˆ›å»º DEB å®‰è£…åŒ…ï¼‰
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          JAR_NAME="easy-postman-$VERSION.jar"
          
          mkdir -p dist
          
          # åˆ›å»º Ubuntu/Debian DEB å®‰è£…åŒ…
          jpackage \
            --input target/dist-input \
            --main-jar $JAR_NAME \
            --main-class com.laker.postman.App \
            --runtime-image target/runtime \
            --type deb \
            --name "EasyPostman" \
            --app-version "$VERSION" \
            --dest dist \
            --vendor "Laker" \
            --copyright "Â© 2025 Laker" \
            --description "A modern API testing tool similar to Postman" \
            --linux-shortcut \
            --linux-menu-group "Development" \
            --linux-app-category "Development" \
            --java-options "-Xms256m" \
            --java-options "-Xmx512m" \
            --java-options "-Dfile.encoding=UTF-8"

      - name: Upload to Releaseï¼ˆä¸Šä¼ åˆ° GitHub Releaseï¼‰
        if: github.event_name == 'release'  # åªåœ¨ Release è§¦å‘æ—¶ä¸Šä¼ 
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.deb
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload as Artifactï¼ˆæ‰‹åŠ¨è§¦å‘æ—¶ä¸Šä¼ ä¸ºæ„å»ºäº§ç‰©ï¼‰
        if: github.event_name == 'workflow_dispatch'  # åªåœ¨æ‰‹åŠ¨è§¦å‘æ—¶ä¸Šä¼ ä¸º Artifact
        uses: actions/upload-artifact@v4
        with:
          name: EasyPostman-Ubuntu-DEB
          path: dist/*.deb
          retention-days: 7  # ä¿ç•™ 7 å¤©

      - name: Upload DEB for Gitee syncï¼ˆä¸Šä¼  DEB ä¾› Gitee åŒæ­¥ä½¿ç”¨ï¼‰
        if: github.event_name == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: release-deb
          path: dist/*.deb
          retention-days: 1

  sync-to-gitee:
    name: Sync to Gitee Releaseï¼ˆåŒæ­¥åˆ° Gitee Releaseï¼‰
    if: github.event_name == 'release'
    needs: [build-windows, build-macos, build-ubuntu]  # ç­‰å¾…æ‰€æœ‰æ„å»ºå®Œæˆ
    runs-on: ubuntu-latest

    steps:
      - name: Download all release artifactsï¼ˆä¸‹è½½æ‰€æœ‰å‘å¸ƒäº§ç‰©ï¼‰
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get version from tagï¼ˆä»æ ‡ç­¾è·å–ç‰ˆæœ¬å·ï¼‰
        id: get_version
        run: |
          TAG_NAME="${{ github.event.release.tag_name }}"
          VERSION="${TAG_NAME#v}"  # ç§»é™¤ v å‰ç¼€
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Create or get Gitee Releaseï¼ˆåˆ›å»ºæˆ–è·å– Gitee Releaseï¼‰
        id: gitee_release
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          TAG_NAME="${{ steps.get_version.outputs.tag }}"
          
          echo "Creating/Getting Gitee Release for tag: $TAG_NAME"
          
          # æ£€æŸ¥ Release æ˜¯å¦å­˜åœ¨
          RELEASE_URL="https://gitee.com/api/v5/repos/lakernote/easy-postman/releases/tags/$TAG_NAME?access_token=${{ secrets.GITEE_TOKEN }}"
          
          if curl -s -f "$RELEASE_URL" > /tmp/release.json; then
            echo "Release already exists"
            RELEASE_ID=$(cat /tmp/release.json | grep -o '"id":[0-9]*' | head -1 | grep -o '[0-9]*')
          else
            echo "Creating new release on Gitee..."
            RELEASE_ID=$(curl -s -X POST "https://gitee.com/api/v5/repos/lakernote/easy-postman/releases" \
              -H "Content-Type: application/json" \
              -d "{
                \"access_token\": \"${{ secrets.GITEE_TOKEN }}\",
                \"tag_name\": \"$TAG_NAME\",
                \"name\": \"EasyPostman $VERSION\",
                \"body\": \"${{ github.event.release.body }}\",
                \"prerelease\": false,
                \"target_commitish\": \"master\"
              }" | grep -o '"id":[0-9]*' | head -1 | grep -o '[0-9]*')
          fi
          
          echo "release_id=$RELEASE_ID" >> $GITHUB_OUTPUT
          echo "Gitee Release ID: $RELEASE_ID"

      - name: Upload MSI to Giteeï¼ˆä¸Šä¼  MSI åˆ° Giteeï¼‰
        run: |
          RELEASE_ID="${{ steps.gitee_release.outputs.release_id }}"
          MSI_FILE=$(find artifacts/release-msi -name "*.msi" | head -n 1)
          
          if [ -z "$MSI_FILE" ]; then
            echo "âš ï¸ MSI file not found, skipping..."
            exit 0
          fi
          
          echo "ğŸ“¦ Uploading $(basename $MSI_FILE) to Gitee..."
          
          curl -X POST "https://gitee.com/api/v5/repos/lakernote/easy-postman/releases/$RELEASE_ID/attach_files" \
            -F "access_token=${{ secrets.GITEE_TOKEN }}" \
            -F "file=@$MSI_FILE"
          
          echo "âœ… MSI uploaded successfully!"

      - name: Upload DMG to Giteeï¼ˆä¸Šä¼  DMG åˆ° Giteeï¼‰
        run: |
          RELEASE_ID="${{ steps.gitee_release.outputs.release_id }}"
          DMG_FILE=$(find artifacts/release-dmg -name "*.dmg" | head -n 1)
          
          if [ -z "$DMG_FILE" ]; then
            echo "âš ï¸ DMG file not found, skipping..."
            exit 0
          fi
          
          echo "ğŸ“¦ Uploading $(basename $DMG_FILE) to Gitee..."
          
          curl -X POST "https://gitee.com/api/v5/repos/lakernote/easy-postman/releases/$RELEASE_ID/attach_files" \
            -F "access_token=${{ secrets.GITEE_TOKEN }}" \
            -F "file=@$DMG_FILE"
          
          echo "âœ… DMG uploaded successfully!"

      - name: Upload DEB to Giteeï¼ˆä¸Šä¼  DEB åˆ° Giteeï¼‰
        run: |
          RELEASE_ID="${{ steps.gitee_release.outputs.release_id }}"
          DEB_FILE=$(find artifacts/release-deb -name "*.deb" | head -n 1)
          
          if [ -z "$DEB_FILE" ]; then
            echo "âš ï¸ DEB file not found, skipping..."
            exit 0
          fi
          
          echo "ğŸ“¦ Uploading $(basename $DEB_FILE) to Gitee..."
          
          curl -X POST "https://gitee.com/api/v5/repos/lakernote/easy-postman/releases/$RELEASE_ID/attach_files" \
            -F "access_token=${{ secrets.GITEE_TOKEN }}" \
            -F "file=@$DEB_FILE"
          
          echo "âœ… DEB uploaded successfully!"

      - name: Summaryï¼ˆæ±‡æ€»ï¼‰
        run: |
          echo "ğŸ‰ All packages have been synced to Gitee Release!"
          echo "ğŸ“ Release URL: https://gitee.com/lakernote/easy-postman/releases/${{ steps.get_version.outputs.tag }}"

