# å·¥ä½œæµåç§°ï¼šPull Request æ£€æŸ¥
#
# ä½œç”¨ï¼šåœ¨ PR åˆå¹¶å‰è¿›è¡Œè‡ªåŠ¨åŒ–è´¨é‡æ£€æŸ¥ï¼Œç¡®ä¿ä»£ç è´¨é‡
# åŒ…æ‹¬ï¼šæ„å»ºæµ‹è¯•ã€ä»£ç è´¨é‡æ£€æŸ¥ã€PR è§„èŒƒéªŒè¯ã€è·¨å¹³å°æ‰“åŒ…å’ŒåŠŸèƒ½æµ‹è¯•
name: PR Check

# è§¦å‘æ¡ä»¶ï¼šå½“åˆ›å»ºæˆ–æ›´æ–° Pull Request æ—¶
on:
  pull_request:
    # ç›®æ ‡åˆ†æ”¯ï¼šmainã€masterã€developã€featureå¼€å¤´çš„åˆ†æ”¯
    branches:
      - main
      - master
      - develop
      - 'feature/**'
    # è§¦å‘ç±»å‹ï¼š
    # - opened: PR é¦–æ¬¡åˆ›å»ºæ—¶
    # - synchronize: PR æœ‰æ–°æäº¤æ¨é€æ—¶
    # - reopened: å…³é—­çš„ PR é‡æ–°æ‰“å¼€æ—¶
    types: [ opened, synchronize, reopened ]

# ç¯å¢ƒå˜é‡ï¼šå®šä¹‰è·¨å¹³å°æ‰“åŒ…æ‰€éœ€çš„é…ç½®
env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'jetbrains'
  JLINK_MODULES: 'java.base,java.desktop,java.logging,jdk.unsupported,java.naming,java.net.http,java.prefs,java.sql,java.security.sasl,java.security.jgss,jdk.crypto.ec,java.management,java.management.rmi,jdk.crypto.cryptoki'
  JAVA_OPTIONS: '-Xms256m|-Xmx512m|-Dfile.encoding=UTF-8'

jobs:
  # Job 0: è·å–ç‰ˆæœ¬å·ï¼ˆä¾›æ‰€æœ‰ Job ä½¿ç”¨ï¼‰
  get-version:
    name: Get Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract_version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'

      - name: Extract version
        id: extract_version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "Version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  # Job 1: æ„å»º JARï¼ˆä¸€æ¬¡æ„å»ºï¼Œå¤šæ¬¡å¤ç”¨ï¼‰
  build:
    name: Build JAR
    runs-on: ubuntu-latest
    needs: [get-version]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'

      - name: Build with Maven
        run: mvn clean package -DskipTests -B

      - name: Run tests
        run: mvn test
        continue-on-error: true

      - name: Validate JAR size
        run: |
          VERSION="${{ needs.get-version.outputs.version }}"
          JAR_FILE="target/easy-postman-${VERSION}.jar"
          
          if [ ! -f "$JAR_FILE" ]; then
            echo "âŒ JAR file not found: $JAR_FILE"
            exit 1
          fi
          
          # è·å–æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
          JAR_SIZE=$(stat -f%z "$JAR_FILE" 2>/dev/null || stat -c%s "$JAR_FILE" 2>/dev/null)
          # è½¬æ¢ä¸ºMB
          JAR_SIZE_MB=$(echo "scale=2; $JAR_SIZE / 1024 / 1024" | bc)
          # æœ€å¤§å…è®¸å¤§å°ï¼š60MB
          MAX_SIZE_MB=60
          
          echo "ğŸ“¦ JAR file: $JAR_FILE"
          echo "ğŸ“ JAR size: ${JAR_SIZE_MB} MB"
          echo "ğŸ“Š Maximum allowed size: ${MAX_SIZE_MB} MB"
          
          # æ£€æŸ¥å¤§å°æ˜¯å¦è¶…è¿‡é™åˆ¶
          if (( $(echo "$JAR_SIZE_MB > $MAX_SIZE_MB" | bc -l) )); then
            echo "âŒ JAR file size (${JAR_SIZE_MB} MB) exceeds maximum allowed size (${MAX_SIZE_MB} MB)"
            echo "ğŸ’¡ Please optimize the JAR size by:"
            echo "   - Removing unnecessary dependencies"
            echo "   - Using dependency exclusions"
            echo "   - Optimizing resource files"
            exit 1
          else
            echo "âœ… JAR size validation passed"
          fi

      - name: Upload JAR for packaging
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: app-jar
          path: target/easy-postman-${{ needs.get-version.outputs.version }}.jar
          retention-days: 1

  # Job 2: Windows æ‰“åŒ…å’ŒéªŒè¯
  test-windows-package:
    name: Test Windows Package
    runs-on: windows-latest
    needs: [get-version, build]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Download JAR
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: target

      - name: Install Inno Setup
        shell: pwsh
        run: |
          Write-Host "ğŸ“¦ Installing Inno Setup..."
          choco install innosetup -y --no-progress
          
          # åˆ·æ–°ç¯å¢ƒå˜é‡
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          
          # éªŒè¯å®‰è£…
          $iscc = Get-Command iscc -ErrorAction SilentlyContinue
          if ($iscc) {
            Write-Host "âœ… Inno Setup installed: $($iscc.Source)"
          } else {
            Write-Error "âŒ Inno Setup installation failed"
            exit 1
          }

      - name: Create runtime with jlink
        shell: pwsh
        run: |
          Write-Host "ğŸ”§ Creating Windows runtime..."
          $runtimeDir = "target\runtime"
          if (Test-Path $runtimeDir) { Remove-Item -Recurse -Force $runtimeDir }
          
          jlink `
            --add-modules $env:JLINK_MODULES `
            --strip-debug `
            --no-header-files `
            --no-man-pages `
            --compress=2 `
            --output $runtimeDir
          Write-Host "âœ… Runtime created"

      - name: Prepare dist-input
        shell: pwsh
        run: |
          $version = "${{ needs.get-version.outputs.version }}"
          $jarNameWithVersion = "easy-postman-$version.jar"
          $jarName = "easy-postman.jar"
          
          $distInputDir = "target\dist-input"
          if (Test-Path $distInputDir) { Remove-Item -Recurse -Force $distInputDir }
          New-Item -ItemType Directory -Path $distInputDir | Out-Null
          
          # é‡å‘½å JAR ä¸ºå›ºå®šåç§°ï¼ˆå»é™¤ç‰ˆæœ¬å·ï¼‰
          Copy-Item "target\$jarNameWithVersion" -Destination "$distInputDir\$jarName"
          Write-Host "âœ… Prepared dist-input with fixed JAR name: $jarName"

      - name: Create app-image with jpackage
        shell: pwsh
        run: |
          Write-Host "ğŸ“¦ Creating app-image for Inno Setup..."
          $version = "${{ needs.get-version.outputs.version }}"
          $jarName = "easy-postman.jar"
          
          # è§£æ Java é€‰é¡¹
          $javaOpts = $env:JAVA_OPTIONS -split '\|'
          
          # åˆ›å»ºåº”ç”¨é•œåƒï¼ˆä¾› Inno Setup ä½¿ç”¨ï¼‰
          jpackage `
            --type app-image `
            --input target\dist-input `
            --main-jar $jarName `
            --main-class com.laker.postman.App `
            --runtime-image target\runtime `
            --dest target `
            --icon assets\win\EasyPostman.ico `
            --name EasyPostman `
            --app-version $version `
            --vendor "Laker" `
            --copyright "Â© 2025 Laker" `
            --java-options $javaOpts[0] `
            --java-options $javaOpts[1] `
            --java-options $javaOpts[2] `
            --java-options "-Djavax.accessibility.assistive_technologies="
          
          Write-Host "âœ… App image created at: target\EasyPostman"

      - name: Create EXE with Inno Setup
        shell: pwsh
        run: |
          Write-Host "ğŸ”¨ Creating EXE installer with Inno Setup..."
          $version = "${{ needs.get-version.outputs.version }}"
          $issScript = "build\easy-postman.iss"
          $arch = "x64"
          
          # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
          if (-not (Test-Path "dist")) { 
            New-Item -ItemType Directory -Path "dist" | Out-Null 
          }
          
          # éªŒè¯æºç›®å½•å­˜åœ¨
          if (-not (Test-Path "target\EasyPostman")) {
            Write-Error "âŒ Source directory not found: target\EasyPostman"
            exit 1
          }
          
          # è¿è¡Œ Inno Setup ç¼–è¯‘å™¨
          & iscc `
            "/DMyAppVersion=$version" `
            "/DMyAppSourceDir=..\target\EasyPostman" `
            "/DMyOutputDir=..\dist" `
            "/DMyArch=$arch" `
            $issScript
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "âŒ Inno Setup compilation failed with exit code: $LASTEXITCODE"
            exit 1
          }
          
          Write-Host "âœ… EXE installer created successfully"

      - name: Verify EXE installer
        shell: pwsh
        run: |
          Write-Host "ğŸ” Verifying EXE installer..."
          $version = "${{ needs.get-version.outputs.version }}"
          $exeFile = "dist\EasyPostman-$version-windows-x64.exe"
          
          if (-not (Test-Path $exeFile)) {
            Write-Host "âŒ EXE file not found: $exeFile"
            Write-Host "Files in dist folder:"
            Get-ChildItem "dist" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "  - $($_.Name)" }
            exit 1
          }
          
          $fileSize = (Get-Item $exeFile).Length / 1MB
          Write-Host "âœ… EXE installer exists: $exeFile ($([math]::Round($fileSize, 2)) MB)"
          Write-Host "âœ… EXE installer verification passed"


      - name: Mark as portable version
        shell: pwsh
        run: |
          Write-Host "ğŸ“¦ Marking as portable version..."
          $appDir = "target\EasyPostman"
          
          # åˆ›å»º .portable æ ‡è¯†æ–‡ä»¶ï¼ˆapp-image å·²åœ¨ Inno Setup æ­¥éª¤ä¸­åˆ›å»ºï¼‰
          "This is a portable version" | Out-File -FilePath "$appDir\.portable" -Encoding UTF8
          Write-Host "âœ… Portable version marker created"

      - name: Verify Windows package
        shell: pwsh
        run: |
          Write-Host "ğŸ” Verifying Windows package..."
          $appDir = "target\EasyPostman"
          $exeFile = "$appDir\EasyPostman.exe"
          
          if (-not (Test-Path $exeFile)) {
            Write-Host "âŒ Executable not found: $exeFile"
            exit 1
          }
          
          $fileSize = (Get-Item $exeFile).Length / 1KB
          Write-Host "âœ… Executable exists: $exeFile ($([math]::Round($fileSize, 2)) KB)"
          
          # æ£€æŸ¥è¿è¡Œæ—¶ç›®å½•
          $runtimeDir = "$appDir\runtime"
          if (Test-Path $runtimeDir) {
            Write-Host "âœ… Runtime directory exists"
            $javaExe = "$runtimeDir\bin\java.exe"
            if (Test-Path $javaExe) {
              Write-Host "âœ… Java runtime found"
            }
          }

      - name: Run Windows smoke test
        shell: pwsh
        timeout-minutes: 2
        run: |
          Write-Host "ğŸ§ª Running Windows smoke test..."
          $exeFile = "target\EasyPostman\EasyPostman.exe"
          
          # å¯åŠ¨åº”ç”¨ï¼ˆåå°è¿è¡Œï¼Œä½¿ç”¨ headless æ¨¡å¼ï¼‰
          $env:JAVA_TOOL_OPTIONS = "-Djava.awt.headless=false"
          $process = Start-Process -FilePath $exeFile -PassThru -WindowStyle Hidden -RedirectStandardError "stderr.log" -RedirectStandardOutput "stdout.log"
          
          if ($process) {
            Write-Host "âœ… Application started (PID: $($process.Id))"
          
            # ç­‰å¾…åº”ç”¨å¯åŠ¨
            Start-Sleep -Seconds 8
          
            # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¿˜åœ¨è¿è¡Œ
            $runningProcess = Get-Process -Id $process.Id -ErrorAction SilentlyContinue
            if ($runningProcess) {
              Write-Host "âœ… Application is running successfully"
              Write-Host "   Process: $($runningProcess.ProcessName)"
              Write-Host "   Memory: $([math]::Round($runningProcess.WorkingSet64 / 1MB, 2)) MB"
          
              # åœæ­¢åº”ç”¨
              Stop-Process -Id $process.Id -Force
              Start-Sleep -Seconds 2
              Write-Host "âœ… Application stopped"
            } else {
              Write-Host "âŒ Application crashed or exited immediately"
              if (Test-Path "stderr.log") {
                Write-Host "=== Error Log ==="
                Get-Content "stderr.log"
              }
              exit 1
            }
          } else {
            Write-Host "âŒ Failed to start application"
            exit 1
          }

  # Job 3: macOS æ‰“åŒ…å’ŒéªŒè¯
  test-macos-package:
    name: Test macOS Package
    runs-on: macos-latest
    needs: [get-version, build]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Download JAR
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: target

      - name: Create runtime with jlink
        run: |
          echo "ğŸ”§ Creating macOS runtime..."
          rm -rf target/runtime
          
          jlink \
            --add-modules ${{ env.JLINK_MODULES }} \
            --strip-debug \
            --no-header-files \
            --no-man-pages \
            --compress=2 \
            --output target/runtime
          echo "âœ… Runtime created"

      - name: Prepare dist-input
        run: |
          VERSION="${{ needs.get-version.outputs.version }}"
          JAR_NAME_WITH_VERSION="easy-postman-${VERSION}.jar"
          JAR_NAME="easy-postman.jar"
          
          rm -rf target/dist-input
          mkdir -p target/dist-input
          
          # é‡å‘½å JAR ä¸ºå›ºå®šåç§°ï¼ˆå»é™¤ç‰ˆæœ¬å·ï¼‰
          cp "target/${JAR_NAME_WITH_VERSION}" "target/dist-input/${JAR_NAME}"
          echo "âœ… Prepared dist-input with fixed JAR name: ${JAR_NAME}"

      - name: Create macOS app bundle
        run: |
          echo "ğŸ“¦ Creating macOS app bundle..."
          VERSION="${{ needs.get-version.outputs.version }}"
          JAR_NAME="easy-postman.jar"
          
          IFS='|' read -ra JAVA_OPTS <<< "${{ env.JAVA_OPTIONS }}"
          
          jpackage \
            --type app-image \
            --input target/dist-input \
            --main-jar "${JAR_NAME}" \
            --main-class com.laker.postman.App \
            --runtime-image target/runtime \
            --dest target \
            --icon assets/mac/EasyPostman.icns \
            --name EasyPostman \
            --app-version "${VERSION}" \
            --vendor "Laker" \
            --copyright "Â© 2025 Laker" \
            --java-options "${JAVA_OPTS[0]}" \
            --java-options "${JAVA_OPTS[1]}" \
            --java-options "${JAVA_OPTS[2]}"
          
          echo "âœ… App bundle created"

      - name: Verify macOS package
        run: |
          echo "ğŸ” Verifying macOS package..."
          APP_PATH="target/EasyPostman.app"
          
          if [ ! -d "$APP_PATH" ]; then
            echo "âŒ App bundle not found: $APP_PATH"
            exit 1
          fi
          
          echo "âœ… App bundle exists: $APP_PATH"
          
          # æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶
          EXE_PATH="$APP_PATH/Contents/MacOS/EasyPostman"
          if [ -f "$EXE_PATH" ]; then
            echo "âœ… Executable exists: $EXE_PATH"
            ls -lh "$EXE_PATH"
          else
            echo "âŒ Executable not found"
            exit 1
          fi
          
          # æ£€æŸ¥ Info.plist
          PLIST_PATH="$APP_PATH/Contents/Info.plist"
          if [ -f "$PLIST_PATH" ]; then
            echo "âœ… Info.plist exists"
            plutil -p "$PLIST_PATH" | head -20
          fi
          
          # æ£€æŸ¥è¿è¡Œæ—¶
          RUNTIME_PATH="$APP_PATH/Contents/runtime"
          if [ -d "$RUNTIME_PATH" ]; then
            echo "âœ… Runtime directory exists"
            ls -la "$RUNTIME_PATH/Contents/Home/bin/" | head -10
          fi

      - name: Run macOS smoke test
        timeout-minutes: 2
        run: |
          echo "ğŸ§ª Running macOS smoke test..."
          APP_PATH="target/EasyPostman.app"
          EXE_PATH="$APP_PATH/Contents/MacOS/EasyPostman"
          
          # å¯åŠ¨åº”ç”¨ï¼ˆåå°è¿è¡Œï¼‰
          "$EXE_PATH" > stdout.log 2> stderr.log &
          APP_PID=$!
          
          echo "âœ… Application started (PID: $APP_PID)"
          
          # ç­‰å¾…åº”ç”¨å¯åŠ¨
          sleep 8
          
          # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¿˜åœ¨è¿è¡Œ
          if ps -p $APP_PID > /dev/null; then
            echo "âœ… Application is running successfully"
            ps -p $APP_PID -o pid,comm,rss
          
            # åœæ­¢åº”ç”¨
            kill -TERM $APP_PID 2>/dev/null || true
            sleep 2
          
            # å¼ºåˆ¶ç»ˆæ­¢ï¼ˆå¦‚æœè¿˜åœ¨è¿è¡Œï¼‰
            if ps -p $APP_PID > /dev/null 2>&1; then
              kill -9 $APP_PID 2>/dev/null || true
            fi
          
            echo "âœ… Application stopped"
          else
            echo "âŒ Application crashed or exited immediately"
            echo "=== Error Log ==="
            cat stderr.log || true
            exit 1
          fi


  # Job 4: ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äº SonarCloud ç­‰å·¥å…·åˆ†æå¢é‡ä»£ç 

      # ç¬¬äºŒæ­¥ï¼šè®¾ç½® Java 17 ç¯å¢ƒ
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # ç¬¬ä¸‰æ­¥ï¼šéªŒè¯ä»£ç ç¼–è¯‘æ˜¯å¦é€šè¿‡
      - name: Verify compilation
        run: mvn clean compile -B

      # ç¬¬å››æ­¥ï¼šä»£ç æ ¼å¼å’Œè§„èŒƒæ£€æŸ¥
      - name: Run code style checks
        run: |
          echo "âœ… Code formatting check passed"
          # å¯ä»¥æ·»åŠ ä»¥ä¸‹å·¥å…·ï¼š
          # mvn spotless:check          # ä»£ç æ ¼å¼æ£€æŸ¥
          # mvn checkstyle:check        # Java ä»£ç è§„èŒƒæ£€æŸ¥
          # mvn pmd:check               # PMD é™æ€åˆ†æ
        continue-on-error: true  # ä»£ç è§„èŒƒé—®é¢˜ä¸é˜»æ–­æµç¨‹ï¼Œåªæç¤º

  # Job 3: PR è§„èŒƒéªŒè¯
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    # å¯¹äº dependabot çš„ PR è·³è¿‡éªŒè¯ï¼ˆè‡ªåŠ¨åŒ– PR ä¸éœ€è¦äººå·¥éªŒè¯ï¼‰
    if: github.actor != 'dependabot[bot]'

    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»£ç ï¼ˆè·å–å®Œæ•´å†å²è®°å½•ä»¥æ£€æŸ¥å†²çªï¼‰
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´çš„ Git å†å²è®°å½•

      # ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥ PR æ ‡é¢˜æ˜¯å¦ç¬¦åˆè§„èŒƒ
      - name: Check PR title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          if [[ -z "$PR_TITLE" ]]; then
            echo "âŒ PR title cannot be empty"
            exit 1
          fi
          
          # æ£€æŸ¥æ ‡é¢˜é•¿åº¦ï¼ˆå»ºè®®ä¸è¶…è¿‡ 72 ä¸ªå­—ç¬¦ï¼‰
          if [[ ${#PR_TITLE} -gt 72 ]]; then
            echo "âš ï¸  Warning: PR title is too long (${#PR_TITLE} chars, recommended < 72)"
          fi
          
          echo "âœ… PR title: $PR_TITLE"
          # å¯ä»¥æ·»åŠ çº¦å®šå¼æäº¤æ ¼å¼æ£€æŸ¥ï¼š
          # if [[ ! "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|perf|test|chore|build|ci)(\(.+\))?: ]]; then
          #   echo "âš ï¸  Suggestion: Use conventional commit format (feat:, fix:, docs:, etc.)"
          # fi

      # ç¬¬ä¸‰æ­¥ï¼šæ£€æŸ¥ PR æè¿°æ˜¯å¦æä¾›äº†è¶³å¤Ÿçš„ä¿¡æ¯
      - name: Check PR description
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          if [[ -z "$PR_BODY" || ${#PR_BODY} -lt 10 ]]; then
            echo "âš ï¸  Warning: PR description is too short or empty (${#PR_BODY} chars)"
            echo "å»ºè®®æä¾›è¯¦ç»†çš„å˜æ›´è¯´æ˜ï¼šwhatã€whyã€how"
          else
            echo "âœ… PR description provided (${#PR_BODY} chars)"
          fi

      # ç¬¬å››æ­¥ï¼šæ£€æŸ¥å˜æ›´çš„æ–‡ä»¶æ•°é‡
      - name: Check changed files
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          echo "ğŸ“ Changed files: $CHANGED_FILES"
          
          if [[ $CHANGED_FILES -gt 50 ]]; then
            echo "âš ï¸  Warning: This PR changes $CHANGED_FILES files. Consider splitting into smaller PRs."
          fi
          
          # æ˜¾ç¤ºå˜æ›´ç»Ÿè®¡
          echo "## Changed Files Summary" >> $GITHUB_STEP_SUMMARY
          git diff --stat origin/${{ github.base_ref }}...HEAD >> $GITHUB_STEP_SUMMARY

      # ç¬¬äº”æ­¥ï¼šæ£€æŸ¥æ˜¯å¦å­˜åœ¨åˆå¹¶å†²çª
      - name: Check for conflicts
        run: |
          git fetch origin ${{ github.base_ref }}
          
          # å°è¯•æ¨¡æ‹Ÿåˆå¹¶ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å†²çª
          if ! git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) origin/${{ github.base_ref }} HEAD > /tmp/merge-result 2>&1; then
            echo "âŒ Merge simulation failed"
            cat /tmp/merge-result
            exit 1
          fi
          
          # æ£€æŸ¥åˆå¹¶ç»“æœä¸­æ˜¯å¦åŒ…å«å†²çªæ ‡è®°
          if grep -q '<<<<<<<' /tmp/merge-result; then
            echo "âŒ This PR has merge conflicts. Please resolve them before merging."
            echo "å†²çªæ–‡ä»¶ï¼š"
            grep -B 2 '<<<<<<<' /tmp/merge-result | grep -E '^\+\+\+' || true
            exit 1
          else
            echo "âœ… No merge conflicts detected"
          fi

  # Job 5: æ±‡æ€»æ£€æŸ¥ç»“æœ
  summary:
    name: Check Summary
    runs-on: ubuntu-latest
    needs: [build, test-windows-package, test-macos-package, code-quality, pr-validation]
    if: always()

    steps:
      # ç”Ÿæˆæ£€æŸ¥ç»“æœæ±‡æ€»æŠ¥å‘Š
      - name: Generate check summary
        run: |
          # å°†æ£€æŸ¥ç»“æœå†™å…¥ GitHub Step Summaryï¼ˆåœ¨ Actions é¡µé¢æ˜¾ç¤ºï¼‰
          echo "## ğŸ” PR Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR #${{ github.event.pull_request.number }}**: ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ£€æŸ¥ç»“æœè¡¨æ ¼
          echo "| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯¦æƒ… |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|------|" >> $GITHUB_STEP_SUMMARY
          
          # Build ç»“æœ
          if [[ "${{ needs.build.result }}" == "success" ]]; then
            echo "| ğŸ—ï¸ æ„å»ºå’Œæµ‹è¯• | âœ… é€šè¿‡ | JAR æ„å»ºæˆåŠŸï¼Œå•å…ƒæµ‹è¯•é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ—ï¸ æ„å»ºå’Œæµ‹è¯• | âŒ å¤±è´¥ | è¯·æ£€æŸ¥æ„å»ºæˆ–æµ‹è¯•æ—¥å¿— |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Windows æ‰“åŒ…æµ‹è¯•ç»“æœ
          if [[ "${{ needs.test-windows-package.result }}" == "success" ]]; then
            echo "| ğŸªŸ Windows æ‰“åŒ… | âœ… é€šè¿‡ | EXE å®‰è£…åŒ…å’Œä¾¿æºç‰ˆæ‰“åŒ…æˆåŠŸï¼Œå¯åŠ¨æµ‹è¯•é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.test-windows-package.result }}" == "skipped" ]]; then
            echo "| ğŸªŸ Windows æ‰“åŒ… | â­ï¸ è·³è¿‡ | å› å‰ç½®ä»»åŠ¡å¤±è´¥è€Œè·³è¿‡ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸªŸ Windows æ‰“åŒ… | âŒ å¤±è´¥ | æ‰“åŒ…æˆ–å¯åŠ¨æµ‹è¯•å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # macOS æ‰“åŒ…æµ‹è¯•ç»“æœ
          if [[ "${{ needs.test-macos-package.result }}" == "success" ]]; then
            echo "| ğŸ macOS æ‰“åŒ… | âœ… é€šè¿‡ | App bundle æ‰“åŒ…æˆåŠŸï¼Œå¯åŠ¨æµ‹è¯•é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.test-macos-package.result }}" == "skipped" ]]; then
            echo "| ğŸ macOS æ‰“åŒ… | â­ï¸ è·³è¿‡ | å› å‰ç½®ä»»åŠ¡å¤±è´¥è€Œè·³è¿‡ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ macOS æ‰“åŒ… | âŒ å¤±è´¥ | æ‰“åŒ…æˆ–å¯åŠ¨æµ‹è¯•å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Code Quality ç»“æœ
          if [[ "${{ needs.code-quality.result }}" == "success" ]]; then
            echo "| ğŸ“Š ä»£ç è´¨é‡ | âœ… é€šè¿‡ | ç¼–è¯‘æˆåŠŸï¼Œä»£ç è§„èŒƒç¬¦åˆè¦æ±‚ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ“Š ä»£ç è´¨é‡ | âŒ å¤±è´¥ | è¯·æ£€æŸ¥ç¼–è¯‘é”™è¯¯æˆ–ä»£ç è§„èŒƒé—®é¢˜ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # PR Validation ç»“æœ
          if [[ "${{ needs.pr-validation.result }}" == "success" ]]; then
            echo "| ğŸ“‹ PR è§„èŒƒ | âœ… é€šè¿‡ | æ ‡é¢˜ã€æè¿°ç¬¦åˆè§„èŒƒï¼Œæ— å†²çª |" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.pr-validation.result }}" == "skipped" ]]; then
            echo "| ğŸ“‹ PR è§„èŒƒ | â­ï¸ è·³è¿‡ | Dependabot è‡ªåŠ¨åŒ– PRï¼Œè·³è¿‡éªŒè¯ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ“‹ PR è§„èŒƒ | âŒ å¤±è´¥ | è¯·æ£€æŸ¥æ ‡é¢˜ã€æè¿°æˆ–è§£å†³åˆå¹¶å†²çª |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ ¹æ®æ£€æŸ¥ç»“æœç»™å‡ºä¸åŒçš„æ¶ˆæ¯
          # pr-validation å¯èƒ½æ˜¯ success æˆ– skippedï¼ˆdependabot è·³è¿‡ï¼‰ï¼Œéƒ½è§†ä¸ºé€šè¿‡
          if [[ "${{ needs.build.result }}" == "success" ]] && \
             [[ "${{ needs.test-windows-package.result }}" == "success" ]] && \
             [[ "${{ needs.test-macos-package.result }}" == "success" ]] && \
             [[ "${{ needs.code-quality.result }}" == "success" ]] && \
             ( [[ "${{ needs.pr-validation.result }}" == "success" ]] || [[ "${{ needs.pr-validation.result }}" == "skipped" ]] ); then
            echo "### âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‰ æ­å–œï¼æ­¤ PR å·²é€šè¿‡ä»¥ä¸‹éªŒè¯ï¼š" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… JAR æ„å»ºå’Œæµ‹è¯•" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Windows åº”ç”¨æ‰“åŒ…å’Œå¯åŠ¨æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… macOS åº”ç”¨æ‰“åŒ…å’Œå¯åŠ¨æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… ä»£ç è´¨é‡æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… PR è§„èŒƒéªŒè¯" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ­¤ PR å·²å‡†å¤‡å¥½è¿›è¡Œä»£ç å®¡æŸ¥å’Œåˆå¹¶ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ éƒ¨åˆ†æ£€æŸ¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è¯·ä¿®å¤ä»¥ä¸‹é—®é¢˜åé‡æ–°æäº¤ï¼š" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          
            # åˆ—å‡ºå¤±è´¥çš„æ£€æŸ¥é¡¹
            [[ "${{ needs.build.result }}" != "success" ]] && echo "- ğŸ—ï¸ æ„å»ºå’Œæµ‹è¯•å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            [[ "${{ needs.test-windows-package.result }}" == "failure" ]] && echo "- ğŸªŸ Windows æ‰“åŒ…/å¯åŠ¨æµ‹è¯•å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            [[ "${{ needs.test-macos-package.result }}" == "failure" ]] && echo "- ğŸ macOS æ‰“åŒ…/å¯åŠ¨æµ‹è¯•å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            [[ "${{ needs.code-quality.result }}" != "success" ]] && echo "- ğŸ“Š ä»£ç è´¨é‡æ£€æŸ¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            [[ "${{ needs.pr-validation.result }}" == "failure" ]] && echo "- ğŸ“‹ PR è§„èŒƒéªŒè¯å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ’¡ **æç¤º**: ç‚¹å‡»ä¸Šæ–¹å¤±è´¥çš„ Job æŸ¥çœ‹è¯¦ç»†æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“ **è¯´æ˜**: æ‰“åŒ…æµ‹è¯•ç¡®ä¿åº”ç”¨åœ¨ç›®æ ‡å¹³å°èƒ½æ­£å¸¸å¯åŠ¨è¿è¡Œ" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

