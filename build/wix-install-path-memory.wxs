<?xml version="1.0" encoding="UTF-8"?>
<!--
  WiX Fragment：安装路径记忆功能
  功能：记住用户上次选择的安装路径

  重要说明：
  - 此文件是一个 Fragment，不能替换 jpackage 生成的 main.wxs
  - 应该作为补充文件（例如 install-dir-patch.wxs）添加到 resource-dir
  - jpackage 会自动编译所有 .wxs 文件并链接它们

  工作原理（双重策略）：
  1. RegistrySearch: 从自定义注册表位置读取上次的安装路径
     位置: HKCU\Software\Laker\EasyPostman\InstallDir
  2. ComponentSearch: 如果上面没找到，通过组件 GUID 查找已安装的组件路径
  3. RegistryValue: 将当前安装路径保存到注册表（策略1的位置）
  4. Permanent="yes": 卸载后保留注册表项，确保重新安装时能记住路径

  注册表说明：
  - Windows Installer 会在 HKCU\Software\Laker\EasyPostman\{版本号}\RM_Rxxxxxx 保存安装路径
  - 但这些注册表项会在卸载时被删除，且路径结构复杂（包含随机 ID）
  - 因此我们使用自定义的 InstallDir 注册表项来持久化保存路径

  使用方法：
  - 本地构建: build/win.bat 会自动复制此文件为 install-dir-patch.wxs
  - CI/CD: .github/workflows/*.yml 会复制此文件为 install-dir-patch.wxs
-->
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Fragment>
    <!-- 从注册表读取上次的安装路径 -->
    <!--
      问题分析：
      Windows Installer 在注册表中保存的路径结构为：
      HKCU\Software\Laker\EasyPostman\{版本号}\RM_{随机ID} = "安装路径"

      解决方案：
      1. 首先尝试读取我们自己保存的 InstallDir
      2. 如果没有找到，通过 ComponentSearch 查找已安装的组件路径
    -->

    <!-- 方法1: 读取我们自定义保存的安装路径（持久化保存，卸载后也保留） -->
    <Property Id="PREVIOUSINSTALLDIR" Secure="yes">
      <RegistrySearch Id="RememberInstallDir"
                      Type="directory"
                      Root="HKCU"
                      Key="Software\Laker\EasyPostman"
                      Name="InstallDir" />
    </Property>

    <!-- 方法2: 通过 ComponentSearch 查找已安装的组件（如果存在旧版本） -->
    <Property Id="COMPONENTINSTALLDIR" Secure="yes">
      <ComponentSearch Id="FindComponent" Guid="28607609-97b7-4212-9285-04ef64a4946d" Type="directory" />
    </Property>

    <!-- 设置 INSTALLDIR: 优先使用 PREVIOUSINSTALLDIR，如果没有则使用 COMPONENTINSTALLDIR -->
    <SetProperty Id="INSTALLDIR" Value="[PREVIOUSINSTALLDIR]" Before="AppSearch" Sequence="both">
      <![CDATA[PREVIOUSINSTALLDIR]]>
    </SetProperty>

    <SetProperty Id="INSTALLDIR" Value="[COMPONENTINSTALLDIR]" Before="AppSearch" Sequence="both">
      <![CDATA[NOT PREVIOUSINSTALLDIR AND COMPONENTINSTALLDIR]]>
    </SetProperty>

    <!-- 将安装路径保存到注册表的组件 -->
    <!-- Permanent="yes" 确保卸载后保留注册表项，重新安装时能记住路径 -->
    <DirectoryRef Id="INSTALLDIR">
      <Component Id="RememberInstallDirComponent" Guid="28607609-97b7-4212-9285-04ef64a4946d" Permanent="yes">
        <RegistryKey Root="HKCU" Key="Software\Laker\EasyPostman">
          <RegistryValue Type="string" Name="InstallDir" Value="[INSTALLDIR]" KeyPath="yes"/>
        </RegistryKey>
      </Component>
    </DirectoryRef>

    <!--
      注意事项：
      - 我们只在这里定义组件，jpackage 会自动将 DirectoryRef Id="INSTALLDIR" 中的组件
        包含到主 Feature 中（在 MSI 生成时）
      - 不要在 Fragment 中使用 FeatureRef，否则会导致编译错误
    -->
  </Fragment>
</Wix>

