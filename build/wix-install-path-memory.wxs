<?xml version="1.0" encoding="UTF-8"?>
<!--
  WiX Fragment：安装路径记忆功能
  功能：记住用户上次选择的安装路径

  重要说明：
  - 此文件是一个 Fragment，不能替换 jpackage 生成的 main.wxs
  - 应该作为补充文件（例如 install-dir-patch.wxs）添加到 resource-dir
  - jpackage 会自动编译所有 .wxs 文件并链接它们

  工作原理：
  1. RegistrySearch: 从注册表读取上次的安装路径
  2. RegistryValue: 将当前安装路径保存到注册表
  3. 注册表位置: HKCU\Software\Laker\EasyPostman\InstallDir
  4. Permanent="yes": 卸载后保留注册表项，确保重新安装时能记住路径

  使用方法：
  - 本地构建: build/win.bat 会自动复制此文件为 install-dir-patch.wxs
  - CI/CD: .github/workflows/*.yml 会复制此文件为 install-dir-patch.wxs
-->
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Fragment>
    <!-- 从注册表读取上次的安装路径 -->
    <!-- Secure="yes" 确保该属性可以在提升权限后使用 -->
    <!-- Type="directory" 确保路径有效且格式正确 -->
    <Property Id="INSTALLDIR" Secure="yes">
      <RegistrySearch Id="RememberInstallDir"
                      Type="directory"
                      Root="HKCU"
                      Key="Software\Laker\EasyPostman"
                      Name="InstallDir" />
    </Property>

    <!-- 将安装路径保存到注册表的组件 -->
    <!-- Permanent="yes" 确保卸载后保留注册表项，重新安装时能记住路径 -->
    <DirectoryRef Id="INSTALLDIR">
      <Component Id="RememberInstallDirComponent" Guid="28607609-97b7-4212-9285-04ef64a4946d" Permanent="yes">
        <RegistryKey Root="HKCU" Key="Software\Laker\EasyPostman">
          <RegistryValue Type="string" Name="InstallDir" Value="[INSTALLDIR]" KeyPath="yes"/>
        </RegistryKey>
      </Component>
    </DirectoryRef>

    <!--
      注意事项：
      - 我们只在这里定义组件，jpackage 会自动将 DirectoryRef Id="INSTALLDIR" 中的组件
        包含到主 Feature 中（在 MSI 生成时）
      - 不要在 Fragment 中使用 FeatureRef，否则会导致编译错误
    -->
  </Fragment>
</Wix>

