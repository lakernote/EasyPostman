name: Release Buildï¼ˆå‘å¸ƒæ„å»ºï¼‰

permissions:
  contents: write

on:
  release:
    types: [created]  # å½“åˆ›å»ºæ–°çš„ Release æ—¶è§¦å‘
  workflow_dispatch: {}  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'
  JLINK_MODULES: 'java.base,java.desktop,java.logging,jdk.unsupported,java.naming,java.net.http,java.prefs,java.sql,java.security.sasl,java.security.jgss,jdk.crypto.ec,java.management,java.management.rmi,jdk.crypto.cryptoki'
  JAVA_OPTIONS: '-Xms256m|-Xmx512m|-Dfile.encoding=UTF-8'

jobs:
  # æå–ç‰ˆæœ¬å·ï¼Œä¾›æ‰€æœ‰ job å¤ç”¨
  get-version:
    name: Get Versionï¼ˆè·å–ç‰ˆæœ¬å·ï¼‰
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract_version.outputs.version }}
    steps:
      - name: Checkoutï¼ˆæ£€å‡ºä»£ç ï¼‰
        uses: actions/checkout@v4

      - name: Setup Javaï¼ˆé…ç½® Javaï¼‰
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Extract versionï¼ˆæå–ç‰ˆæœ¬å·ï¼‰
        id: extract_version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "Version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  # æ„å»º Fat JARï¼ˆè·¨å¹³å°ï¼‰ï¼Œä¾›æ‰€æœ‰å¹³å°å¤ç”¨
  build-jar-artifact:
    name: Build Fat JARï¼ˆæ„å»ºè·¨å¹³å° JARï¼‰
    runs-on: ubuntu-latest
    needs: [get-version]
    steps:
      - name: Checkoutï¼ˆæ£€å‡ºä»£ç ï¼‰
        uses: actions/checkout@v4

      - name: Setup Javaï¼ˆé…ç½® Javaï¼‰
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Build with Mavenï¼ˆä½¿ç”¨ Maven æ„å»º Fat JARï¼‰
        run: mvn -B clean package -DskipTests

      - name: Upload JAR for reuseï¼ˆä¸Šä¼  JAR ä¾›å…¶ä»– job å¤ç”¨ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: target/easy-postman-${{ needs.get-version.outputs.version }}.jar
          retention-days: 1

  build-windows:
    name: Build Windows MSIï¼ˆæ„å»º Windows å®‰è£…åŒ…ï¼‰
    runs-on: windows-latest
    needs: [get-version, build-jar-artifact]

    steps:
      - name: Checkoutï¼ˆæ£€å‡ºä»£ç ï¼‰
        uses: actions/checkout@v4

      - name: Setup Javaï¼ˆé…ç½® Javaï¼‰
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}

      - name: Download Fat JARï¼ˆä¸‹è½½è·¨å¹³å° Fat JARï¼‰
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: target

      - name: Install WiX (for jpackage)ï¼ˆå®‰è£… WiX å·¥å…·é›†ï¼Œç”¨äºåˆ›å»º MSIï¼‰
        shell: pwsh
        run: |
          choco install wixtoolset -y
          if (Get-Command refreshenv -ErrorAction SilentlyContinue) { 
            refreshenv 
          } else {
            $refreshScript = "$env:ChocolateyInstall\lib\refreshenv\tools\RefreshEnv.ps1"
            if (Test-Path $refreshScript) { & $refreshScript }
          }

      - name: Create runtime with jlinkï¼ˆä½¿ç”¨ jlink åˆ›å»º Windows ç²¾ç®€ JREï¼‰
        shell: pwsh
        run: |
          $runtimeDir = "target\runtime"
          if (Test-Path $runtimeDir) { Remove-Item -Recurse -Force $runtimeDir }
          
          # åˆ›å»º Windows å¹³å°çš„ JRE
          jlink `
            --add-modules $env:JLINK_MODULES `
            --strip-debug `
            --no-header-files `
            --no-man-pages `
            --compress=2 `
            --output $runtimeDir

      - name: Prepare dist-inputï¼ˆå‡†å¤‡æ‰“åŒ…è¾“å…¥ç›®å½•ï¼‰
        shell: pwsh
        run: |
          $version = "${{ needs.get-version.outputs.version }}"
          $jarName = "easy-postman-$version.jar"
          
          $distInputDir = "target\dist-input"
          if (Test-Path $distInputDir) { Remove-Item -Recurse -Force $distInputDir }
          New-Item -ItemType Directory -Path $distInputDir | Out-Null
          
          Copy-Item "target\$jarName" -Destination $distInputDir

      - name: Copy WiX configuration to remember installation pathï¼ˆå¤åˆ¶ WiX é…ç½®ä»¥è®°ä½å®‰è£…è·¯å¾„ï¼‰
        shell: pwsh
        run: |
          $resourceDir = "target\jpackage-resources"
          if (-not (Test-Path $resourceDir)) { New-Item -ItemType Directory -Path $resourceDir | Out-Null }
          
          # å¤åˆ¶ overrides.wxiï¼ˆjpackage ä¼šè‡ªåŠ¨ include è¿™ä¸ªæ–‡ä»¶ï¼‰
          # æ–‡ä»¶å†…å®¹ï¼š
          # 1. Property + RegistrySearchï¼ˆè¯»å–ä¸Šæ¬¡å®‰è£…è·¯å¾„ï¼‰
          # 2. SetPropertyï¼ˆè®¾ç½® INSTALLDIR åˆå§‹å€¼ï¼‰
          # 3. DirectoryRef + Componentï¼ˆå®šä¹‰ä¿å­˜è·¯å¾„çš„æ³¨å†Œè¡¨ç»„ä»¶ï¼‰
          # 4. ComponentGroupï¼ˆå°†ç»„ä»¶åŒ…è£…æˆç»„ï¼Œæ–¹ä¾¿åœ¨ Feature ä¸­å¼•ç”¨ï¼‰
          $wixOverrides = "build\overrides.wxi"
          if (-not (Test-Path $wixOverrides)) {
            Write-Host "âŒ overrides.wxi not found: $wixOverrides"
            exit 1
          }
          
          Copy-Item $wixOverrides -Destination "$resourceDir\overrides.wxi"
          Write-Host "âœ… Copied overrides.wxi (install path memory enabled)"
          Write-Host "   ğŸ“¦ Contains: Property, SetProperty, Component, ComponentGroup"
          Write-Host "   ğŸ”— jpackage will include via: <?include overrides.wxi ?>"
          
          # éªŒè¯æ–‡ä»¶
          if (Test-Path "$resourceDir\overrides.wxi") {
            $fileSize = (Get-Item "$resourceDir\overrides.wxi").Length
            Write-Host "âœ… overrides.wxi file size: $fileSize bytes"
            
            # æ˜¾ç¤ºæ–‡ä»¶å†…å®¹é¢„è§ˆ
            Write-Host "`nğŸ“„ Content preview:"
            Get-Content "$resourceDir\overrides.wxi" -Head 20 | ForEach-Object { Write-Host "   $_" }
            
            # æ£€æŸ¥å…³é”®å…ƒç´ 
            $content = Get-Content "$resourceDir\overrides.wxi" -Raw
            $hasProperty = $content -match 'PREVIOUSINSTALLDIR'
            $hasComponent = $content -match 'RememberInstallDirComponent'
            $hasGroup = $content -match 'InstallPathMemoryGroup'
            
            Write-Host "`nğŸ” Structure validation:"
            Write-Host "   Property 'PREVIOUSINSTALLDIR': $(if ($hasProperty) {'âœ…'} else {'âŒ'})"
            Write-Host "   Component 'RememberInstallDirComponent': $(if ($hasComponent) {'âœ…'} else {'âŒ'})"
            Write-Host "   ComponentGroup 'InstallPathMemoryGroup': $(if ($hasGroup) {'âœ…'} else {'âŒ'})"
            
            if (-not ($hasProperty -and $hasComponent -and $hasGroup)) {
              Write-Host "âŒ overrides.wxi is missing required elements"
              exit 1
            }
          } else {
            Write-Host "âŒ Failed to copy overrides.wxi"
            exit 1
          }

      - name: Create MSI with jpackageï¼ˆä½¿ç”¨ jpackage åˆ›å»º MSI å®‰è£…åŒ…ï¼‰
        shell: pwsh
        continue-on-error: true
        id: jpackage_build
        run: |
          $version = "${{ needs.get-version.outputs.version }}"
          $jarName = "easy-postman-$version.jar"
          $outDir = "dist"
          $tempDir = "target\jpackage-temp"
          
          if (-not (Test-Path $outDir)) { New-Item -ItemType Directory -Path $outDir | Out-Null }
          
          # è§£æ Java é€‰é¡¹
          $javaOpts = $env:JAVA_OPTIONS -split '\|'
          
          # åˆ›å»º Windows MSI å®‰è£…åŒ…
          jpackage `
            --type msi `
            --input target\dist-input `
            --main-jar $jarName `
            --main-class com.laker.postman.App `
            --runtime-image target\runtime `
            --dest $outDir `
            --temp $tempDir `
            --icon assets\win\EasyPostman.ico `
            --name EasyPostman `
            --app-version $version `
            --vendor "Laker" `
            --copyright "Â© 2025 Laker" `
            --win-shortcut `
            --win-menu `
            --description "A modern API testing tool similar to Postman" `
            --win-upgrade-uuid "28607609-97b7-4212-9285-04ef64a4946c" `
            --win-dir-chooser `
            --win-per-user-install `
            --win-menu-group "EasyTools" `
            --win-help-url "https://gitee.com/lakernote/easy-postman" `
            --resource-dir "target\jpackage-resources" `
            --java-options $javaOpts[0] `
            --java-options $javaOpts[1] `
            --java-options $javaOpts[2] `
            --java-options "-Djavax.accessibility.assistive_technologies="
          
          $jpackageExitCode = $LASTEXITCODE
          Write-Host "jpackage exit code: $jpackageExitCode"
          
          # Check if MSI was created
          $oldMsiName = "EasyPostman-$version.msi"
          if (Test-Path "dist\$oldMsiName") {
            # é‡å‘½åæ·»åŠ å¹³å°å’Œæ¶æ„æ ‡è¯†ï¼ˆç¬¦åˆå‘½åè§„èŒƒï¼‰
            $newMsiName = "EasyPostman-$version-windows-x64.msi"
            Rename-Item -Path "dist\$oldMsiName" -NewName $newMsiName
            Write-Host "âœ… Renamed to: $newMsiName"
            exit 0
          } else {
            Write-Host "âš ï¸  MSI not created, will attempt manual build"
            exit 1
          }

      - name: Debug - Inspect jpackage temp directoryï¼ˆè°ƒè¯• - æ£€æŸ¥ jpackage ä¸´æ—¶ç›®å½•ï¼‰
        if: steps.jpackage_build.outcome == 'failure'
        shell: pwsh
        run: |
          Write-Host "ğŸ” Checking WiX files in jpackage temp directory..."
          
          $tempDir = "target\jpackage-temp"
          
          if (Test-Path $tempDir) {
            Write-Host "ğŸ“‚ Temp directory exists: $tempDir"
            
            Write-Host "`nğŸ” Looking for .wxs and .wxi files..."
            $wixFiles = Get-ChildItem $tempDir -Recurse -Include "*.wxs","*.wxi"
            
            if ($wixFiles.Count -gt 0) {
              Write-Host "âœ… Found $($wixFiles.Count) WiX file(s):"
              foreach ($file in $wixFiles) {
                Write-Host "   ğŸ“„ $($file.FullName) ($($file.Length) bytes)"
              }
              
              # æ£€æŸ¥ main.wxs
              $mainWxs = Get-ChildItem $tempDir -Recurse -Filter "main.wxs" | Select-Object -First 1
              if ($mainWxs) {
                Write-Host "`nğŸ“„ Found main.wxs:"
                Write-Host "   Path: $($mainWxs.FullName)"
                Write-Host "   Size: $($mainWxs.Length) bytes"
                
                Write-Host "`nğŸ“„ Content preview (first 60 lines):"
                Get-Content $mainWxs.FullName -Head 60 | ForEach-Object { Write-Host $_ }
                
                Write-Host "`nğŸ” Checking for overrides.wxi include:"
                $includeCheck = Select-String -Path $mainWxs.FullName -Pattern "overrides.wxi" -AllMatches
                if ($includeCheck) {
                  Write-Host "   âœ… overrides.wxi is included in main.wxs"
                  $includeCheck | ForEach-Object { Write-Host "      $_" }
                } else {
                  Write-Host "   âš ï¸  overrides.wxi include not found in main.wxs"
                }
                
                Write-Host "`nğŸ” Checking for our custom Property definitions:"
                $propertyCheck = Select-String -Path $mainWxs.FullName -Pattern "PREVIOUSINSTALLDIR|RememberInstallDirComponent" -AllMatches
                if ($propertyCheck) {
                  Write-Host "   âœ… Custom Property/Component found in main.wxs:"
                  $propertyCheck | ForEach-Object { Write-Host "      $_" }
                } else {
                  Write-Host "   âš ï¸  Custom Property/Component not found (may be in overrides.wxi)"
                }
                
                Write-Host "`nğŸ” Searching for Feature section:"
                $featureCheck = Select-String -Path $mainWxs.FullName -Pattern "<Feature|</Feature>|ComponentRef" -AllMatches
                if ($featureCheck) {
                  Write-Host "   âœ… Feature section found:"
                  $featureCheck | Select-Object -First 10 | ForEach-Object { Write-Host "      $_" }
                } else {
                  Write-Host "   âš ï¸  No Feature section found in main.wxs"
                }
              }
              
              # æ£€æŸ¥ overrides.wxi
              $overridesWxi = Get-ChildItem $tempDir -Recurse -Filter "overrides.wxi" | Select-Object -First 1
              if ($overridesWxi) {
                Write-Host "`nğŸ“„ Found overrides.wxi:"
                Write-Host "   Path: $($overridesWxi.FullName)"
                Write-Host "   Size: $($overridesWxi.Length) bytes"
                Write-Host "`n   Content:"
                Get-Content $overridesWxi.FullName | ForEach-Object { Write-Host "   $_" }
              } else {
                Write-Host "`nâŒ overrides.wxi not found in temp directory!"
              }
            } else {
              Write-Host "âŒ No WiX files found in temp directory"
            }
          } else {
            Write-Host "âŒ Temp directory does not exist: $tempDir"
          }

      - name: Manual build - Patch and compile WiX filesï¼ˆæ‰‹åŠ¨æ„å»º - ä¿®è¡¥å¹¶ç¼–è¯‘ WiX æ–‡ä»¶ï¼‰
        if: steps.jpackage_build.outcome == 'failure'
        shell: pwsh
        run: |
          Write-Host "ğŸ”§ Attempting manual WiX build..."
          Write-Host ""
          Write-Host "â„¹ï¸  Background: Why manual patching is needed?"
          Write-Host "   1. overrides.wxi defines Component and ComponentGroup"
          Write-Host "   2. jpackage includes overrides.wxi in main.wxs"
          Write-Host "   3. BUT: Components must be referenced in <Feature> to be installed"
          Write-Host "   4. We need to add: <ComponentGroupRef Id='InstallPathMemoryGroup' />"
          Write-Host ""
          $version = "${{ needs.get-version.outputs.version }}"
          $configDir = "target\jpackage-temp\config"
          $mainWxsPath = "$configDir\main.wxs"
          
          # æ£€æŸ¥ config ç›®å½•æ˜¯å¦å­˜åœ¨
          if (-not (Test-Path $configDir)) {
            Write-Host "âŒ Config directory not found. jpackage did not generate WiX files."
            exit 1
          }
          
          # ä¿®è¡¥ main.wxs æ·»åŠ  ComponentRef æˆ– ComponentGroupRef
          if (Test-Path $mainWxsPath) {
            Write-Host "`nğŸ“ Patching main.wxs to add install path memory component..."
            
            $content = Get-Content -Path $mainWxsPath -Raw
            
            # æ£€æŸ¥æ˜¯å¦å·²ç»æ‰“è¿‡è¡¥ä¸ï¼ˆæ£€æŸ¥ä¸¤ç§å¼•ç”¨æ–¹å¼ï¼‰
            if ($content -match 'RememberInstallDirComponent' -or $content -match 'InstallPathMemoryGroup') {
              Write-Host "âœ… main.wxs already contains install path memory component reference"
            } else {
              Write-Host "ğŸ” Searching for Feature section..."
              
              # ä¼˜å…ˆå°è¯•ä½¿ç”¨ ComponentGroupRefï¼ˆæ›´ç®€æ´ï¼Œæ¨èæ–¹å¼ï¼‰
              $pattern = '([\s]+)(</Feature>)'
              $replacement = '$1  <!-- Custom: Install path memory (defined in overrides.wxi) -->' + "`r`n" + 
                           '$1  <ComponentGroupRef Id="InstallPathMemoryGroup" />' + "`r`n" + 
                           '$1$2'
              
              $newContent = $content -replace $pattern, $replacement
              
              if ($newContent -ne $content) {
                $newContent | Set-Content -Path $mainWxsPath -NoNewline
                Write-Host "âœ… Successfully added ComponentGroupRef to Feature section"
                Write-Host "   <ComponentGroupRef Id='InstallPathMemoryGroup' />"
              } else {
                Write-Host "âš ï¸  Could not find </Feature> tag to patch"
                Write-Host "ğŸ” Trying alternative pattern..."
                
                # å¤‡ç”¨æ–¹æ¡ˆï¼šå°è¯•æŸ¥æ‰¾ Feature çš„å…¶ä»–æ¨¡å¼
                $pattern2 = '(<Feature[^>]*>)(.*?)(</Feature>)'
                if ($content -match $pattern2) {
                  Write-Host "âœ… Found Feature with alternative pattern"
                  # ä½¿ç”¨ç›´æ¥çš„ ComponentRef
                  $pattern3 = '([\s]+)(</Feature>)'
                  $replacement3 = '$1  <!-- Custom: Install path memory component -->' + "`r`n" + 
                                '$1  <ComponentRef Id="RememberInstallDirComponent" />' + "`r`n" + 
                                '$1$2'
                  $newContent = $content -replace $pattern3, $replacement3
                  if ($newContent -ne $content) {
                    $newContent | Set-Content -Path $mainWxsPath -NoNewline
                    Write-Host "âœ… Added ComponentRef (fallback method)"
                  } else {
                    Write-Host "âŒ Failed to patch main.wxs"
                    Write-Host "ğŸ” Dumping main.wxs structure for debugging..."
                    Write-Host ($content -split "`n" | Select-Object -First 60 | Out-String)
                    exit 1
                  }
                } else {
                  Write-Host "âŒ No Feature section found in main.wxs"
                  Write-Host "ğŸ” Dumping main.wxs structure for debugging..."
                  Write-Host ($content -split "`n" | Select-Object -First 60 | Out-String)
                  exit 1
                }
              }
            }
          } else {
            Write-Host "âŒ main.wxs not found at: $mainWxsPath"
            exit 1
          }
          
          # æŸ¥æ‰¾ WiX Toolset
          Write-Host "`nğŸ” Locating WiX Toolset..."
          $wixPath = "${env:ProgramFiles(x86)}\WiX Toolset v3.11\bin"
          if (-not (Test-Path $wixPath)) {
            $wixPath = "${env:ProgramFiles}\WiX Toolset v3.11\bin"
          }
          if (-not (Test-Path $wixPath)) {
            Write-Host "âŒ WiX Toolset not found"
            exit 1
          }
          
          Write-Host "âœ… Found WiX at: $wixPath"
          
          # ç¼–è¯‘ WiX æºæ–‡ä»¶
          Write-Host "`nğŸ”¨ Compiling WiX sources..."
          $wixSources = Get-ChildItem $configDir -Filter "*.wxs"
          Write-Host "   Found $($wixSources.Count) .wxs file(s)"
          
          foreach ($wxs in $wixSources) {
            $objFile = Join-Path $configDir "$($wxs.BaseName).wixobj"
            Write-Host "   ğŸ“„ Compiling $($wxs.Name)..."
            
            & "$wixPath\candle.exe" -nologo -arch x64 -out $objFile $wxs.FullName
            
            if ($LASTEXITCODE -ne 0) {
              Write-Host "âŒ Failed to compile $($wxs.Name)"
              exit 1
            }
          }
          
          Write-Host "âœ… All WiX sources compiled successfully"
          
          # é“¾æ¥ç”Ÿæˆ MSI
          Write-Host "`nğŸ”— Linking WiX objects to create MSI..."
          $wixObjs = Get-ChildItem $configDir -Filter "*.wixobj" | ForEach-Object { $_.FullName }
          Write-Host "   Found $($wixObjs.Count) .wixobj file(s)"
          
          $msiOutput = "dist\EasyPostman-$version.msi"
          
          & "$wixPath\light.exe" -nologo -ext WixUIExtension -ext WixUtilExtension -out $msiOutput @wixObjs
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "âŒ Failed to link MSI"
            exit 1
          }
          
          Write-Host "âœ… MSI created successfully: $msiOutput"
          
          # é‡å‘½åä¸ºå¹³å°ç‰¹å®šæ–‡ä»¶å
          $newMsiName = "EasyPostman-$version-windows-x64.msi"
          Rename-Item -Path $msiOutput -NewName $newMsiName
          Write-Host "âœ… Renamed to: $newMsiName"

      - name: Verify MSI was createdï¼ˆéªŒè¯ MSI å·²åˆ›å»ºï¼‰
        shell: pwsh
        run: |
          $version = "${{ needs.get-version.outputs.version }}"
          $msiFile = "dist\EasyPostman-$version-windows-x64.msi"
          
          if (Test-Path $msiFile) {
            $size = (Get-Item $msiFile).Length
            $sizeMB = [math]::Round($size / 1MB, 2)
            Write-Host "âœ… MSI created successfully: $msiFile ($sizeMB MB)"
          } else {
            Write-Host "âŒ MSI file not found: $msiFile"
            Write-Host "ğŸ“‚ Contents of dist directory:"
            Get-ChildItem dist -Recurse | ForEach-Object { Write-Host "   $($_.FullName)" }
            exit 1
          }

      - name: Upload to Releaseï¼ˆä¸Šä¼ åˆ° GitHub Releaseï¼‰
        if: github.event_name == 'release'  # åªåœ¨ Release è§¦å‘æ—¶ä¸Šä¼ 
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.msi
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload as Artifactï¼ˆæ‰‹åŠ¨è§¦å‘æ—¶ä¸Šä¼ ä¸ºæ„å»ºäº§ç‰©ï¼‰
        if: github.event_name == 'workflow_dispatch'  # åªåœ¨æ‰‹åŠ¨è§¦å‘æ—¶ä¸Šä¼ ä¸º Artifact
        uses: actions/upload-artifact@v4
        with:
          name: EasyPostman-Windows-MSI
          path: dist/*.msi
          retention-days: 7  # ä¿ç•™ 7 å¤©

      - name: Upload MSI for Gitee syncï¼ˆä¸Šä¼  MSI ä¾› Gitee åŒæ­¥ä½¿ç”¨ï¼‰
        if: github.event_name == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: release-msi
          path: dist/*.msi
          retention-days: 1


  build-windows-portable:
    name: Build Windows Portableï¼ˆæ„å»º Windows ç»¿è‰²ç‰ˆï¼‰
    runs-on: windows-latest
    needs: [get-version, build-jar-artifact]

    steps:
      - name: Checkoutï¼ˆæ£€å‡ºä»£ç ï¼‰
        uses: actions/checkout@v4

      - name: Setup Javaï¼ˆé…ç½® Javaï¼‰
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}

      - name: Download Fat JARï¼ˆä¸‹è½½è·¨å¹³å° Fat JARï¼‰
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: target

      - name: Create runtime with jlinkï¼ˆä½¿ç”¨ jlink åˆ›å»º Windows ç²¾ç®€ JREï¼‰
        shell: pwsh
        run: |
          $runtimeDir = "target\runtime"
          if (Test-Path $runtimeDir) { Remove-Item -Recurse -Force $runtimeDir }
          
          jlink `
            --add-modules $env:JLINK_MODULES `
            --strip-debug `
            --no-header-files `
            --no-man-pages `
            --compress=2 `
            --output $runtimeDir

      - name: Prepare dist-inputï¼ˆå‡†å¤‡æ‰“åŒ…è¾“å…¥ç›®å½•ï¼‰
        shell: pwsh
        run: |
          $version = "${{ needs.get-version.outputs.version }}"
          $jarName = "easy-postman-$version.jar"
          
          $distInputDir = "target\dist-input"
          if (Test-Path $distInputDir) { Remove-Item -Recurse -Force $distInputDir }
          New-Item -ItemType Directory -Path $distInputDir | Out-Null
          
          Copy-Item "target\$jarName" -Destination $distInputDir

      - name: Create app-image with jpackageï¼ˆåˆ›å»ºåº”ç”¨é•œåƒï¼Œå…å®‰è£…ï¼‰
        shell: pwsh
        run: |
          $version = "${{ needs.get-version.outputs.version }}"
          $jarName = "easy-postman-$version.jar"
          $appImageDir = "target\app-image"
          
          if (Test-Path $appImageDir) { Remove-Item -Recurse -Force $appImageDir }
          
          # è§£æ Java é€‰é¡¹
          $javaOpts = $env:JAVA_OPTIONS -split '\|'
          
          # åˆ›å»ºåº”ç”¨é•œåƒï¼ˆapp-image ç±»å‹ï¼Œä¸æ˜¯å®‰è£…åŒ…ï¼‰
          jpackage `
            --type app-image `
            --input target\dist-input `
            --main-jar $jarName `
            --main-class com.laker.postman.App `
            --runtime-image target\runtime `
            --dest target `
            --icon assets\win\EasyPostman.ico `
            --name EasyPostman `
            --app-version $version `
            --vendor "Laker" `
            --copyright "Â© 2025 Laker" `
            --java-options $javaOpts[0] `
            --java-options $javaOpts[1] `
            --java-options $javaOpts[2] `
            --java-options "-Djavax.accessibility.assistive_technologies="

      - name: Package portable versionï¼ˆæ‰“åŒ…ç»¿è‰²ç‰ˆä¸º ZIPï¼‰
        shell: pwsh
        run: |
          $version = "${{ needs.get-version.outputs.version }}"
          $appImageDir = "target\EasyPostman"
          $zipName = "EasyPostman-$version-windows-x64-portable.zip"
          
          if (-not (Test-Path "dist")) { New-Item -ItemType Directory -Path "dist" | Out-Null }
          
          # åˆ›å»º .portable æ ‡è¯†æ–‡ä»¶ï¼Œç”¨äºè¿è¡Œæ—¶æ£€æµ‹ä¾¿æºç‰ˆ
          $portableMarker = Join-Path $appImageDir ".portable"
          "This is a portable version" | Out-File -FilePath $portableMarker -Encoding UTF8
          Write-Host "Created .portable marker file"
          
          # å‹ç¼©ä¸º ZIP
          Compress-Archive -Path $appImageDir -DestinationPath "dist\$zipName" -Force
          
          Write-Host "âœ… Created portable version: $zipName"

      - name: Upload to Releaseï¼ˆä¸Šä¼ åˆ° GitHub Releaseï¼‰
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*-portable.zip
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload as Artifactï¼ˆæ‰‹åŠ¨è§¦å‘æ—¶ä¸Šä¼ ä¸ºæ„å»ºäº§ç‰©ï¼‰
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: EasyPostman-Windows-Portable
          path: dist/*-portable.zip
          retention-days: 7

      - name: Upload Portable ZIP for Gitee syncï¼ˆä¸Šä¼ ä¾¿æºç‰ˆ ZIP ä¾› Gitee åŒæ­¥ä½¿ç”¨ï¼‰
        if: github.event_name == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: release-portable-zip
          path: dist/*-portable.zip
          retention-days: 1

  build-macos-intel:
    name: Build macOS Intel DMGï¼ˆæ„å»º macOS Intel ç‰ˆå®‰è£…åŒ…ï¼‰
    runs-on: macos-13  # Intel x86_64
    needs: [get-version, build-jar-artifact]

    steps:
      - name: Checkoutï¼ˆæ£€å‡ºä»£ç ï¼‰
        uses: actions/checkout@v4

      - name: Setup Javaï¼ˆé…ç½® Javaï¼‰
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}

      - name: Download Fat JARï¼ˆä¸‹è½½è·¨å¹³å° Fat JARï¼‰
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: target

      - name: Create runtime with jlinkï¼ˆä½¿ç”¨ jlink åˆ›å»º macOS Intel ç²¾ç®€ JREï¼‰
        run: |
          rm -rf target/runtime
          # åˆ›å»º macOS Intel å¹³å°çš„ JRE
          jlink \
            --add-modules ${{ env.JLINK_MODULES }} \
            --strip-debug \
            --no-header-files \
            --no-man-pages \
            --compress=2 \
            --output target/runtime

      - name: Prepare dist-inputï¼ˆå‡†å¤‡æ‰“åŒ…è¾“å…¥ç›®å½•ï¼‰
        run: |
          VERSION="${{ needs.get-version.outputs.version }}"
          JAR_NAME="easy-postman-$VERSION.jar"
          
          rm -rf target/dist-input
          mkdir -p target/dist-input
          cp target/$JAR_NAME target/dist-input/

      - name: Create DMG with jpackageï¼ˆä½¿ç”¨ jpackage åˆ›å»º DMG é•œåƒï¼‰
        run: |
          VERSION="${{ needs.get-version.outputs.version }}"
          JAR_NAME="easy-postman-$VERSION.jar"
          
          mkdir -p dist
          
          # è§£æ Java é€‰é¡¹
          IFS='|' read -ra JAVA_OPTS <<< "${{ env.JAVA_OPTIONS }}"
          
          # åˆ›å»º macOS Intel DMG
          jpackage \
            --input target/dist-input \
            --main-jar $JAR_NAME \
            --main-class com.laker.postman.App \
            --runtime-image target/runtime \
            --type dmg \
            --name "EasyPostman" \
            --app-version "$VERSION" \
            --dest dist \
            --icon assets/mac/EasyPostman.icns \
            --vendor "Laker" \
            --copyright "Â© 2025 Laker" \
            --java-options "${JAVA_OPTS[0]}" \
            --java-options "${JAVA_OPTS[1]}" \
            --java-options "${JAVA_OPTS[2]}"
          
          # é‡å‘½åä¸º Intel ç‰ˆæœ¬ï¼ˆä½¿ç”¨æ ‡å‡†æ¶æ„æ ‡è¯†ï¼‰
          mv dist/EasyPostman-$VERSION.dmg dist/EasyPostman-$VERSION-macos-x86_64.dmg
          echo "âœ… Created: EasyPostman-$VERSION-macos-x86_64.dmg"

      - name: Upload to Releaseï¼ˆä¸Šä¼ åˆ° GitHub Releaseï¼‰
        if: github.event_name == 'release'  # åªåœ¨ Release è§¦å‘æ—¶ä¸Šä¼ 
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*-macos-x86_64.dmg
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload as Artifactï¼ˆæ‰‹åŠ¨è§¦å‘æ—¶ä¸Šä¼ ä¸ºæ„å»ºäº§ç‰©ï¼‰
        if: github.event_name == 'workflow_dispatch'  # åªåœ¨æ‰‹åŠ¨è§¦å‘æ—¶ä¸Šä¼ ä¸º Artifact
        uses: actions/upload-artifact@v4
        with:
          name: EasyPostman-macOS-Intel-DMG
          path: dist/*-macos-x86_64.dmg
          retention-days: 7  # ä¿ç•™ 7 å¤©

      - name: Upload DMG for Gitee syncï¼ˆä¸Šä¼  DMG ä¾› Gitee åŒæ­¥ä½¿ç”¨ï¼‰
        if: github.event_name == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: release-dmg-intel
          path: dist/*-macos-x86_64.dmg
          retention-days: 1

  build-macos-arm:
    name: Build macOS Apple Silicon DMGï¼ˆæ„å»º macOS Apple Silicon ç‰ˆå®‰è£…åŒ…ï¼‰
    runs-on: macos-latest  # Apple Silicon (M1/M2/M3/M4)
    needs: [get-version, build-jar-artifact]

    steps:
      - name: Checkoutï¼ˆæ£€å‡ºä»£ç ï¼‰
        uses: actions/checkout@v4

      - name: Setup Javaï¼ˆé…ç½® Javaï¼‰
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}

      - name: Download Fat JARï¼ˆä¸‹è½½è·¨å¹³å° Fat JARï¼‰
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: target

      - name: Create runtime with jlinkï¼ˆä½¿ç”¨ jlink åˆ›å»º macOS ARM ç²¾ç®€ JREï¼‰
        run: |
          rm -rf target/runtime
          # åˆ›å»º macOS ARM å¹³å°çš„ JRE
          jlink \
            --add-modules ${{ env.JLINK_MODULES }} \
            --strip-debug \
            --no-header-files \
            --no-man-pages \
            --compress=2 \
            --output target/runtime

      - name: Prepare dist-inputï¼ˆå‡†å¤‡æ‰“åŒ…è¾“å…¥ç›®å½•ï¼‰
        run: |
          VERSION="${{ needs.get-version.outputs.version }}"
          JAR_NAME="easy-postman-$VERSION.jar"
          
          rm -rf target/dist-input
          mkdir -p target/dist-input
          cp target/$JAR_NAME target/dist-input/

      - name: Create DMG with jpackageï¼ˆä½¿ç”¨ jpackage åˆ›å»º DMG é•œåƒï¼‰
        run: |
          VERSION="${{ needs.get-version.outputs.version }}"
          JAR_NAME="easy-postman-$VERSION.jar"
          
          mkdir -p dist
          
          # è§£æ Java é€‰é¡¹
          IFS='|' read -ra JAVA_OPTS <<< "${{ env.JAVA_OPTIONS }}"
          
          # åˆ›å»º macOS Apple Silicon DMG
          jpackage \
            --input target/dist-input \
            --main-jar $JAR_NAME \
            --main-class com.laker.postman.App \
            --runtime-image target/runtime \
            --type dmg \
            --name "EasyPostman" \
            --app-version "$VERSION" \
            --dest dist \
            --icon assets/mac/EasyPostman.icns \
            --vendor "Laker" \
            --copyright "Â© 2025 Laker" \
            --java-options "${JAVA_OPTS[0]}" \
            --java-options "${JAVA_OPTS[1]}" \
            --java-options "${JAVA_OPTS[2]}"
          
          # é‡å‘½åä¸º ARM ç‰ˆæœ¬ï¼ˆä½¿ç”¨æ ‡å‡†æ¶æ„æ ‡è¯†ï¼‰
          mv dist/EasyPostman-$VERSION.dmg dist/EasyPostman-$VERSION-macos-arm64.dmg
          echo "âœ… Created: EasyPostman-$VERSION-macos-arm64.dmg"

      - name: Upload to Releaseï¼ˆä¸Šä¼ åˆ° GitHub Releaseï¼‰
        if: github.event_name == 'release'  # åªåœ¨ Release è§¦å‘æ—¶ä¸Šä¼ 
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*-macos-arm64.dmg
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload as Artifactï¼ˆæ‰‹åŠ¨è§¦å‘æ—¶ä¸Šä¼ ä¸ºæ„å»ºäº§ç‰©ï¼‰
        if: github.event_name == 'workflow_dispatch'  # åªåœ¨æ‰‹åŠ¨è§¦å‘æ—¶ä¸Šä¼ ä¸º Artifact
        uses: actions/upload-artifact@v4
        with:
          name: EasyPostman-macOS-ARM-DMG
          path: dist/*-macos-arm64.dmg
          retention-days: 7  # ä¿ç•™ 7 å¤©

      - name: Upload DMG for Gitee syncï¼ˆä¸Šä¼  DMG ä¾› Gitee åŒæ­¥ä½¿ç”¨ï¼‰
        if: github.event_name == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: release-dmg-arm64
          path: dist/*-macos-arm64.dmg
          retention-days: 1

  build-jar:
    name: Build Standalone JARï¼ˆæ„å»ºç‹¬ç«‹ JAR åŒ…ï¼‰
    runs-on: ubuntu-latest
    needs: [get-version, build-jar-artifact]

    steps:
      - name: Download JAR artifactï¼ˆä¸‹è½½å·²æ„å»ºçš„ JARï¼‰
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: dist

      - name: Upload to Releaseï¼ˆä¸Šä¼ åˆ° GitHub Releaseï¼‰
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.jar
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload as Artifactï¼ˆæ‰‹åŠ¨è§¦å‘æ—¶ä¸Šä¼ ä¸ºæ„å»ºäº§ç‰©ï¼‰
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: EasyPostman-Standalone-JAR
          path: dist/*.jar
          retention-days: 7


  build-ubuntu:
    name: Build Ubuntu DEBï¼ˆæ„å»º Ubuntu å®‰è£…åŒ…ï¼‰
    runs-on: ubuntu-22.04
    needs: [get-version, build-jar-artifact]

    steps:
      - name: Checkoutï¼ˆæ£€å‡ºä»£ç ï¼‰
        uses: actions/checkout@v4

      - name: Setup Javaï¼ˆé…ç½® Javaï¼‰
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}

      - name: Download Fat JARï¼ˆä¸‹è½½è·¨å¹³å° Fat JARï¼‰
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: target

      - name: Install dependenciesï¼ˆå®‰è£…ç³»ç»Ÿä¾èµ–ï¼‰
        run: |
          sudo apt-get update
          # å®‰è£… GTK3ã€WebKit å’Œæ‰“åŒ…å·¥å…·
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev binutils

      - name: Create runtime with jlinkï¼ˆä½¿ç”¨ jlink åˆ›å»º Linux ç²¾ç®€ JREï¼‰
        run: |
          rm -rf target/runtime
          # åˆ›å»º Linux å¹³å°çš„ JRE
          jlink \
            --add-modules ${{ env.JLINK_MODULES }} \
            --strip-debug \
            --no-header-files \
            --no-man-pages \
            --compress=2 \
            --output target/runtime

      - name: Prepare dist-inputï¼ˆå‡†å¤‡æ‰“åŒ…è¾“å…¥ç›®å½•ï¼‰
        run: |
          VERSION="${{ needs.get-version.outputs.version }}"
          JAR_NAME="easy-postman-$VERSION.jar"
          
          rm -rf target/dist-input
          mkdir -p target/dist-input
          cp target/$JAR_NAME target/dist-input/

      - name: Create DEB with jpackageï¼ˆä½¿ç”¨ jpackage åˆ›å»º DEB å®‰è£…åŒ…ï¼‰
        run: |
          VERSION="${{ needs.get-version.outputs.version }}"
          JAR_NAME="easy-postman-$VERSION.jar"
          
          mkdir -p dist
          
          # è§£æ Java é€‰é¡¹
          IFS='|' read -ra JAVA_OPTS <<< "${{ env.JAVA_OPTIONS }}"
          
          # åˆ›å»º Ubuntu/Debian DEB å®‰è£…åŒ…
          jpackage \
            --input target/dist-input \
            --main-jar $JAR_NAME \
            --main-class com.laker.postman.App \
            --runtime-image target/runtime \
            --type deb \
            --name "EasyPostman" \
            --app-version "$VERSION" \
            --dest dist \
            --vendor "Laker" \
            --copyright "Â© 2025 Laker" \
            --description "A modern API testing tool similar to Postman" \
            --linux-shortcut \
            --linux-menu-group "Development" \
            --linux-app-category "Development" \
            --java-options "${JAVA_OPTS[0]}" \
            --java-options "${JAVA_OPTS[1]}" \
            --java-options "${JAVA_OPTS[2]}"

      - name: Upload to Releaseï¼ˆä¸Šä¼ åˆ° GitHub Releaseï¼‰
        if: github.event_name == 'release'  # åªåœ¨ Release è§¦å‘æ—¶ä¸Šä¼ 
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.deb
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload as Artifactï¼ˆæ‰‹åŠ¨è§¦å‘æ—¶ä¸Šä¼ ä¸ºæ„å»ºäº§ç‰©ï¼‰
        if: github.event_name == 'workflow_dispatch'  # åªåœ¨æ‰‹åŠ¨è§¦å‘æ—¶ä¸Šä¼ ä¸º Artifact
        uses: actions/upload-artifact@v4
        with:
          name: EasyPostman-Ubuntu-DEB
          path: dist/*.deb
          retention-days: 7  # ä¿ç•™ 7 å¤©

      - name: Upload DEB for Gitee syncï¼ˆä¸Šä¼  DEB ä¾› Gitee åŒæ­¥ä½¿ç”¨ï¼‰
        if: github.event_name == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: release-deb
          path: dist/*.deb
          retention-days: 1

  # åˆ›å»º Gitee Release
  create-gitee-release:
    name: Create Gitee Releaseï¼ˆåˆ›å»º Gitee Releaseï¼‰
    if: github.event_name == 'release'
    needs: [build-windows, build-macos-arm]  # åªç­‰å¾…éœ€è¦åŒæ­¥åˆ° Gitee çš„æ„å»ºï¼ˆWindows MSI + macOS ARMï¼‰
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.gitee_release.outputs.release_id }}
      tag_name: ${{ steps.get_version.outputs.tag }}

    steps:
      - name: Get version from tagï¼ˆä»æ ‡ç­¾è·å–ç‰ˆæœ¬å·ï¼‰
        id: get_version
        run: |
          TAG_NAME="${{ github.event.release.tag_name }}"
          VERSION="${TAG_NAME#v}"  # ç§»é™¤ v å‰ç¼€
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Create Gitee Releaseï¼ˆåˆ›å»º Gitee Releaseï¼‰
        id: gitee_release
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          TAG_NAME="${{ steps.get_version.outputs.tag }}"
          RELEASE_BODY="${{ github.event.release.body }}"
          
          if [ -z "$RELEASE_BODY" ]; then
            RELEASE_BODY="EasyPostman ${VERSION} å‘å¸ƒç‰ˆæœ¬ï¼Œæ”¯æŒ Windowsã€macOS å’Œ Linuxã€‚è¯¦æƒ…ï¼šhttps://github.com/lakernote/easy-postman"
          fi
          
          echo "Creating Gitee Release for tag: $TAG_NAME"
          
          curl -s -X POST \
            -F "access_token=${{ secrets.GITEE_TOKEN }}" \
            -F "tag_name=$TAG_NAME" \
            -F "name=$TAG_NAME" \
            -F "body=$RELEASE_BODY" \
            -F "prerelease=false" \
            -F "target_commitish=master" \
            "https://gitee.com/api/v5/repos/lakernote/easy-postman/releases" > /tmp/release.json
          
          echo "API Response:"
          cat /tmp/release.json
          
          # ä¼˜å…ˆä½¿ç”¨ jqï¼ˆGitHub Actions Ubuntu runner é¢„è£…ï¼‰
          RELEASE_ID=$(jq -r '.id // empty' /tmp/release.json 2>/dev/null || echo "")
          
          if [ -z "$RELEASE_ID" ]; then
            echo "jq extraction failed, trying python3..."
            RELEASE_ID=$(python3 -c "import sys, json; print(json.load(open('/tmp/release.json'))['id'])" 2>/dev/null || echo "")
          fi
          
          if [ -z "$RELEASE_ID" ]; then
            echo "python3 failed, trying grep..."
            RELEASE_ID=$(grep -o '"id":[0-9]*' /tmp/release.json | head -1 | grep -o '[0-9]*')
          fi
          
          if [ -z "$RELEASE_ID" ]; then
            echo "Error: Failed to create release or extract release ID"
            exit 1
          fi
          
          echo "release_id=$RELEASE_ID" >> $GITHUB_OUTPUT
          echo "Gitee Release created successfully with ID: $RELEASE_ID"

  # å¹¶è¡Œä¸Šä¼ åˆ° Giteeï¼ˆä½¿ç”¨ matrix ç­–ç•¥ï¼‰
  sync-to-gitee:
    name: Upload ${{ matrix.platform }} to Giteeï¼ˆä¸Šä¼  ${{ matrix.platform }} åˆ° Giteeï¼‰
    if: github.event_name == 'release'
    needs: [create-gitee-release]  # ç­‰å¾… Gitee Release åˆ›å»ºå®Œæˆ
    runs-on: ubuntu-latest
    strategy:
      # ä¸å› å•ä¸ªå¹³å°å¤±è´¥è€Œå–æ¶ˆå…¶ä»–ä¸Šä¼ ä»»åŠ¡
      fail-fast: false
      matrix:
        include:
          - platform: 'Windows MSI'
            priority: 1
            artifact_name: 'release-msi'
            file_pattern: '*.msi'
            emoji: 'ğŸªŸ'
          - platform: 'macOS Apple Silicon'
            priority: 2
            artifact_name: 'release-dmg-arm64'
            file_pattern: '*-macos-arm64.dmg'
            emoji: 'ğŸ'

    steps:
      - name: Download ${{ matrix.platform }} artifactï¼ˆä¸‹è½½ ${{ matrix.platform }} äº§ç‰©ï¼‰
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: artifacts

      - name: Upload ${{ matrix.platform }} to Giteeï¼ˆä¸Šä¼  ${{ matrix.platform }} åˆ° Giteeï¼‰
        run: |
          RELEASE_ID="${{ needs.create-gitee-release.outputs.release_id }}"
          FILE=$(find artifacts -name "${{ matrix.file_pattern }}" | head -n 1)
          
          if [ -z "$FILE" ]; then
            echo "âš ï¸ ${{ matrix.platform }} file not found, skipping..."
            exit 0
          fi
          
          echo "${{ matrix.emoji }} [Priority ${{ matrix.priority }}] Uploading $(basename $FILE) to Gitee..."
          
          # ä¸Šä¼ åˆ° Giteeï¼Œå¸¦é‡è¯•æœºåˆ¶
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -X POST "https://gitee.com/api/v5/repos/lakernote/easy-postman/releases/$RELEASE_ID/attach_files" \
              -F "access_token=${{ secrets.GITEE_TOKEN }}" \
              -F "file=@$FILE"; then
              echo "âœ… ${{ matrix.platform }} uploaded successfully!"
              exit 0
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "âš ï¸ Upload failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
                sleep 5
              fi
            fi
          done
          
          echo "âŒ Failed to upload ${{ matrix.platform }} after $MAX_RETRIES attempts"
          exit 1

  # æ±‡æ€»ç»“æœ
  sync-summary:
    name: Sync Summaryï¼ˆåŒæ­¥æ±‡æ€»ï¼‰
    if: github.event_name == 'release' && always()  # å³ä½¿æœ‰å¤±è´¥ä¹Ÿæ‰§è¡Œ
    needs: [create-gitee-release, sync-to-gitee]
    runs-on: ubuntu-latest

    steps:
      - name: Summaryï¼ˆæ±‡æ€»ï¼‰
        run: |
          echo "ğŸ“Š Gitee Release åŒæ­¥å®Œæˆï¼"
          echo "ğŸ“ Release URL: https://gitee.com/lakernote/easy-postman/releases/${{ needs.create-gitee-release.outputs.tag_name }}"
          echo ""
          echo "å·²åŒæ­¥åˆ° Gitee çš„å¹³å°ï¼š"
          echo "  ğŸªŸ Windows MSI"
          echo "  ğŸ macOS Apple Silicon (ARM64)"
          echo ""
          echo "ğŸ’¡ å…¶ä»–å¹³å°ï¼ˆWindows Portableã€macOS Intelã€Ubuntu DEBï¼‰ä»…åœ¨ GitHub Release æä¾›"
          echo ""
          if [ "${{ needs.sync-to-gitee.result }}" == "success" ]; then
            echo "âœ… æ‰€æœ‰é…ç½®å¹³å°å‡å·²æˆåŠŸä¸Šä¼ åˆ° Giteeï¼"
          else
            echo "âš ï¸ éƒ¨åˆ†å¹³å°ä¸Šä¼ å¯èƒ½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šæ–¹æ—¥å¿—"
          fi

