name: Release Buildï¼ˆå‘å¸ƒæ„å»ºï¼‰

permissions:
  contents: write

on:
  release:
    types: [created]  # å½“åˆ›å»ºæ–°çš„ Release æ—¶è§¦å‘
  workflow_dispatch: {}  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    name: Build Windows MSIï¼ˆæ„å»º Windows å®‰è£…åŒ…ï¼‰
    runs-on: windows-latest

    steps:
      - name: Checkoutï¼ˆæ£€å‡ºä»£ç ï¼‰
        uses: actions/checkout@v4

      - name: Setup Java 17 (Temurin)ï¼ˆé…ç½® Java 17 ç¯å¢ƒï¼‰
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Install WiX (for jpackage)ï¼ˆå®‰è£… WiX å·¥å…·é›†ï¼Œç”¨äºåˆ›å»º MSIï¼‰
        shell: pwsh
        run: |
          choco install wixtoolset -y
          if (Get-Command refreshenv -ErrorAction SilentlyContinue) { 
            refreshenv 
          } else {
            $refreshScript = "$env:ChocolateyInstall\lib\refreshenv\tools\RefreshEnv.ps1"
            if (Test-Path $refreshScript) { & $refreshScript }
          }

      - name: Get version from pom.xmlï¼ˆä» pom.xml æå–ç‰ˆæœ¬å·ï¼‰
        id: get_version
        shell: pwsh
        run: |
          [xml]$pom = Get-Content 'pom.xml'
          $version = $pom.project.version
          Write-Host "Version: $version"
          "version=$version" | Out-File -Encoding utf8 -FilePath $env:GITHUB_OUTPUT -Append

      - name: Build with Mavenï¼ˆä½¿ç”¨ Maven æ„å»ºé¡¹ç›®ï¼‰
        shell: pwsh
        run: |
          mvn -B clean package -DskipTests

      - name: Create runtime with jlinkï¼ˆä½¿ç”¨ jlink åˆ›å»ºç²¾ç®€çš„ JREï¼‰
        shell: pwsh
        run: |
          $runtimeDir = "target\runtime"
          if (Test-Path $runtimeDir) { Remove-Item -Recurse -Force $runtimeDir }
          
          # åˆ›å»ºåŒ…å«å¿…è¦æ¨¡å—çš„ç²¾ç®€è¿è¡Œæ—¶ç¯å¢ƒ
          jlink `
            --add-modules java.base,java.desktop,java.logging,jdk.unsupported,java.naming,java.net.http,java.prefs,java.sql,java.security.sasl,java.security.jgss,jdk.crypto.ec,java.management,java.management.rmi,jdk.crypto.cryptoki `
            --strip-debug `
            --no-header-files `
            --no-man-pages `
            --compress=2 `
            --output $runtimeDir

      - name: Prepare dist-inputï¼ˆå‡†å¤‡æ‰“åŒ…è¾“å…¥ç›®å½•ï¼‰
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          $jarName = "easy-postman-$version.jar"
          
          $distInputDir = "target\dist-input"
          if (Test-Path $distInputDir) { Remove-Item -Recurse -Force $distInputDir }
          New-Item -ItemType Directory -Path $distInputDir | Out-Null
          
          Copy-Item "target\$jarName" -Destination $distInputDir

      - name: Create MSI with jpackageï¼ˆä½¿ç”¨ jpackage åˆ›å»º MSI å®‰è£…åŒ…ï¼‰
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          $jarName = "easy-postman-$version.jar"
          $outDir = "dist"
          
          if (-not (Test-Path $outDir)) { New-Item -ItemType Directory -Path $outDir | Out-Null }
          
          # åˆ›å»º Windows MSI å®‰è£…åŒ…
          jpackage `
            --type msi `
            --input target\dist-input `
            --main-jar $jarName `
            --main-class com.laker.postman.App `
            --runtime-image target\runtime `
            --dest $outDir `
            --icon assets\win\EasyPostman.ico `
            --name EasyPostman `
            --app-version $version `
            --vendor "Laker" `
            --copyright "Â© 2025 Laker" `
            --win-shortcut `
            --win-menu `
            --description "A modern API testing tool similar to Postman" `
            --win-upgrade-uuid "28607609-97b7-4212-9285-04ef64a4946c" `
            --win-dir-chooser `
            --win-per-user-install `
            --win-menu-group "EasyTools" `
            --win-help-url "https://gitee.com/lakernote/easy-postman" `
            --java-options "-Xms256m" `
            --java-options "-Xmx512m" `
            --java-options "-Dfile.encoding=UTF-8" `
            --java-options "-Djavax.accessibility.assistive_technologies="

      - name: Upload to Releaseï¼ˆä¸Šä¼ åˆ° GitHub Releaseï¼‰
        if: github.event_name == 'release'  # åªåœ¨ Release è§¦å‘æ—¶ä¸Šä¼ 
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.msi
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload as Artifactï¼ˆæ‰‹åŠ¨è§¦å‘æ—¶ä¸Šä¼ ä¸ºæ„å»ºäº§ç‰©ï¼‰
        if: github.event_name == 'workflow_dispatch'  # åªåœ¨æ‰‹åŠ¨è§¦å‘æ—¶ä¸Šä¼ ä¸º Artifact
        uses: actions/upload-artifact@v4
        with:
          name: EasyPostman-Windows-MSI
          path: dist/*.msi
          retention-days: 7  # ä¿ç•™ 7 å¤©

      - name: Upload MSI for Gitee syncï¼ˆä¸Šä¼  MSI ä¾› Gitee åŒæ­¥ä½¿ç”¨ï¼‰
        if: github.event_name == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: release-msi
          path: dist/*.msi
          retention-days: 1


  build-windows-portable:
    name: Build Windows Portableï¼ˆæ„å»º Windows ç»¿è‰²ç‰ˆï¼‰
    runs-on: windows-latest

    steps:
      - name: Checkoutï¼ˆæ£€å‡ºä»£ç ï¼‰
        uses: actions/checkout@v4

      - name: Setup Java 17 (Temurin)ï¼ˆé…ç½® Java 17 ç¯å¢ƒï¼‰
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Get version from pom.xmlï¼ˆä» pom.xml æå–ç‰ˆæœ¬å·ï¼‰
        id: get_version
        shell: pwsh
        run: |
          [xml]$pom = Get-Content 'pom.xml'
          $version = $pom.project.version
          Write-Host "Version: $version"
          "version=$version" | Out-File -Encoding utf8 -FilePath $env:GITHUB_OUTPUT -Append

      - name: Build with Mavenï¼ˆä½¿ç”¨ Maven æ„å»ºé¡¹ç›®ï¼‰
        shell: pwsh
        run: |
          mvn -B clean package -DskipTests

      - name: Create runtime with jlinkï¼ˆä½¿ç”¨ jlink åˆ›å»ºç²¾ç®€çš„ JREï¼‰
        shell: pwsh
        run: |
          $runtimeDir = "target\runtime"
          if (Test-Path $runtimeDir) { Remove-Item -Recurse -Force $runtimeDir }
          
          jlink `
            --add-modules java.base,java.desktop,java.logging,jdk.unsupported,java.naming,java.net.http,java.prefs,java.sql,java.security.sasl,java.security.jgss,jdk.crypto.ec,java.management,java.management.rmi,jdk.crypto.cryptoki `
            --strip-debug `
            --no-header-files `
            --no-man-pages `
            --compress=2 `
            --output $runtimeDir

      - name: Prepare dist-inputï¼ˆå‡†å¤‡æ‰“åŒ…è¾“å…¥ç›®å½•ï¼‰
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          $jarName = "easy-postman-$version.jar"
          
          $distInputDir = "target\dist-input"
          if (Test-Path $distInputDir) { Remove-Item -Recurse -Force $distInputDir }
          New-Item -ItemType Directory -Path $distInputDir | Out-Null
          
          Copy-Item "target\$jarName" -Destination $distInputDir

      - name: Create app-image with jpackageï¼ˆåˆ›å»ºåº”ç”¨é•œåƒï¼Œå…å®‰è£…ï¼‰
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          $jarName = "easy-postman-$version.jar"
          $appImageDir = "target\app-image"
          
          if (Test-Path $appImageDir) { Remove-Item -Recurse -Force $appImageDir }
          
          # åˆ›å»ºåº”ç”¨é•œåƒï¼ˆapp-image ç±»å‹ï¼Œä¸æ˜¯å®‰è£…åŒ…ï¼‰
          jpackage `
            --type app-image `
            --input target\dist-input `
            --main-jar $jarName `
            --main-class com.laker.postman.App `
            --runtime-image target\runtime `
            --dest target `
            --icon assets\win\EasyPostman.ico `
            --name EasyPostman `
            --app-version $version `
            --vendor "Laker" `
            --copyright "Â© 2025 Laker" `
            --java-options "-Xms256m" `
            --java-options "-Xmx512m" `
            --java-options "-Dfile.encoding=UTF-8" `
            --java-options "-Djavax.accessibility.assistive_technologies="

      - name: Package portable versionï¼ˆæ‰“åŒ…ç»¿è‰²ç‰ˆä¸º ZIPï¼‰
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          $appImageDir = "target\EasyPostman"
          $zipName = "EasyPostman-$version-windows-portable.zip"
          
          if (-not (Test-Path "dist")) { New-Item -ItemType Directory -Path "dist" | Out-Null }
          
          # å‹ç¼©ä¸º ZIP
          Compress-Archive -Path $appImageDir -DestinationPath "dist\$zipName" -Force
          
          Write-Host "Created portable version: $zipName"

      - name: Upload to Releaseï¼ˆä¸Šä¼ åˆ° GitHub Releaseï¼‰
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*-portable.zip
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload as Artifactï¼ˆæ‰‹åŠ¨è§¦å‘æ—¶ä¸Šä¼ ä¸ºæ„å»ºäº§ç‰©ï¼‰
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: EasyPostman-Windows-Portable
          path: dist/*-portable.zip
          retention-days: 7

      - name: Upload Portable ZIP for Gitee syncï¼ˆä¸Šä¼ ä¾¿æºç‰ˆ ZIP ä¾› Gitee åŒæ­¥ä½¿ç”¨ï¼‰
        if: github.event_name == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: release-portable-zip
          path: dist/*-portable.zip
          retention-days: 1

  build-macos-intel:
    name: Build macOS Intel DMGï¼ˆæ„å»º macOS Intel ç‰ˆå®‰è£…åŒ…ï¼‰
    runs-on: macos-13  # Intel x86_64

    steps:
      - name: Checkoutï¼ˆæ£€å‡ºä»£ç ï¼‰
        uses: actions/checkout@v4

      - name: Setup Java 17 (Temurin)ï¼ˆé…ç½® Java 17 ç¯å¢ƒï¼‰
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Get version from pom.xmlï¼ˆä» pom.xml æå–ç‰ˆæœ¬å·ï¼‰
        id: get_version
        run: |
          VERSION=$(grep -m 1 '<version>' pom.xml | sed 's/.*<version>\(.*\)<\/version>.*/\1/')
          echo "Version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build with Mavenï¼ˆä½¿ç”¨ Maven æ„å»ºé¡¹ç›®ï¼‰
        run: |
          mvn -B clean package -DskipTests

      - name: Create runtime with jlinkï¼ˆä½¿ç”¨ jlink åˆ›å»ºç²¾ç®€çš„ JREï¼‰
        run: |
          rm -rf target/runtime
          # åˆ›å»ºåŒ…å«å¿…è¦æ¨¡å—çš„ç²¾ç®€è¿è¡Œæ—¶ç¯å¢ƒ
          jlink \
            --add-modules java.base,java.desktop,java.logging,jdk.unsupported,java.naming,java.net.http,java.prefs,java.sql,java.security.sasl,java.security.jgss,jdk.crypto.ec,java.management,java.management.rmi,jdk.crypto.cryptoki \
            --strip-debug \
            --no-header-files \
            --no-man-pages \
            --compress=2 \
            --output target/runtime

      - name: Prepare dist-inputï¼ˆå‡†å¤‡æ‰“åŒ…è¾“å…¥ç›®å½•ï¼‰
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          JAR_NAME="easy-postman-$VERSION.jar"
          
          rm -rf target/dist-input
          mkdir -p target/dist-input
          cp target/$JAR_NAME target/dist-input/

      - name: Create DMG with jpackageï¼ˆä½¿ç”¨ jpackage åˆ›å»º DMG é•œåƒï¼‰
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          JAR_NAME="easy-postman-$VERSION.jar"
          
          mkdir -p dist
          
          # åˆ›å»º macOS Intel DMG
          jpackage \
            --input target/dist-input \
            --main-jar $JAR_NAME \
            --main-class com.laker.postman.App \
            --runtime-image target/runtime \
            --type dmg \
            --name "EasyPostman" \
            --app-version "$VERSION" \
            --dest dist \
            --icon assets/mac/EasyPostman.icns \
            --vendor "Laker" \
            --copyright "Â© 2025 Laker" \
            --java-options "-Xms256m" \
            --java-options "-Xmx512m" \
            --java-options "-Dfile.encoding=UTF-8"
          
          # é‡å‘½åä¸º Intel ç‰ˆæœ¬
          mv dist/EasyPostman-$VERSION.dmg dist/EasyPostman-$VERSION-intel.dmg

      - name: Upload to Releaseï¼ˆä¸Šä¼ åˆ° GitHub Releaseï¼‰
        if: github.event_name == 'release'  # åªåœ¨ Release è§¦å‘æ—¶ä¸Šä¼ 
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*-intel.dmg
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload as Artifactï¼ˆæ‰‹åŠ¨è§¦å‘æ—¶ä¸Šä¼ ä¸ºæ„å»ºäº§ç‰©ï¼‰
        if: github.event_name == 'workflow_dispatch'  # åªåœ¨æ‰‹åŠ¨è§¦å‘æ—¶ä¸Šä¼ ä¸º Artifact
        uses: actions/upload-artifact@v4
        with:
          name: EasyPostman-macOS-Intel-DMG
          path: dist/*-intel.dmg
          retention-days: 7  # ä¿ç•™ 7 å¤©

      - name: Upload DMG for Gitee syncï¼ˆä¸Šä¼  DMG ä¾› Gitee åŒæ­¥ä½¿ç”¨ï¼‰
        if: github.event_name == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: release-dmg-intel
          path: dist/*-intel.dmg
          retention-days: 1

  build-macos-arm:
    name: Build macOS Apple Silicon DMGï¼ˆæ„å»º macOS Apple Silicon ç‰ˆå®‰è£…åŒ…ï¼‰
    runs-on: macos-latest  # Apple Silicon (M1/M2/M3/M4)

    steps:
      - name: Checkoutï¼ˆæ£€å‡ºä»£ç ï¼‰
        uses: actions/checkout@v4

      - name: Setup Java 17 (Temurin)ï¼ˆé…ç½® Java 17 ç¯å¢ƒï¼‰
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Get version from pom.xmlï¼ˆä» pom.xml æå–ç‰ˆæœ¬å·ï¼‰
        id: get_version
        run: |
          VERSION=$(grep -m 1 '<version>' pom.xml | sed 's/.*<version>\(.*\)<\/version>.*/\1/')
          echo "Version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build with Mavenï¼ˆä½¿ç”¨ Maven æ„å»ºé¡¹ç›®ï¼‰
        run: |
          mvn -B clean package -DskipTests

      - name: Create runtime with jlinkï¼ˆä½¿ç”¨ jlink åˆ›å»ºç²¾ç®€çš„ JREï¼‰
        run: |
          rm -rf target/runtime
          # åˆ›å»ºåŒ…å«å¿…è¦æ¨¡å—çš„ç²¾ç®€è¿è¡Œæ—¶ç¯å¢ƒ
          jlink \
            --add-modules java.base,java.desktop,java.logging,jdk.unsupported,java.naming,java.net.http,java.prefs,java.sql,java.security.sasl,java.security.jgss,jdk.crypto.ec,java.management,java.management.rmi,jdk.crypto.cryptoki \
            --strip-debug \
            --no-header-files \
            --no-man-pages \
            --compress=2 \
            --output target/runtime

      - name: Prepare dist-inputï¼ˆå‡†å¤‡æ‰“åŒ…è¾“å…¥ç›®å½•ï¼‰
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          JAR_NAME="easy-postman-$VERSION.jar"
          
          rm -rf target/dist-input
          mkdir -p target/dist-input
          cp target/$JAR_NAME target/dist-input/

      - name: Create DMG with jpackageï¼ˆä½¿ç”¨ jpackage åˆ›å»º DMG é•œåƒï¼‰
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          JAR_NAME="easy-postman-$VERSION.jar"
          
          mkdir -p dist
          
          # åˆ›å»º macOS Apple Silicon DMG
          jpackage \
            --input target/dist-input \
            --main-jar $JAR_NAME \
            --main-class com.laker.postman.App \
            --runtime-image target/runtime \
            --type dmg \
            --name "EasyPostman" \
            --app-version "$VERSION" \
            --dest dist \
            --icon assets/mac/EasyPostman.icns \
            --vendor "Laker" \
            --copyright "Â© 2025 Laker" \
            --java-options "-Xms256m" \
            --java-options "-Xmx512m" \
            --java-options "-Dfile.encoding=UTF-8"
          
          # é‡å‘½åä¸º ARM ç‰ˆæœ¬
          mv dist/EasyPostman-$VERSION.dmg dist/EasyPostman-$VERSION-arm64.dmg

      - name: Upload to Releaseï¼ˆä¸Šä¼ åˆ° GitHub Releaseï¼‰
        if: github.event_name == 'release'  # åªåœ¨ Release è§¦å‘æ—¶ä¸Šä¼ 
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*-arm64.dmg
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload as Artifactï¼ˆæ‰‹åŠ¨è§¦å‘æ—¶ä¸Šä¼ ä¸ºæ„å»ºäº§ç‰©ï¼‰
        if: github.event_name == 'workflow_dispatch'  # åªåœ¨æ‰‹åŠ¨è§¦å‘æ—¶ä¸Šä¼ ä¸º Artifact
        uses: actions/upload-artifact@v4
        with:
          name: EasyPostman-macOS-ARM-DMG
          path: dist/*-arm64.dmg
          retention-days: 7  # ä¿ç•™ 7 å¤©

      - name: Upload DMG for Gitee syncï¼ˆä¸Šä¼  DMG ä¾› Gitee åŒæ­¥ä½¿ç”¨ï¼‰
        if: github.event_name == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: release-dmg-arm64
          path: dist/*-arm64.dmg
          retention-days: 1

  build-jar:
    name: Build Standalone JARï¼ˆæ„å»ºç‹¬ç«‹ JAR åŒ…ï¼‰
    runs-on: ubuntu-22.04

    steps:
      - name: Checkoutï¼ˆæ£€å‡ºä»£ç ï¼‰
        uses: actions/checkout@v4

      - name: Setup Java 17 (Temurin)ï¼ˆé…ç½® Java 17 ç¯å¢ƒï¼‰
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Get version from pom.xmlï¼ˆä» pom.xml æå–ç‰ˆæœ¬å·ï¼‰
        id: get_version
        run: |
          VERSION=$(grep -m 1 '<version>' pom.xml | sed 's/.*<version>\(.*\)<\/version>.*/\1/')
          echo "Version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build with Mavenï¼ˆä½¿ç”¨ Maven æ„å»ºé¡¹ç›®ï¼‰
        run: |
          mvn -B clean package -DskipTests

      - name: Prepare standalone JARï¼ˆå‡†å¤‡ç‹¬ç«‹ JAR åŒ…ï¼‰
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          mkdir -p dist
          cp target/easy-postman-$VERSION.jar dist/

      - name: Upload to Releaseï¼ˆä¸Šä¼ åˆ° GitHub Releaseï¼‰
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.jar
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload as Artifactï¼ˆæ‰‹åŠ¨è§¦å‘æ—¶ä¸Šä¼ ä¸ºæ„å»ºäº§ç‰©ï¼‰
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: EasyPostman-Standalone-JAR
          path: dist/*.jar
          retention-days: 7


  build-ubuntu:
    name: Build Ubuntu DEBï¼ˆæ„å»º Ubuntu å®‰è£…åŒ…ï¼‰
    runs-on: ubuntu-22.04

    steps:
      - name: Checkoutï¼ˆæ£€å‡ºä»£ç ï¼‰
        uses: actions/checkout@v4

      - name: Setup Java 17 (Temurin)ï¼ˆé…ç½® Java 17 ç¯å¢ƒï¼‰
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Install dependenciesï¼ˆå®‰è£…ç³»ç»Ÿä¾èµ–ï¼‰
        run: |
          sudo apt-get update
          # å®‰è£… GTK3ã€WebKit å’Œæ‰“åŒ…å·¥å…·
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev binutils

      - name: Get version from pom.xmlï¼ˆä» pom.xml æå–ç‰ˆæœ¬å·ï¼‰
        id: get_version
        run: |
          VERSION=$(grep -m 1 '<version>' pom.xml | sed 's/.*<version>\(.*\)<\/version>.*/\1/')
          echo "Version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build with Mavenï¼ˆä½¿ç”¨ Maven æ„å»ºé¡¹ç›®ï¼‰
        run: |
          mvn -B clean package -DskipTests

      - name: Create runtime with jlinkï¼ˆä½¿ç”¨ jlink åˆ›å»ºç²¾ç®€çš„ JREï¼‰
        run: |
          rm -rf target/runtime
          # åˆ›å»ºåŒ…å«å¿…è¦æ¨¡å—çš„ç²¾ç®€è¿è¡Œæ—¶ç¯å¢ƒ
          jlink \
            --add-modules java.base,java.desktop,java.logging,jdk.unsupported,java.naming,java.net.http,java.prefs,java.sql,java.security.sasl,java.security.jgss,jdk.crypto.ec,java.management,java.management.rmi,jdk.crypto.cryptoki \
            --strip-debug \
            --no-header-files \
            --no-man-pages \
            --compress=2 \
            --output target/runtime

      - name: Prepare dist-inputï¼ˆå‡†å¤‡æ‰“åŒ…è¾“å…¥ç›®å½•ï¼‰
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          JAR_NAME="easy-postman-$VERSION.jar"
          
          rm -rf target/dist-input
          mkdir -p target/dist-input
          cp target/$JAR_NAME target/dist-input/

      - name: Create DEB with jpackageï¼ˆä½¿ç”¨ jpackage åˆ›å»º DEB å®‰è£…åŒ…ï¼‰
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          JAR_NAME="easy-postman-$VERSION.jar"
          
          mkdir -p dist
          
          # åˆ›å»º Ubuntu/Debian DEB å®‰è£…åŒ…
          jpackage \
            --input target/dist-input \
            --main-jar $JAR_NAME \
            --main-class com.laker.postman.App \
            --runtime-image target/runtime \
            --type deb \
            --name "EasyPostman" \
            --app-version "$VERSION" \
            --dest dist \
            --vendor "Laker" \
            --copyright "Â© 2025 Laker" \
            --description "A modern API testing tool similar to Postman" \
            --linux-shortcut \
            --linux-menu-group "Development" \
            --linux-app-category "Development" \
            --java-options "-Xms256m" \
            --java-options "-Xmx512m" \
            --java-options "-Dfile.encoding=UTF-8"

      - name: Upload to Releaseï¼ˆä¸Šä¼ åˆ° GitHub Releaseï¼‰
        if: github.event_name == 'release'  # åªåœ¨ Release è§¦å‘æ—¶ä¸Šä¼ 
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.deb
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload as Artifactï¼ˆæ‰‹åŠ¨è§¦å‘æ—¶ä¸Šä¼ ä¸ºæ„å»ºäº§ç‰©ï¼‰
        if: github.event_name == 'workflow_dispatch'  # åªåœ¨æ‰‹åŠ¨è§¦å‘æ—¶ä¸Šä¼ ä¸º Artifact
        uses: actions/upload-artifact@v4
        with:
          name: EasyPostman-Ubuntu-DEB
          path: dist/*.deb
          retention-days: 7  # ä¿ç•™ 7 å¤©

      - name: Upload DEB for Gitee syncï¼ˆä¸Šä¼  DEB ä¾› Gitee åŒæ­¥ä½¿ç”¨ï¼‰
        if: github.event_name == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: release-deb
          path: dist/*.deb
          retention-days: 1

  sync-to-gitee:
    name: Sync to Gitee Releaseï¼ˆåŒæ­¥åˆ° Gitee Releaseï¼‰
    if: github.event_name == 'release'
    needs: [build-windows, build-windows-portable, build-macos-intel, build-macos-arm, build-ubuntu]  # ç­‰å¾…æ‰€æœ‰æ„å»ºå®Œæˆ
    runs-on: ubuntu-latest

    steps:
      - name: Download all release artifactsï¼ˆä¸‹è½½æ‰€æœ‰å‘å¸ƒäº§ç‰©ï¼‰
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get version from tagï¼ˆä»æ ‡ç­¾è·å–ç‰ˆæœ¬å·ï¼‰
        id: get_version
        run: |
          TAG_NAME="${{ github.event.release.tag_name }}"
          VERSION="${TAG_NAME#v}"  # ç§»é™¤ v å‰ç¼€
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Create Gitee Releaseï¼ˆåˆ›å»º Gitee Releaseï¼‰
        id: gitee_release
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          TAG_NAME="${{ steps.get_version.outputs.tag }}"
          RELEASE_BODY="${{ github.event.release.body }}"
          
          if [ -z "$RELEASE_BODY" ]; then
            RELEASE_BODY="EasyPostman ${VERSION} å‘å¸ƒç‰ˆæœ¬ï¼Œæ”¯æŒ Windowsã€macOS å’Œ Linuxã€‚è¯¦æƒ…ï¼šhttps://github.com/lakernote/easy-postman"
          fi
          
          echo "Creating Gitee Release for tag: $TAG_NAME"
          
          curl -s -X POST \
            -F "access_token=${{ secrets.GITEE_TOKEN }}" \
            -F "tag_name=$TAG_NAME" \
            -F "name=$TAG_NAME" \
            -F "body=$RELEASE_BODY" \
            -F "prerelease=false" \
            -F "target_commitish=master" \
            "https://gitee.com/api/v5/repos/lakernote/easy-postman/releases" > /tmp/release.json
          
          echo "API Response:"
          cat /tmp/release.json
          
          # ä¼˜å…ˆä½¿ç”¨ jqï¼ˆGitHub Actions Ubuntu runner é¢„è£…ï¼‰
          RELEASE_ID=$(jq -r '.id // empty' /tmp/release.json 2>/dev/null || echo "")
          
          if [ -z "$RELEASE_ID" ]; then
            echo "jq extraction failed, trying python3..."
            RELEASE_ID=$(python3 -c "import sys, json; print(json.load(open('/tmp/release.json'))['id'])" 2>/dev/null || echo "")
          fi
          
          if [ -z "$RELEASE_ID" ]; then
            echo "python3 failed, trying grep..."
            RELEASE_ID=$(grep -o '"id":[0-9]*' /tmp/release.json | head -1 | grep -o '[0-9]*')
          fi
          
          if [ -z "$RELEASE_ID" ]; then
            echo "Error: Failed to create release or extract release ID"
            exit 1
          fi
          
          echo "release_id=$RELEASE_ID" >> $GITHUB_OUTPUT
          echo "Gitee Release created successfully with ID: $RELEASE_ID"

      - name: Upload MSI to Giteeï¼ˆä¸Šä¼  MSI åˆ° Giteeï¼‰
        run: |
          RELEASE_ID="${{ steps.gitee_release.outputs.release_id }}"
          MSI_FILE=$(find artifacts/release-msi -name "*.msi" | head -n 1)
          
          if [ -z "$MSI_FILE" ]; then
            echo "âš ï¸ MSI file not found, skipping..."
            exit 0
          fi
          
          echo "ğŸ“¦ Uploading $(basename $MSI_FILE) to Gitee..."
          
          curl -X POST "https://gitee.com/api/v5/repos/lakernote/easy-postman/releases/$RELEASE_ID/attach_files" \
            -F "access_token=${{ secrets.GITEE_TOKEN }}" \
            -F "file=@$MSI_FILE"
          
          echo "âœ… MSI uploaded successfully!"

      - name: Upload Windows Portable ZIP to Giteeï¼ˆä¸Šä¼  Windows ä¾¿æºç‰ˆ ZIP åˆ° Giteeï¼‰
        run: |
          RELEASE_ID="${{ steps.gitee_release.outputs.release_id }}"
          ZIP_FILE=$(find artifacts/release-portable-zip -name "*-portable.zip" | head -n 1)
          
          if [ -z "$ZIP_FILE" ]; then
            echo "âš ï¸ Portable ZIP file not found, skipping..."
            exit 0
          fi
          
          echo "ğŸ“¦ Uploading $(basename $ZIP_FILE) to Gitee..."
          
          curl -X POST "https://gitee.com/api/v5/repos/lakernote/easy-postman/releases/$RELEASE_ID/attach_files" \
            -F "access_token=${{ secrets.GITEE_TOKEN }}" \
            -F "file=@$ZIP_FILE"
          
          echo "âœ… Windows Portable ZIP uploaded successfully!"

      - name: Upload Intel DMG to Giteeï¼ˆä¸Šä¼  Intel DMG åˆ° Giteeï¼‰
        run: |
          RELEASE_ID="${{ steps.gitee_release.outputs.release_id }}"
          DMG_FILE=$(find artifacts/release-dmg-intel -name "*-intel.dmg" | head -n 1)
          
          if [ -z "$DMG_FILE" ]; then
            echo "âš ï¸ Intel DMG file not found, skipping..."
            exit 0
          fi
          
          echo "ğŸ“¦ Uploading $(basename $DMG_FILE) to Gitee..."
          
          curl -X POST "https://gitee.com/api/v5/repos/lakernote/easy-postman/releases/$RELEASE_ID/attach_files" \
            -F "access_token=${{ secrets.GITEE_TOKEN }}" \
            -F "file=@$DMG_FILE"
          
          echo "âœ… Intel DMG uploaded successfully!"

      - name: Upload ARM DMG to Giteeï¼ˆä¸Šä¼  ARM DMG åˆ° Giteeï¼‰
        run: |
          RELEASE_ID="${{ steps.gitee_release.outputs.release_id }}"
          DMG_FILE=$(find artifacts/release-dmg-arm64 -name "*-arm64.dmg" | head -n 1)
          
          if [ -z "$DMG_FILE" ]; then
            echo "âš ï¸ ARM DMG file not found, skipping..."
            exit 0
          fi
          
          echo "ğŸ“¦ Uploading $(basename $DMG_FILE) to Gitee..."
          
          curl -X POST "https://gitee.com/api/v5/repos/lakernote/easy-postman/releases/$RELEASE_ID/attach_files" \
            -F "access_token=${{ secrets.GITEE_TOKEN }}" \
            -F "file=@$DMG_FILE"
          
          echo "âœ… ARM DMG uploaded successfully!"

      - name: Upload DEB to Giteeï¼ˆä¸Šä¼  DEB åˆ° Giteeï¼‰
        run: |
          RELEASE_ID="${{ steps.gitee_release.outputs.release_id }}"
          DEB_FILE=$(find artifacts/release-deb -name "*.deb" | head -n 1)
          
          if [ -z "$DEB_FILE" ]; then
            echo "âš ï¸ DEB file not found, skipping..."
            exit 0
          fi
          
          echo "ğŸ“¦ Uploading $(basename $DEB_FILE) to Gitee..."
          
          curl -X POST "https://gitee.com/api/v5/repos/lakernote/easy-postman/releases/$RELEASE_ID/attach_files" \
            -F "access_token=${{ secrets.GITEE_TOKEN }}" \
            -F "file=@$DEB_FILE"
          
          echo "âœ… DEB uploaded successfully!"

      - name: Summaryï¼ˆæ±‡æ€»ï¼‰
        run: |
          echo "ğŸ‰ All packages have been synced to Gitee Release!"
          echo "ğŸ“ Release URL: https://gitee.com/lakernote/easy-postman/releases/${{ steps.get_version.outputs.tag }}"

