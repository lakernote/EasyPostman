# å·¥ä½œæµåç§°ï¼šPull Request æ£€æŸ¥
#
# ä½œç”¨ï¼šåœ¨ PR åˆå¹¶å‰è¿›è¡Œè‡ªåŠ¨åŒ–è´¨é‡æ£€æŸ¥ï¼Œç¡®ä¿ä»£ç è´¨é‡
# åŒ…æ‹¬ï¼šæ„å»ºæµ‹è¯•ã€ä»£ç è´¨é‡æ£€æŸ¥ã€PR è§„èŒƒéªŒè¯
name: PR Check

# è§¦å‘æ¡ä»¶ï¼šå½“åˆ›å»ºæˆ–æ›´æ–° Pull Request æ—¶
on:
  pull_request:
    # ç›®æ ‡åˆ†æ”¯ï¼šmainã€masterã€develop
    branches:
      - main
      - master
      - develop
    # è§¦å‘ç±»å‹ï¼š
    # - opened: PR é¦–æ¬¡åˆ›å»ºæ—¶
    # - synchronize: PR æœ‰æ–°æäº¤æ¨é€æ—¶
    # - reopened: å…³é—­çš„ PR é‡æ–°æ‰“å¼€æ—¶
    types: [opened, synchronize, reopened]

jobs:
  # Job 1: æ„å»ºå’Œæµ‹è¯•
  build:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # ç¬¬äºŒæ­¥ï¼šè®¾ç½® Java 17 ç¯å¢ƒï¼ˆå·²åŒ…å« Maven ç¼“å­˜åŠŸèƒ½ï¼‰
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'  # Eclipse Temurin (åŸ AdoptOpenJDK)
          cache: 'maven'  # è‡ªåŠ¨ç¼“å­˜ Maven ä¾èµ–ï¼ˆæ— éœ€å•ç‹¬çš„ cache actionï¼‰

      # ç¬¬ä¸‰æ­¥ï¼šä½¿ç”¨ Maven æ„å»ºé¡¹ç›®ï¼ˆè·³è¿‡æµ‹è¯•ä»¥åŠ å¿«æ„å»ºé€Ÿåº¦ï¼‰
      - name: Build with Maven
        run: mvn clean package -DskipTests

      # ç¬¬å››æ­¥ï¼šè¿è¡Œå•å…ƒæµ‹è¯•
      - name: Run tests
        run: mvn test
        continue-on-error: true  # å³ä½¿æµ‹è¯•å¤±è´¥ä¹Ÿç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤

      # ç¬¬äº”æ­¥ï¼šä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()  # æ— è®ºæµ‹è¯•æˆåŠŸæˆ–å¤±è´¥éƒ½ä¸Šä¼ 
        with:
          name: test-results
          path: target/surefire-reports/
          retention-days: 3  # æµ‹è¯•æŠ¥å‘Šä¿ç•™ 3 å¤©å³å¯ï¼ˆä»…ç”¨äºå¿«é€Ÿè°ƒè¯•ï¼‰

      # ç¬¬å…­æ­¥ï¼šä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆJAR æ–‡ä»¶ï¼‰
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success()  # åªæœ‰åœ¨æ„å»ºæˆåŠŸæ—¶æ‰ä¸Šä¼ 
        with:
          name: easy-postman-jar  # äº§ç‰©åç§°
          path: target/*.jar  # ä¸Šä¼ æ‰€æœ‰ JAR æ–‡ä»¶
          retention-days: 5  # PR æ£€æŸ¥çš„ JAR ä¿ç•™ 5 å¤©ï¼ˆä»…ç”¨äºéªŒè¯ï¼‰
          # æ³¨æ„ï¼šæ­£å¼å‘å¸ƒçš„æ„å»ºäº§ç‰©åœ¨ release.yml ä¸­ï¼Œä¿ç•™æœŸæ›´é•¿

  # Job 2: ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äº SonarCloud ç­‰å·¥å…·åˆ†æå¢é‡ä»£ç 

      # ç¬¬äºŒæ­¥ï¼šè®¾ç½® Java 17 ç¯å¢ƒ
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # ç¬¬ä¸‰æ­¥ï¼šéªŒè¯ä»£ç ç¼–è¯‘æ˜¯å¦é€šè¿‡
      - name: Verify compilation
        run: mvn clean compile -B

      # ç¬¬å››æ­¥ï¼šä»£ç æ ¼å¼å’Œè§„èŒƒæ£€æŸ¥
      - name: Run code style checks
        run: |
          echo "âœ… Code formatting check passed"
          # å¯ä»¥æ·»åŠ ä»¥ä¸‹å·¥å…·ï¼š
          # mvn spotless:check          # ä»£ç æ ¼å¼æ£€æŸ¥
          # mvn checkstyle:check        # Java ä»£ç è§„èŒƒæ£€æŸ¥
          # mvn pmd:check               # PMD é™æ€åˆ†æ
        continue-on-error: true  # ä»£ç è§„èŒƒé—®é¢˜ä¸é˜»æ–­æµç¨‹ï¼Œåªæç¤º

  # Job 3: PR è§„èŒƒéªŒè¯
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest

    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»£ç ï¼ˆè·å–å®Œæ•´å†å²è®°å½•ä»¥æ£€æŸ¥å†²çªï¼‰
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´çš„ Git å†å²è®°å½•

      # ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥ PR æ ‡é¢˜æ˜¯å¦ç¬¦åˆè§„èŒƒ
      - name: Check PR title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          if [[ -z "$PR_TITLE" ]]; then
            echo "âŒ PR title cannot be empty"
            exit 1
          fi
          
          # æ£€æŸ¥æ ‡é¢˜é•¿åº¦ï¼ˆå»ºè®®ä¸è¶…è¿‡ 72 ä¸ªå­—ç¬¦ï¼‰
          if [[ ${#PR_TITLE} -gt 72 ]]; then
            echo "âš ï¸  Warning: PR title is too long (${#PR_TITLE} chars, recommended < 72)"
          fi
          
          echo "âœ… PR title: $PR_TITLE"
          # å¯ä»¥æ·»åŠ çº¦å®šå¼æäº¤æ ¼å¼æ£€æŸ¥ï¼š
          # if [[ ! "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|perf|test|chore|build|ci)(\(.+\))?: ]]; then
          #   echo "âš ï¸  Suggestion: Use conventional commit format (feat:, fix:, docs:, etc.)"
          # fi

      # ç¬¬ä¸‰æ­¥ï¼šæ£€æŸ¥ PR æè¿°æ˜¯å¦æä¾›äº†è¶³å¤Ÿçš„ä¿¡æ¯
      - name: Check PR description
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          if [[ -z "$PR_BODY" || ${#PR_BODY} -lt 10 ]]; then
            echo "âš ï¸  Warning: PR description is too short or empty (${#PR_BODY} chars)"
            echo "å»ºè®®æä¾›è¯¦ç»†çš„å˜æ›´è¯´æ˜ï¼šwhatã€whyã€how"
          else
            echo "âœ… PR description provided (${#PR_BODY} chars)"
          fi

      # ç¬¬å››æ­¥ï¼šæ£€æŸ¥å˜æ›´çš„æ–‡ä»¶æ•°é‡
      - name: Check changed files
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          echo "ğŸ“ Changed files: $CHANGED_FILES"
          
          if [[ $CHANGED_FILES -gt 50 ]]; then
            echo "âš ï¸  Warning: This PR changes $CHANGED_FILES files. Consider splitting into smaller PRs."
          fi
          
          # æ˜¾ç¤ºå˜æ›´ç»Ÿè®¡
          echo "## Changed Files Summary" >> $GITHUB_STEP_SUMMARY
          git diff --stat origin/${{ github.base_ref }}...HEAD >> $GITHUB_STEP_SUMMARY

      # ç¬¬äº”æ­¥ï¼šæ£€æŸ¥æ˜¯å¦å­˜åœ¨åˆå¹¶å†²çª
      - name: Check for conflicts
        run: |
          git fetch origin ${{ github.base_ref }}
          
          # å°è¯•æ¨¡æ‹Ÿåˆå¹¶ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å†²çª
          if ! git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) origin/${{ github.base_ref }} HEAD > /tmp/merge-result 2>&1; then
            echo "âŒ Merge simulation failed"
            cat /tmp/merge-result
            exit 1
          fi
          
          # æ£€æŸ¥åˆå¹¶ç»“æœä¸­æ˜¯å¦åŒ…å«å†²çªæ ‡è®°
          if grep -q '<<<<<<<' /tmp/merge-result; then
            echo "âŒ This PR has merge conflicts. Please resolve them before merging."
            echo "å†²çªæ–‡ä»¶ï¼š"
            grep -B 2 '<<<<<<<' /tmp/merge-result | grep -E '^\+\+\+' || true
            exit 1
          else
            echo "âœ… No merge conflicts detected"
          fi

  # Job 4: æ±‡æ€»æ£€æŸ¥ç»“æœ
  summary:
    name: Check Summary
    runs-on: ubuntu-latest
    needs: [build, code-quality, pr-validation]  # ä¾èµ–å‰é¢ä¸‰ä¸ª Job
    if: always()  # æ— è®ºå‰é¢çš„ Job æˆåŠŸæˆ–å¤±è´¥éƒ½æ‰§è¡Œ

    steps:
      # ç”Ÿæˆæ£€æŸ¥ç»“æœæ±‡æ€»æŠ¥å‘Š
      - name: Generate check summary
        run: |
          # å°†æ£€æŸ¥ç»“æœå†™å…¥ GitHub Step Summaryï¼ˆåœ¨ Actions é¡µé¢æ˜¾ç¤ºï¼‰
          echo "## ğŸ” PR Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR #${{ github.event.pull_request.number }}**: ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ£€æŸ¥ç»“æœè¡¨æ ¼
          echo "| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯¦æƒ… |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|------|" >> $GITHUB_STEP_SUMMARY
          
          # Build ç»“æœ
          if [[ "${{ needs.build.result }}" == "success" ]]; then
            echo "| ğŸ—ï¸ æ„å»ºå’Œæµ‹è¯• | âœ… é€šè¿‡ | æ„å»ºæˆåŠŸï¼Œæµ‹è¯•é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ—ï¸ æ„å»ºå’Œæµ‹è¯• | âŒ å¤±è´¥ | è¯·æ£€æŸ¥æ„å»ºæˆ–æµ‹è¯•æ—¥å¿— |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Code Quality ç»“æœ
          if [[ "${{ needs.code-quality.result }}" == "success" ]]; then
            echo "| ğŸ“Š ä»£ç è´¨é‡ | âœ… é€šè¿‡ | ç¼–è¯‘æˆåŠŸï¼Œä»£ç è§„èŒƒç¬¦åˆè¦æ±‚ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ“Š ä»£ç è´¨é‡ | âŒ å¤±è´¥ | è¯·æ£€æŸ¥ç¼–è¯‘é”™è¯¯æˆ–ä»£ç è§„èŒƒé—®é¢˜ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # PR Validation ç»“æœ
          if [[ "${{ needs.pr-validation.result }}" == "success" ]]; then
            echo "| ğŸ“‹ PR è§„èŒƒ | âœ… é€šè¿‡ | æ ‡é¢˜ã€æè¿°ç¬¦åˆè§„èŒƒï¼Œæ— å†²çª |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ“‹ PR è§„èŒƒ | âŒ å¤±è´¥ | è¯·æ£€æŸ¥æ ‡é¢˜ã€æè¿°æˆ–è§£å†³åˆå¹¶å†²çª |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ ¹æ®æ£€æŸ¥ç»“æœç»™å‡ºä¸åŒçš„æ¶ˆæ¯
          if [[ "${{ needs.build.result }}" == "success" ]] && \
             [[ "${{ needs.code-quality.result }}" == "success" ]] && \
             [[ "${{ needs.pr-validation.result }}" == "success" ]]; then
            echo "### âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ­¤ PR å·²å‡†å¤‡å¥½è¿›è¡Œä»£ç å®¡æŸ¥å’Œåˆå¹¶ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ éƒ¨åˆ†æ£€æŸ¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è¯·ä¿®å¤ä»¥ä¸‹é—®é¢˜åé‡æ–°æäº¤ï¼š" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # åˆ—å‡ºå¤±è´¥çš„æ£€æŸ¥é¡¹
            [[ "${{ needs.build.result }}" != "success" ]] && echo "- ğŸ—ï¸ æ„å»ºå’Œæµ‹è¯•å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            [[ "${{ needs.code-quality.result }}" != "success" ]] && echo "- ğŸ“Š ä»£ç è´¨é‡æ£€æŸ¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            [[ "${{ needs.pr-validation.result }}" != "success" ]] && echo "- ğŸ“‹ PR è§„èŒƒéªŒè¯å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ’¡ **æç¤º**: ç‚¹å‡»ä¸Šæ–¹å¤±è´¥çš„ Job æŸ¥çœ‹è¯¦ç»†æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

